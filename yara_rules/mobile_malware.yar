/*
    Mobile Malware Detection (Android/iOS)
    Detection of mobile banking trojans, spyware, and malicious APKs
*/

rule Mobile_Android_Generic_Malware {
    meta:
        description = "Generic Android malware indicators"
        severity = "high"
    strings:
        $dex = { 64 65 78 0A 30 33 }  // dex\n03
        $perm1 = "android.permission.SEND_SMS" ascii
        $perm2 = "android.permission.RECEIVE_SMS" ascii
        $perm3 = "android.permission.READ_SMS" ascii
        $perm4 = "android.permission.RECORD_AUDIO" ascii
        $perm5 = "android.permission.READ_CONTACTS" ascii
        $perm6 = "android.permission.ACCESS_FINE_LOCATION" ascii
        $perm7 = "android.permission.CAMERA" ascii
        $perm8 = "android.permission.READ_CALL_LOG" ascii
        $root = "su" ascii
        $device = "DEVICE_ADMIN" ascii
    condition:
        $dex at 0 and (4 of ($perm*) or ($root and $device))
}

rule Mobile_Android_BankBot {
    meta:
        description = "Android BankBot family"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "bankbot" ascii nocase
        $s2 = "overlay" ascii nocase
        $s3 = "injects" ascii nocase
        $acc = "AccessibilityService" ascii
        $key = "getRunningTasks" ascii
        $inject = "showWindow" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($acc and $key and $inject))
}

rule Mobile_Android_Anubis {
    meta:
        description = "Anubis Android banker"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "Anubis" ascii
        $s2 = "grabber" ascii nocase
        $s3 = "keylogger" ascii nocase
        $c2 = "http" ascii
        $json = "JSON" ascii
        $sms = "SmsReceiver" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($c2 and $json and $sms))
}

rule Mobile_Android_Cerberus {
    meta:
        description = "Cerberus Android banker"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "cerberus" ascii nocase
        $s2 = "alien" ascii nocase
        $overlay = "TYPE_APPLICATION_OVERLAY" ascii
        $acc = "AccessibilityService" ascii
        $keylog = "dispatchKeyEvent" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($overlay and $acc and $keylog))
}

rule Mobile_Android_FluBot {
    meta:
        description = "FluBot Android malware"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "flubot" ascii nocase
        $s2 = "FedEx" ascii
        $s3 = "DHL" ascii
        $sms = "RECEIVE_SMS" ascii
        $contacts = "READ_CONTACTS" ascii
        $overlay = "SYSTEM_ALERT_WINDOW" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($sms and $contacts and $overlay))
}

rule Mobile_Android_Joker {
    meta:
        description = "Joker Android malware"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "joker" ascii nocase
        $s2 = "premium" ascii nocase
        $s3 = "subscribe" ascii nocase
        $sms = "sendTextMessage" ascii
        $billing = "billing" ascii nocase
        $wap = "WAP" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($sms and $billing) or ($sms and $wap))
}

rule Mobile_Android_SOVA {
    meta:
        description = "SOVA Android banker"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "SOVA" ascii
        $s2 = "protect" ascii nocase
        $vpn = "VpnService" ascii
        $cookie = "WebView" ascii
        // UNUSED: $2fa = "authenticator" ascii nocase
    condition:
        $dex at 0 and (any of ($s*) or ($vpn and $cookie))
}

rule Mobile_Android_Hydra {
    meta:
        description = "Hydra Android banker"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "hydra" ascii nocase
        $team = "TeamViewer" ascii
        $vnc = "VNC" ascii
        $rat = "remoteDesktop" ascii nocase
        $screen = "MediaProjection" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($team or $vnc or $rat or $screen))
}

rule Mobile_Android_SharkBot {
    meta:
        description = "SharkBot Android banker"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $s1 = "sharkbot" ascii nocase
        $s2 = "ATS" ascii
        $auto = "performAction" ascii
        $acc = "AccessibilityNodeInfo" ascii
        $click = "ACTION_CLICK" ascii
    condition:
        $dex at 0 and (any of ($s*) or ($auto and $acc and $click))
}

rule Mobile_Android_Spyware {
    meta:
        description = "Generic Android spyware"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $spy1 = "getCallLog" ascii
        $spy2 = "getContacts" ascii
        $spy3 = "getMessages" ascii
        $spy4 = "getLocation" ascii
        $spy5 = "recordAudio" ascii
        $spy6 = "takePhoto" ascii
        $spy7 = "getInstalledApps" ascii
        $upload = "upload" ascii nocase
    condition:
        $dex at 0 and (4 of ($spy*) and $upload)
}

rule Mobile_Android_RAT {
    meta:
        description = "Android Remote Access Trojan"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $rat1 = "AhMyth" ascii nocase
        $rat2 = "SpyNote" ascii nocase
        $rat3 = "AndroRAT" ascii nocase
        $rat4 = "DroidJack" ascii nocase
        $cmd = "executeCommand" ascii
        $shell = "Runtime.getRuntime" ascii
        $socket = "Socket" ascii
    condition:
        $dex at 0 and (any of ($rat*) or ($cmd and $shell and $socket))
}

rule Mobile_Android_Ransomware {
    meta:
        description = "Android ransomware"
        severity = "critical"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $ransom1 = "ransom" ascii nocase
        $ransom2 = "encrypt" ascii nocase
        $ransom3 = "bitcoin" ascii nocase
        $lock = "DevicePolicyManager" ascii
        $admin = "DEVICE_ADMIN" ascii
        $screen = "lockNow" ascii
        $pin = "resetPassword" ascii
    condition:
        $dex at 0 and (any of ($ransom*) or ($lock and $admin and ($screen or $pin)))
}

rule Mobile_Android_Dropper {
    meta:
        description = "Android dropper/loader"
        severity = "high"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $drop1 = "DexClassLoader" ascii
        $drop2 = "PathClassLoader" ascii
        $drop3 = "InMemoryDexClassLoader" ascii
        $file = "openFileOutput" ascii
        $exec = "loadClass" ascii
        $dl = "URLConnection" ascii
    condition:
        $dex at 0 and (any of ($drop*) and ($file or $dl) and $exec)
}

rule Mobile_Android_Clicker {
    meta:
        description = "Android ad clicker/fraud"
        severity = "medium"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $webview = "WebView" ascii
        $js = "setJavaScriptEnabled" ascii
        $click = "simulateClick" ascii nocase
        $ad = "admob" ascii nocase
        $hidden = "INVISIBLE" ascii
    condition:
        $dex at 0 and ($webview and $js and (any of ($click, $ad, $hidden)))
}

rule Mobile_Android_Crypto_Miner {
    meta:
        description = "Android cryptocurrency miner"
        severity = "high"
    strings:
        $dex = { 64 65 78 0A 30 33 }
        $mine1 = "coinhive" ascii nocase
        $mine2 = "cryptonight" ascii nocase
        $mine3 = "stratum" ascii nocase
        $mine4 = "monero" ascii nocase
        $pool = "pool" ascii nocase
        $hash = "hashrate" ascii nocase
    condition:
        $dex at 0 and (any of ($mine*) or ($pool and $hash))
}

rule Mobile_iOS_Malware_Generic {
    meta:
        description = "Generic iOS malware indicators"
        severity = "high"
    strings:
        $mach = { CF FA ED FE }  // Mach-O magic
        $priv1 = "com.apple.private" ascii
        $priv2 = "entitlements" ascii
        $jb1 = "/Applications/Cydia.app" ascii
        $jb2 = "/Library/MobileSubstrate" ascii
        $jb3 = "/bin/bash" ascii
        $hook = "MSHookFunction" ascii
    condition:
        $mach at 0 and (2 of ($priv*) or 2 of ($jb*) or $hook)
}

rule Mobile_iOS_Spyware {
    meta:
        description = "iOS spyware indicators"
        severity = "critical"
    strings:
        $mach = { CF FA ED FE }
        $spy1 = "Pegasus" ascii
        $spy2 = "FinSpy" ascii
        $spy3 = "FlexiSpy" ascii
        $record = "AVAudioRecorder" ascii
        $location = "CLLocationManager" ascii
        $contact = "ABAddressBook" ascii
        $keychain = "SecItemCopyMatching" ascii
    condition:
        $mach at 0 and (any of ($spy*) or 3 of ($record, $location, $contact, $keychain))
}
