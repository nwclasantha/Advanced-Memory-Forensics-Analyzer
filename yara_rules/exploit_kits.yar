/*
    Exploit Kit Detection Rules
    Browser exploits, drive-by downloads, and exploit frameworks
*/

rule ExploitKit_Generic {
    meta:
        description = "Generic exploit kit indicators"
        severity = "critical"
    strings:
        $landing = "landing" ascii nocase
        $gate = "gate" ascii nocase
        $payload = "payload" ascii nocase
        $obfusc1 = "eval(" ascii
        $obfusc2 = "unescape(" ascii
        $obfusc3 = "document.write" ascii
        $shell = "shellcode" ascii nocase
    condition:
        (2 of ($landing, $gate, $payload)) and (any of ($obfusc*) or $shell)
}

rule ExploitKit_RIG {
    meta:
        description = "RIG Exploit Kit"
        severity = "critical"
    strings:
        $rig1 = "RIG" ascii
        $rig2 = "Empire Pack" ascii nocase
        $pattern1 = /\?[a-z]{3,5}=[a-f0-9]{32}/ ascii
        $ie = "MSIE" ascii
        $flash = "flash" ascii nocase
        $redirect = "window.location" ascii
    condition:
        (any of ($rig*) and $redirect) or ($pattern1 and any of ($ie, $flash))
}

rule ExploitKit_Magnitude {
    meta:
        description = "Magnitude Exploit Kit"
        severity = "critical"
    strings:
        $mag1 = "Magnitude" ascii nocase
        $popup = "popunder" ascii nocase
        $ransom = "ransom" ascii nocase
        $cerber = "cerber" ascii nocase
        $magnigate = "magnigate" ascii nocase
    condition:
        any of them
}

rule ExploitKit_Fallout {
    meta:
        description = "Fallout Exploit Kit"
        severity = "critical"
    strings:
        $fallout = "Fallout" ascii nocase
        $ie_exp = "CVE-2018" ascii
        $flash_exp = "CVE-2018-4878" ascii
        $vbs = "vbscript" ascii nocase
        $powershell = "powershell" ascii nocase
    condition:
        ($fallout and any of ($ie_exp, $flash_exp)) or ($vbs and $powershell)
}

rule ExploitKit_Spelevo {
    meta:
        description = "Spelevo Exploit Kit"
        severity = "critical"
    strings:
        $spelevo = "Spelevo" ascii nocase
        // UNUSED: $flash = "Flash" ascii nocase
        // UNUSED: $ie = "Internet Explorer" ascii nocase
        $cve1 = "CVE-2018-8174" ascii
        $cve2 = "CVE-2018-15982" ascii
    condition:
        $spelevo or (any of ($cve*))
}

rule ExploitKit_Purple_Fox {
    meta:
        description = "Purple Fox Exploit Kit"
        severity = "critical"
    strings:
        $purple = "PurpleFox" ascii nocase
        $rootkit = "rootkit" ascii nocase
        $msi = ".msi" ascii
        $powershell = "powershell" ascii nocase
        $worm = "worm" ascii nocase
    condition:
        ($purple and any of ($rootkit, $msi, $powershell)) or ($msi and $powershell and $worm)
}

rule ExploitKit_Underminer {
    meta:
        description = "Underminer Exploit Kit"
        severity = "critical"
    strings:
        $underminer = "Underminer" ascii nocase
        $bootkit = "bootkit" ascii nocase
        $hidden = "Hidden Bee" ascii nocase
        // UNUSED: $flash = "flash" ascii nocase
        // UNUSED: $ie = "ie" ascii nocase
    condition:
        any of ($underminer, $bootkit, $hidden)
}

rule ExploitKit_Angler {
    meta:
        description = "Angler Exploit Kit"
        severity = "critical"
    strings:
        $angler = "Angler" ascii nocase
        $bedep = "Bedep" ascii nocase
        $fileless = "fileless" ascii nocase
        $domain_gen = /[a-z]{8,12}\.(com|net|org|info)/ ascii
        $flash = "flash" ascii nocase
    condition:
        any of ($angler, $bedep, $fileless) or ($domain_gen and $flash)
}

rule ExploitKit_Nuclear {
    meta:
        description = "Nuclear Exploit Kit"
        severity = "critical"
    strings:
        $nuclear = "Nuclear" ascii nocase
        $pack = "Pack" ascii nocase
        $locky = "Locky" ascii nocase
        $teslacrypt = "TeslaCrypt" ascii nocase
        // UNUSED: $flash_exp = "flash" ascii nocase
    condition:
        ($nuclear and $pack) or any of ($locky, $teslacrypt)
}

rule ExploitKit_Neutrino {
    meta:
        description = "Neutrino Exploit Kit"
        severity = "critical"
    strings:
        $neutrino = "Neutrino" ascii nocase
        $androm = "Andromeda" ascii nocase
        // UNUSED: $zeus = "Zeus" ascii nocase
        $cryptowall = "CryptoWall" ascii nocase
    condition:
        $neutrino or any of ($androm, $cryptowall)
}

rule ExploitKit_Sweet_Orange {
    meta:
        description = "Sweet Orange Exploit Kit"
        severity = "critical"
    strings:
        $sweet = "Sweet Orange" ascii nocase
        $orange = "orange" ascii nocase
        $ie_exp = "IE" ascii
        $java_exp = "Java" ascii
        $flash_exp = "Flash" ascii
    condition:
        ($sweet and $orange) or (2 of ($ie_exp, $java_exp, $flash_exp))
}

rule ExploitKit_Blackhole {
    meta:
        description = "Blackhole Exploit Kit"
        severity = "critical"
    strings:
        $blackhole = "Blackhole" ascii nocase
        $bh = "BH" ascii
        $paunch = "Paunch" ascii
        $cool = "Cool" ascii nocase
        $java = "Java" ascii
    condition:
        any of ($blackhole, $bh, $paunch) or ($cool and $java)
}

rule ExploitKit_Fiesta {
    meta:
        description = "Fiesta Exploit Kit"
        severity = "critical"
    strings:
        $fiesta = "Fiesta" ascii nocase
        $neosploit = "NeoSploit" ascii nocase
        // UNUSED: $java = "java" ascii nocase
        // UNUSED: $pdf = "pdf" ascii nocase
        // UNUSED: $flash = "flash" ascii nocase
    condition:
        any of ($fiesta, $neosploit)
}

rule ExploitKit_Styx {
    meta:
        description = "Styx Exploit Kit"
        severity = "critical"
    strings:
        $styx = "Styx" ascii nocase
        // UNUSED: $java_exp = "Java" ascii
        // UNUSED: $pdf_exp = "PDF" ascii
        // UNUSED: $ie_exp = "IE" ascii
        $carberp = "Carberp" ascii nocase
    condition:
        $styx or $carberp
}

rule ExploitKit_Terror {
    meta:
        description = "Terror Exploit Kit"
        severity = "critical"
    strings:
        $terror = "Terror" ascii nocase
        $sundown = "Sundown" ascii nocase
        $flash = "flash" ascii nocase
        // UNUSED: $ie = "ie" ascii nocase
        $vbs = "vbscript" ascii nocase
    condition:
        any of ($terror, $sundown) or ($flash and $vbs)
}

rule Exploit_CVE_Generic_Recent {
    meta:
        description = "Recent CVE exploit indicators"
        severity = "critical"
    strings:
        $cve_2021 = /CVE-2021-\d{4,5}/ ascii
        $cve_2022 = /CVE-2022-\d{4,5}/ ascii
        $cve_2023 = /CVE-2023-\d{4,5}/ ascii
        $cve_2024 = /CVE-2024-\d{4,5}/ ascii
        $exploit = "exploit" ascii nocase
        $poc = "poc" ascii nocase
    condition:
        (any of ($cve*)) and (any of ($exploit, $poc))
}

rule Exploit_Flash_Generic {
    meta:
        description = "Generic Flash exploit"
        severity = "high"
    strings:
        $swf = { 46 57 53 }  // FWS (compressed)
        $swf2 = { 43 57 53 }  // CWS (uncompressed)
        $shellcode = { 90 90 90 90 }  // NOP sled
        $spray = "spray" ascii nocase
        $heap = "heap" ascii nocase
    condition:
        (any of ($swf*)) and (any of ($shellcode, $spray, $heap))
}

rule Exploit_Java_Generic {
    meta:
        description = "Generic Java exploit"
        severity = "high"
    strings:
        $java_magic = { CA FE BA BE }
        $classloader = "ClassLoader" ascii
        $runtime = "Runtime" ascii
        $exec = "exec" ascii
        // UNUSED: $reflect = "Reflection" ascii
    condition:
        $java_magic and ($classloader or $runtime) and $exec
}

rule Exploit_PDF_Generic {
    meta:
        description = "Generic PDF exploit"
        severity = "high"
    strings:
        $pdf = "%PDF" ascii
        $js = "/JavaScript" ascii
        $openaction = "/OpenAction" ascii
        $launch = "/Launch" ascii
        $embed = "/EmbeddedFile" ascii
        $aa = "/AA" ascii
    condition:
        $pdf and ($js or $openaction or $launch) and any of ($embed, $aa)
}

rule Exploit_Office_Generic {
    meta:
        description = "Generic Office exploit"
        severity = "high"
    strings:
        $ole = { D0 CF 11 E0 }  // OLE header
        $macro = "VBA" ascii
        $autoopen = "AutoOpen" ascii
        $auto_exec = "Auto_Open" ascii
        $document_open = "Document_Open" ascii
        $shell = "Shell" ascii
        $wscript = "WScript" ascii
    condition:
        $ole and ($macro or any of ($autoopen, $auto_exec, $document_open)) and any of ($shell, $wscript)
}

rule Exploit_RTF_Generic {
    meta:
        description = "Generic RTF exploit"
        severity = "high"
    strings:
        $rtf = "{\\rtf" ascii
        $objdata = "objdata" ascii nocase
        $equation = "equation" ascii nocase
        $ole = "OLE" ascii
        $cve_2017_11882 = { 02 CE 02 00 }  // Equation Editor
    condition:
        $rtf and ($objdata or $equation) and (any of ($ole, $cve_2017_11882))
}

rule Exploit_Browser_Generic {
    meta:
        description = "Generic browser exploit"
        severity = "critical"
    strings:
        $spray = "spray" ascii
        $heap = "heapSpray" ascii
        $shellcode = "shellcode" ascii
        $uaf = "use-after-free" ascii nocase
        $rop = "ROP" ascii
        $jit = "JIT" ascii
    condition:
        3 of them
}

rule Exploit_LNK_CVE {
    meta:
        description = "LNK file exploit"
        severity = "critical"
    strings:
        $lnk = { 4C 00 00 00 01 14 02 00 }  // LNK header
        $cmd = "cmd.exe" ascii nocase
        $powershell = "powershell" ascii nocase
        $mshta = "mshta" ascii nocase
        $cscript = "cscript" ascii nocase
    condition:
        $lnk and (any of ($cmd, $powershell, $mshta, $cscript))
}

rule Exploit_HTA_Dropper {
    meta:
        description = "HTA exploit dropper"
        severity = "critical"
    strings:
        $hta = "<HTA:APPLICATION" ascii nocase
        $script = "<script" ascii nocase
        $vbs = "vbscript" ascii nocase
        $js = "javascript" ascii nocase
        $shell = "WScript.Shell" ascii
        $exec = "exec" ascii nocase
    condition:
        $hta and ($script or any of ($vbs, $js)) and any of ($shell, $exec)
}

