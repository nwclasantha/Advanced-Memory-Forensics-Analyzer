/*
    Script-based Malware Detection
    JavaScript, VBScript, JScript, and other scripting language malware
*/

rule Script_JS_Obfuscated {
    meta:
        description = "Obfuscated JavaScript"
        severity = "high"
    strings:
        $eval = "eval(" ascii
        $fromcharcode = "fromCharCode" ascii
        $unescape = "unescape(" ascii
        $decode1 = "atob(" ascii
        $decode2 = "btoa(" ascii
        $string = "String" ascii
        $array = "Array" ascii
        $hex = /\\x[0-9a-fA-F]{2}/ ascii
    condition:
        (any of ($eval, $unescape)) and ($fromcharcode or any of ($decode1, $decode2)) and any of ($hex, $string, $array)
}

rule Script_JS_Shellcode_Loader {
    meta:
        description = "JavaScript shellcode loader"
        severity = "critical"
    strings:
        $shell = "shellcode" ascii nocase
        $wscript = "WScript" ascii
        $activex = "ActiveXObject" ascii
        $run = ".Run" ascii
        $exec = ".Exec" ascii
        $shell32 = "Shell32" ascii
        $heap = "heap" ascii nocase
    condition:
        ($shell and any of ($wscript, $activex)) or (($run or $exec) and any of ($shell32, $heap))
}

rule Script_VBS_Downloader {
    meta:
        description = "VBScript downloader"
        severity = "high"
    strings:
        $vbs = "VBScript" ascii nocase
        $http1 = "MSXML2.XMLHTTP" ascii
        $http2 = "WinHttp.WinHttpRequest" ascii
        $http3 = "Microsoft.XMLHTTP" ascii
        $write = "ADODB.Stream" ascii
        $shell = "WScript.Shell" ascii
        $run = ".Run" ascii
    condition:
        $vbs and (any of ($http*)) and ($write or ($shell and $run))
}

rule Script_VBS_Encoded {
    meta:
        description = "Encoded VBScript"
        severity = "high"
    strings:
        $vbe = ".vbe" ascii nocase
        $encode = "#@~^" ascii
        $chr = "Chr(" ascii
        $asc = "Asc(" ascii
        $execute = "Execute(" ascii
        $executeglobal = "ExecuteGlobal" ascii
    condition:
        $encode or ($vbe and any of ($chr, $asc, $execute, $executeglobal))
}

rule Script_JScript_Dropper {
    meta:
        description = "JScript dropper"
        severity = "high"
    strings:
        $js = ".js" ascii nocase
        $wsh = "WScript.Shell" ascii
        $fso = "Scripting.FileSystemObject" ascii
        $write = "Write" ascii
        $create = "CreateTextFile" ascii
        $run = "Run" ascii
        $http = "XMLHTTP" ascii
    condition:
        $js and ($wsh or $fso) and (any of ($write, $create)) and any of ($run, $http)
}

rule Script_HTA_Malicious {
    meta:
        description = "Malicious HTA file"
        severity = "critical"
    strings:
        $hta = "<HTA:APPLICATION" ascii nocase
        $script = "<script" ascii nocase
        $vbscript = "vbscript" ascii nocase
        $jscript = "jscript" ascii nocase
        $shell = "Shell" ascii
        $run = "Run(" ascii
        $exec = "Exec(" ascii
    condition:
        $hta and $script and (any of ($vbscript, $jscript)) and any of ($shell, $run, $exec)
}

rule Script_WSF_Malicious {
    meta:
        description = "Malicious WSF file"
        severity = "high"
    strings:
        $wsf = "<job" ascii nocase
        $script = "<script" ascii nocase
        $package = "<package>" ascii nocase
        $shell = "WScript.Shell" ascii
        $run = ".Run" ascii
        $http = "XMLHTTP" ascii
    condition:
        ($wsf or $package) and $script and any of ($shell, $run, $http)
}

rule Script_Batch_Malicious {
    meta:
        description = "Malicious batch script"
        severity = "high"
    strings:
        $batch = ".bat" ascii nocase
        // UNUSED: $cmd = ".cmd" ascii nocase
        $powershell = "powershell" ascii nocase
        $certutil = "certutil" ascii nocase
        $bitsadmin = "bitsadmin" ascii nocase
        $wget = "wget" ascii nocase
        $curl = "curl" ascii nocase
        $download = "download" ascii nocase
    condition:
        $batch and ((any of ($powershell, $certutil, $bitsadmin)) or ((any of ($wget, $curl)) and $download))
}

rule Script_PS1_Download_Execute {
    meta:
        description = "PowerShell download and execute"
        severity = "critical"
    strings:
        $ps = "powershell" ascii nocase
        $iex = "IEX" ascii
        $download1 = "DownloadString" ascii
        $download2 = "DownloadFile" ascii
        $download3 = "Invoke-WebRequest" ascii
        $webclient = "Net.WebClient" ascii
        $bypass = "-exec bypass" ascii nocase
    condition:
        $ps and ($iex or any of ($download*)) and any of ($webclient, $bypass)
}

rule Script_PS1_Encoded_Command {
    meta:
        description = "PowerShell encoded command"
        severity = "high"
    strings:
        $ps = "powershell" ascii nocase
        $enc1 = "-enc" ascii nocase
        $enc2 = "-encodedcommand" ascii nocase
        $enc3 = "-e " ascii nocase
        $base64 = /[A-Za-z0-9+\/]{50,}=*/ ascii
    condition:
        $ps and (any of ($enc*)) and $base64
}

rule Script_Python_Malicious {
    meta:
        description = "Malicious Python script"
        severity = "high"
    strings:
        $python = "python" ascii nocase
        $import1 = "import socket" ascii
        $import2 = "import subprocess" ascii
        $import3 = "import os" ascii
        $exec = "exec(" ascii
        $eval = "eval(" ascii
        $connect = "connect(" ascii
        $shell = "shell" ascii nocase
    condition:
        $python and (2 of ($import*)) and (any of ($exec, $eval, $connect, $shell))
}

rule Script_PHP_Webshell {
    meta:
        description = "PHP webshell"
        severity = "critical"
    strings:
        $php = "<?php" ascii nocase
        $eval = "eval(" ascii
        $exec = "exec(" ascii
        $system = "system(" ascii
        $shell = "shell_exec(" ascii
        $passthru = "passthru(" ascii
        $base64 = "base64_decode" ascii
        $post = "$_POST" ascii
        $get = "$_GET" ascii
        $request = "$_REQUEST" ascii
    condition:
        $php and (any of ($eval, $exec, $system, $shell, $passthru)) and (any of ($base64, $post, $get, $request))
}

rule Script_ASP_Webshell {
    meta:
        description = "ASP/ASPX webshell"
        severity = "critical"
    strings:
        $asp = "<%@" ascii nocase
        $aspx = "aspx" ascii nocase
        $cmd = "cmd.exe" ascii nocase
        $shell = "Shell" ascii
        $execute = "Execute" ascii
        $eval = "Eval" ascii
        $request = "Request" ascii
    condition:
        ($asp or $aspx) and (any of ($cmd, $shell, $execute, $eval)) and $request
}

rule Script_JSP_Webshell {
    meta:
        description = "JSP webshell"
        severity = "critical"
    strings:
        $jsp = "<%@" ascii
        // UNUSED: $page = "page " ascii
        $runtime = "Runtime.getRuntime" ascii
        $exec = "exec(" ascii
        $process = "ProcessBuilder" ascii
        $request = "request.getParameter" ascii
    condition:
        $jsp and ($runtime or $process) and ($exec and $request)
}

rule Script_Perl_Backdoor {
    meta:
        description = "Perl backdoor script"
        severity = "high"
    strings:
        $perl = "#!/usr/bin/perl" ascii
        $socket = "use Socket" ascii
        $io = "IO::Socket" ascii
        $exec = "exec(" ascii
        $system = "system(" ascii
        $fork = "fork(" ascii
        $cmd = "cmd" ascii nocase
    condition:
        $perl and (any of ($socket, $io)) and any of ($exec, $system, $fork, $cmd)
}

rule Script_Ruby_Backdoor {
    meta:
        description = "Ruby backdoor script"
        severity = "high"
    strings:
        $ruby = "#!/usr/bin/ruby" ascii
        $socket = "require 'socket'" ascii
        $tcp = "TCPSocket" ascii
        $exec = "exec(" ascii
        $system = "system(" ascii
        $spawn = "spawn(" ascii
    condition:
        $ruby and ($socket or $tcp) and any of ($exec, $system, $spawn)
}

rule Script_Lua_Malicious {
    meta:
        description = "Malicious Lua script"
        severity = "medium"
    strings:
        $lua = "lua" ascii nocase
        $loadstring = "loadstring" ascii
        $execute = "os.execute" ascii
        $popen = "io.popen" ascii
        $socket = "socket" ascii
        $http = "http" ascii nocase
    condition:
        $lua and ($loadstring or $execute or $popen) and any of ($socket, $http)
}

rule Script_Shell_Reverse {
    meta:
        description = "Shell reverse connection script"
        severity = "critical"
    strings:
        $bash = "#!/bin/bash" ascii
        $sh = "#!/bin/sh" ascii
        $nc = "nc " ascii
        $netcat = "netcat" ascii nocase
        $bash_i = "bash -i" ascii
        $dev_tcp = "/dev/tcp/" ascii
        $mkfifo = "mkfifo" ascii
    condition:
        (any of ($bash, $sh)) and (any of ($nc, $netcat, $bash_i, $dev_tcp, $mkfifo))
}

rule Script_AutoIt_Dropper {
    meta:
        description = "AutoIt malware dropper"
        severity = "high"
    strings:
        $autoit = "AutoIt" ascii
        $au3 = ".au3" ascii nocase
        $compile = "#AutoIt3Wrapper" ascii
        $shell = "ShellExecute" ascii
        $run = "Run(" ascii
        $file = "FileInstall" ascii
        $dll = "DllCall" ascii
    condition:
        ($autoit or $au3 or $compile) and any of ($shell, $run, $file, $dll)
}

