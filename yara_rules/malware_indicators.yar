/*
   Malware Indicators YARA Rules
   Generic patterns for detecting common malware behavior
*/

rule Malware_Indicators {
    meta:
        description = "Generic malware indicators"
        author = "Malware Analyzer Team"
        date = "2025-01-15"
        severity = "high"
        category = "malware"
    strings:
        $inject1 = "VirtualAllocEx" nocase
        $inject2 = "WriteProcessMemory" nocase
        $inject3 = "CreateRemoteThread" nocase
        $inject4 = "NtWriteVirtualMemory" nocase
        $persist1 = "CurrentVersion\\Run" nocase
        $persist2 = "CurrentVersion\\RunOnce" nocase
        $net1 = "URLDownloadToFile" nocase
        $net2 = "InternetOpen" nocase
        $anti1 = "IsDebuggerPresent" nocase
        $anti2 = "CheckRemoteDebuggerPresent" nocase
    condition:
        2 of ($inject*) or any of ($persist*) or
        (any of ($net*) and any of ($anti*))
}

rule Process_Injection {
    meta:
        description = "Detects process injection capabilities"
        severity = "high"
        category = "injection"
    strings:
        $api1 = "OpenProcess" nocase
        $api2 = "VirtualAllocEx" nocase
        $api3 = "WriteProcessMemory" nocase
        $api4 = "CreateRemoteThread" nocase
        $api5 = "NtCreateThreadEx" nocase
        $api6 = "RtlCreateUserThread" nocase
    condition:
        3 of them
}

rule Anti_Analysis {
    meta:
        description = "Anti-analysis and anti-debugging techniques"
        severity = "medium"
        category = "evasion"
    strings:
        $debug1 = "IsDebuggerPresent" nocase
        $debug2 = "CheckRemoteDebuggerPresent" nocase
        $debug3 = "NtQueryInformationProcess" nocase
        $debug4 = "OutputDebugString" nocase
        $vm1 = "VBOX" nocase
        $vm2 = "VMware" nocase
        $vm3 = "VirtualBox" nocase
        $timing1 = "GetTickCount" nocase
        $timing2 = "QueryPerformanceCounter" nocase
    condition:
        2 of ($debug*) or 2 of ($vm*) or
        (any of ($debug*) and any of ($timing*))
}

rule Persistence_Mechanism {
    meta:
        description = "Attempts to establish persistence"
        severity = "high"
        category = "persistence"
    strings:
        $reg1 = "CurrentVersion\\Run" nocase
        $reg2 = "CurrentVersion\\RunOnce" nocase
        $reg3 = "CurrentVersion\\RunServices" nocase
        $startup = "\\Start Menu\\Programs\\Startup" nocase
        $schtask = "schtasks" nocase
        $service1 = "CreateServiceA" nocase
        $service2 = "CreateServiceW" nocase
    condition:
        any of ($reg*) or $startup or $schtask or any of ($service*)
}

rule Network_Activity {
    meta:
        description = "Suspicious network activity"
        severity = "medium"
        category = "network"
    strings:
        $url1 = "URLDownloadToFileA" nocase
        $url2 = "URLDownloadToFileW" nocase
        $inet1 = "InternetOpenA" nocase
        $inet2 = "InternetOpenUrlA" nocase
        $inet3 = "InternetReadFile" nocase
        $sock1 = "WSAStartup" nocase
        $sock2 = "socket" nocase
        $sock3 = "connect" nocase
        $sock4 = "send" nocase
        $sock5 = "recv" nocase
    condition:
        2 of ($url*) or 2 of ($inet*) or 3 of ($sock*)
}
