/*
    APT and Nation-State Malware Detection Rules
    Covers: APT28, APT29, Lazarus, Equation Group, etc.
*/

rule APT28_XAgent {
    meta:
        description = "APT28/Fancy Bear XAgent implant"
        severity = "critical"
        author = "MalwareAnalyzer"
        reference = "APT28"
    strings:
        $s1 = "moduleExecutor" ascii
        $s2 = "keylogger" ascii
        $s3 = "filestealer" ascii
        $s4 = "remoteshell" ascii
        $s5 = "ProcessListCollector" ascii
        $pdb = "xagent" nocase
    condition:
        3 of them
}

rule APT28_Sofacy {
    meta:
        description = "APT28 Sofacy/Seduploader"
        severity = "critical"
    strings:
        $s1 = "seduploader" nocase
        $s2 = "sofacy" nocase
        $s3 = {8B 45 ?? 89 45 ?? 8B 4D ?? 03 4D ??}
        $cfg = {C7 45 ?? ?? ?? ?? ?? C7 45 ?? ?? ?? ?? ??}
    condition:
        any of ($s*) or all of ($cfg, $s3)
}

rule APT29_CozyDuke {
    meta:
        description = "APT29/Cozy Bear CozyDuke"
        severity = "critical"
    strings:
        $s1 = "cozy" nocase
        $s2 = "minidionis" nocase
        $s3 = "seaduke" nocase
        $s4 = "hammertoss" nocase
        $s5 = "ONIONDUKE" nocase
    condition:
        any of them
}

rule APT29_WellMess {
    meta:
        description = "APT29 WellMess malware"
        severity = "critical"
    strings:
        $s1 = "WellMess" ascii
        $s2 = "botlib" ascii
        $go1 = "main.main" ascii
        $go2 = "main.sendResult" ascii
        $go3 = "main.execCommand" ascii
    condition:
        any of ($s*) or 2 of ($go*)
}

rule Lazarus_Fallchill {
    meta:
        description = "Lazarus Group Fallchill RAT"
        severity = "critical"
    strings:
        $s1 = "fdsvc.dll" ascii
        $s2 = "fdphost.dll" ascii
        $s3 = {C7 45 ?? 5C 00 5C 00 C7 45 ?? 2E 00 5C 00}
        $magic = {4D 5A 90 00 03 00 00 00}
    condition:
        $magic at 0 and 2 of ($s*)
}

rule Lazarus_AppleJeus {
    meta:
        description = "Lazarus AppleJeus cryptocurrency stealer"
        severity = "critical"
    strings:
        $s1 = "CesarUpdater" ascii
        $s2 = "JMTTrading" ascii
        $s3 = "celastradepro" ascii
        $s4 = "unioncrypto" ascii
    condition:
        any of them
}

rule Equation_Group_Doublepulsar {
    meta:
        description = "Equation Group DoublePulsar backdoor"
        severity = "critical"
    strings:
        $s1 = "doublepulsar" nocase
        $s2 = {41 42 43 44 45 46 47 48 49 4A 4B 4C 4D 4E 4F 50}
        $smb = {FF 53 4D 42}
    condition:
        any of ($s*) or $smb
}

rule APT32_OceanLotus {
    meta:
        description = "APT32/OceanLotus malware"
        severity = "critical"
    strings:
        $s1 = "ESET-NOD32" ascii
        $s2 = {68 ?? ?? ?? ?? E8 ?? ?? ?? ?? 83 C4 04}
        $s3 = "mcoemcpy.exe" ascii
        $s4 = "rastlsc.exe" ascii
    condition:
        2 of them
}

rule APT41_Shadowpad {
    meta:
        description = "APT41 ShadowPad backdoor"
        severity = "critical"
    strings:
        $s1 = "ShadowPad" ascii
        $s2 = {C7 44 24 ?? ?? ?? ?? ?? C7 44 24 ?? ?? ?? ?? ??}
        $enc = {33 C0 8A 04 01 32 04 02 88 04 01}
    condition:
        any of them
}

rule Turla_Snake {
    meta:
        description = "Turla Snake/Uroburos rootkit"
        severity = "critical"
    strings:
        $s1 = "Ur0bUr()sGotyOu#" ascii
        $s2 = "snake" nocase
        $s3 = "uroburos" nocase
        $driver = {49 B8 ?? ?? ?? ?? ?? ?? ?? ?? 48 89}
    condition:
        any of them
}

rule Turla_Carbon {
    meta:
        description = "Turla Carbon backdoor"
        severity = "critical"
    strings:
        $s1 = "Carbon" ascii
        $s2 = "YOURPASSWORD" ascii
        $s3 = "taskmgr" ascii
        $cfg = {C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ??}
    condition:
        2 of ($s*) or ($cfg and any of ($s*))
}

rule Kimsuky_BabyShark {
    meta:
        description = "Kimsuky BabyShark malware"
        severity = "critical"
    strings:
        $s1 = "babyshark" nocase
        $s2 = "certutil -decode" ascii
        $s3 = "powershell.exe -ExecutionPolicy Bypass" ascii
        $vbs = "CreateObject" ascii
    condition:
        2 of them
}

rule MuddyWater_Powerstats {
    meta:
        description = "MuddyWater Powerstats"
        severity = "critical"
    strings:
        $ps1 = "IEX" ascii
        $ps2 = "DownloadString" ascii
        $ps3 = "Invoke-Expression" ascii
        $s4 = "muddywater" nocase
    condition:
        3 of ($ps*) or $s4
}

rule APT10_PlugX {
    meta:
        description = "APT10 PlugX/Korplug RAT"
        severity = "critical"
    strings:
        $s1 = "PlugX" ascii
        $s2 = "boot.ldr" ascii
        $s3 = "boot.cfg" ascii
        $mz = {4D 5A}
        $cfg = {50 4C 55 47}
    condition:
        $mz at 0 and (any of ($s*) or $cfg)
}

rule Winnti_Shadowpad_Variant {
    meta:
        description = "Winnti Group ShadowPad variant"
        severity = "critical"
    strings:
        $s1 = "Winnti" ascii
        $s2 = {C7 45 ?? 57 69 6E 6E C7 45 ?? 74 69 00 00}
        $enc = {8A 04 08 32 04 10 88 04 08 41}
    condition:
        any of them
}

rule Hafnium_Webshell {
    meta:
        description = "HAFNIUM web shells"
        severity = "critical"
    strings:
        $s1 = "<%@Page Language=" ascii
        $s2 = "Request.Form" ascii
        $s3 = "eval(" ascii
        $s4 = "System.Diagnostics.Process" ascii
    condition:
        $s1 and 2 of ($s2, $s3, $s4)
}

rule APT_Generic_Cobalt_Strike {
    meta:
        description = "Cobalt Strike beacon (commonly used by APTs)"
        severity = "critical"
    strings:
        $s1 = "beacon.dll" ascii
        $s2 = "%02d/%02d/%02d %02d:%02d:%02d" ascii
        $s3 = "ReflectiveLoader" ascii
        $s4 = "%s as %s\\%s: %d" ascii
        $cf1 = {69 68 69 68 69 6B}
    condition:
        2 of them
}

rule DarkHotel_Inexsmar {
    meta:
        description = "DarkHotel Inexsmar"
        severity = "critical"
    strings:
        $s1 = "darkhotel" nocase
        $s2 = "inexsmar" nocase
        $s3 = {8B 55 ?? 8B 45 ?? 8B 4D ?? 89 04 8A}
    condition:
        any of them
}

rule Sandworm_BlackEnergy {
    meta:
        description = "Sandworm BlackEnergy"
        severity = "critical"
    strings:
        $s1 = "BlackEnergy" ascii
        $s2 = "bServ" ascii
        $s3 = "bDoor" ascii
        $cfg = {C7 45 ?? ?? ?? ?? ?? C7 45 ?? ?? ?? ?? ??}
    condition:
        2 of ($s*) or ($cfg and any of ($s*))
}

rule Sandworm_Industroyer {
    meta:
        description = "Sandworm Industroyer/CrashOverride"
        severity = "critical"
    strings:
        $s1 = "haslo.dat" ascii
        $s2 = "iec104.dll" ascii
        $s3 = "61850.dll" ascii
        $s4 = "OPC" ascii
    condition:
        2 of them
}
