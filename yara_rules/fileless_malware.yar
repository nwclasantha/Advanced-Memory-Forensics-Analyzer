/*
    Fileless Malware Detection Rules
    Living-off-the-land, PowerShell, and memory-only attacks
*/

rule Fileless_PowerShell_Download {
    meta:
        description = "PowerShell download and execute"
        severity = "critical"
    strings:
        $ps1 = "powershell" ascii nocase
        $ps2 = "pwsh" ascii nocase
        $iex1 = "IEX" ascii
        $iex2 = "Invoke-Expression" ascii nocase
        $dl1 = "DownloadString" ascii
        $dl2 = "DownloadFile" ascii
        $dl3 = "Net.WebClient" ascii
        $dl4 = "Invoke-WebRequest" ascii nocase
    condition:
        (any of ($ps*)) and (any of ($iex*)) and (any of ($dl*))
}

rule Fileless_PowerShell_Encoded {
    meta:
        description = "Base64 encoded PowerShell"
        severity = "high"
    strings:
        $ps = "powershell" ascii nocase
        $enc1 = "-enc" ascii nocase
        $enc2 = "-encodedcommand" ascii nocase
        $enc3 = "-e " ascii nocase
        $bypass1 = "-ep bypass" ascii nocase
        $bypass2 = "-nop" ascii nocase
        $bypass3 = "-w hidden" ascii nocase
    condition:
        $ps and (any of ($enc*) or 2 of ($bypass*))
}

rule Fileless_WMI_Persistence {
    meta:
        description = "WMI event subscription persistence"
        severity = "high"
    strings:
        $wmi1 = "Win32_ProcessStartTrace" ascii
        $wmi2 = "__EventFilter" ascii
        $wmi3 = "__FilterToConsumerBinding" ascii
        $wmi4 = "CommandLineEventConsumer" ascii
        $wmi5 = "ActiveScriptEventConsumer" ascii
    condition:
        2 of them
}

rule Fileless_Registry_Payload {
    meta:
        description = "Registry-based payload storage"
        severity = "high"
    strings:
        $reg1 = "HKCU\\Software" ascii
        $reg2 = "HKLM\\Software" ascii
        $ps = "powershell" ascii nocase
        $b64 = /[A-Za-z0-9+\/]{100,}={0,2}/ ascii
    condition:
        (any of ($reg*)) and ($ps or $b64)
}

rule Fileless_Reflective_Injection {
    meta:
        description = "Reflective DLL/PE injection"
        severity = "critical"
    strings:
        $ref1 = "Invoke-ReflectivePEInjection" ascii
        $ref2 = "ReflectiveLoader" ascii
        $api1 = "VirtualAlloc" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
    condition:
        any of ($ref*) or (all of ($api*))
}

rule Fileless_MSHTA_Abuse {
    meta:
        description = "MSHTA abuse for code execution"
        severity = "high"
    strings:
        $mshta = "mshta" ascii nocase
        $vbs1 = "vbscript:" ascii nocase
        $vbs2 = "javascript:" ascii nocase
        $http = "http" ascii nocase
    condition:
        $mshta and (any of ($vbs*) or $http)
}

rule Fileless_Regsvr32_Bypass {
    meta:
        description = "Regsvr32 AppLocker bypass"
        severity = "high"
    strings:
        $reg = "regsvr32" ascii nocase
        $s1 = "/s" ascii
        $s2 = "/u" ascii
        $s3 = "/i:" ascii
        $http = "http" ascii nocase
        $script = "scrobj.dll" ascii nocase
    condition:
        $reg and (any of ($s*)) and ($http or $script)
}
