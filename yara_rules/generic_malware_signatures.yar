/*
    Generic Malware Signatures
    Common malware patterns and indicators
*/

rule Generic_Dropper {
    meta:
        description = "Generic dropper functionality"
        severity = "high"
    strings:
        $drop1 = "drop" ascii nocase
        $drop2 = "extract" ascii nocase
        $drop3 = "unpack" ascii nocase
        $write1 = "WriteFile" ascii
        $write2 = "CreateFile" ascii
        $temp = "\\Temp\\" ascii
        $appdata = "\\AppData\\" ascii
        $exec = "ShellExecute" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($drop*)) and (any of ($write*)) and (any of ($temp, $appdata, $exec))
}

rule Generic_Downloader {
    meta:
        description = "Generic downloader functionality"
        severity = "high"
    strings:
        $http1 = "InternetOpenUrl" ascii
        $http2 = "URLDownloadToFile" ascii
        $http3 = "HttpOpenRequest" ascii
        $http4 = "WinHttpOpen" ascii
        $url = "http" ascii nocase
        $write = "WriteFile" ascii
        $exec = "CreateProcess" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($http*)) and $url and (any of ($write, $exec))
}

rule Generic_Backdoor_Indicators {
    meta:
        description = "Generic backdoor indicators"
        severity = "critical"
    strings:
        $socket = "socket" ascii
        $connect = "connect" ascii
        $send = "send" ascii
        $recv = "recv" ascii
        $shell = "cmd.exe" ascii nocase
        $shell2 = "/bin/sh" ascii
        $bind = "bind" ascii
        $listen = "listen" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($socket, $connect, $send, $recv)) and (any of ($shell, $shell2) or ($bind and $listen))
}

rule Generic_C2_Communication {
    meta:
        description = "Generic C2 communication"
        severity = "critical"
    strings:
        $beacon = "beacon" ascii nocase
        $callback = "callback" ascii nocase
        $heartbeat = "heartbeat" ascii nocase
        $checkin = "checkin" ascii nocase
        $command = "command" ascii nocase
        $http = "HTTP" ascii
        $dns = "DNS" ascii
        $sleep = "sleep" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (2 of ($beacon, $callback, $heartbeat, $checkin, $command)) and (any of ($http, $dns, $sleep))
}

rule Generic_Anti_Analysis {
    meta:
        description = "Generic anti-analysis techniques"
        severity = "high"
    strings:
        $debug1 = "IsDebuggerPresent" ascii
        $debug2 = "CheckRemoteDebuggerPresent" ascii
        $debug3 = "NtQueryInformationProcess" ascii
        $vm1 = "VMware" ascii nocase
        $vm2 = "VirtualBox" ascii nocase
        $vm3 = "VBOX" ascii
        $vm4 = "Xen" ascii
        $sandbox = "Sandbox" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($debug*) or (2 of ($vm*)) or $sandbox)
}

rule Generic_Process_Injection {
    meta:
        description = "Generic process injection"
        severity = "critical"
    strings:
        $api1 = "VirtualAllocEx" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
        $api4 = "NtCreateThreadEx" ascii
        $api5 = "OpenProcess" ascii
        $api6 = "QueueUserAPC" ascii
    condition:
        uint16(0) == 0x5A4D and $api5 and $api1 and $api2 and (any of ($api3, $api4, $api6))
}

rule Generic_Persistence_Registry {
    meta:
        description = "Generic registry persistence"
        severity = "high"
    strings:
        $run1 = "\\CurrentVersion\\Run" ascii
        $run2 = "\\CurrentVersion\\RunOnce" ascii
        $run3 = "\\CurrentVersion\\RunServices" ascii
        $winlogon = "\\Winlogon" ascii
        $shell = "Shell" ascii
        $userinit = "Userinit" ascii
        $reg = "RegSetValue" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($run*) or ($winlogon and any of ($shell, $userinit))) and $reg
}

rule Generic_Persistence_Service {
    meta:
        description = "Generic service persistence"
        severity = "high"
    strings:
        $api1 = "CreateService" ascii
        $api2 = "OpenSCManager" ascii
        $api3 = "StartService" ascii
        $service = "SERVICE" ascii
        $auto = "AUTO_START" ascii
        $system = "SYSTEM" ascii
    condition:
        uint16(0) == 0x5A4D and (all of ($api*)) and (any of ($service, $auto, $system))
}

rule Generic_Persistence_Task {
    meta:
        description = "Generic scheduled task persistence"
        severity = "high"
    strings:
        $schtasks = "schtasks" ascii nocase
        $at = "at.exe" ascii nocase
        $task1 = "ITaskScheduler" ascii
        $task2 = "ITaskService" ascii
        $create = "/create" ascii nocase
        $run = "/run" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($schtasks, $at, $task1, $task2)) and (any of ($create, $run))
}

rule Generic_Keylogger_Indicators {
    meta:
        description = "Generic keylogger indicators"
        severity = "high"
    strings:
        $api1 = "GetAsyncKeyState" ascii
        $api2 = "GetKeyState" ascii
        $api3 = "SetWindowsHookEx" ascii
        $api4 = "GetKeyboardState" ascii
        $wh_keyboard = "WH_KEYBOARD" ascii
        $log = "log" ascii nocase
        $key = "key" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (2 of ($api*)) and (any of ($wh_keyboard, $log, $key))
}

rule Generic_Screenshot_Capture {
    meta:
        description = "Generic screenshot capture"
        severity = "medium"
    strings:
        $api1 = "GetDesktopWindow" ascii
        $api2 = "GetDC" ascii
        $api3 = "BitBlt" ascii
        $api4 = "CreateCompatibleBitmap" ascii
        $screen = "screen" ascii nocase
        $capture = "capture" ascii nocase
        $save = "Save" ascii
    condition:
        uint16(0) == 0x5A4D and (3 of ($api*)) and (any of ($screen, $capture, $save))
}

rule Generic_Password_Stealer {
    meta:
        description = "Generic password stealer"
        severity = "critical"
    strings:
        $chrome = "Chrome" ascii
        $firefox = "Firefox" ascii
        $edge = "Edge" ascii
        $login = "Login Data" ascii
        $password = "password" ascii nocase
        $credential = "credential" ascii nocase
        $dpapi = "CryptUnprotectData" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($chrome, $firefox, $edge, $login)) and (any of ($password, $credential, $dpapi))
}

rule Generic_Clipboard_Monitor {
    meta:
        description = "Generic clipboard monitor"
        severity = "medium"
    strings:
        $api1 = "GetClipboardData" ascii
        $api2 = "OpenClipboard" ascii
        $api3 = "SetClipboardViewer" ascii
        $api4 = "AddClipboardFormatListener" ascii
        // UNUSED: $monitor = "monitor" ascii nocase
        // UNUSED: $crypto = "crypto" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (2 of ($api*))
}

rule Generic_Data_Exfiltration {
    meta:
        description = "Generic data exfiltration"
        severity = "critical"
    strings:
        $ftp = "FTP" ascii
        $smtp = "SMTP" ascii
        $http = "HTTP" ascii
        $dns = "DNS" ascii
        $upload = "upload" ascii nocase
        $exfil = "exfil" ascii nocase
        $send = "send" ascii nocase
        $post = "POST" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($ftp, $smtp, $http, $dns)) and (any of ($upload, $exfil, $send, $post))
}

rule Generic_Self_Delete {
    meta:
        description = "Generic self-deletion"
        severity = "high"
    strings:
        $delete1 = "DeleteFile" ascii
        $delete2 = "MoveFileEx" ascii
        $movefile = "MOVEFILE_DELAY_UNTIL_REBOOT" ascii
        $cmd_del = "cmd /c del" ascii nocase
        // UNUSED: $self = "\\0" ascii  // Self path
    condition:
        uint16(0) == 0x5A4D and (any of ($delete1, $delete2, $movefile, $cmd_del))
}

rule Generic_Network_Scanner {
    meta:
        description = "Generic network scanner"
        severity = "medium"
    strings:
        $scan = "scan" ascii nocase
        $port = "port" ascii nocase
        $ping = "ping" ascii nocase
        $icmp = "ICMP" ascii
        $socket = "socket" ascii
        $connect = "connect" ascii
        // UNUSED: $timeout = "timeout" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($scan and (any of ($port, $ping, $icmp))) and ($socket and $connect)
}

rule Generic_Privilege_Escalation {
    meta:
        description = "Generic privilege escalation"
        severity = "critical"
    strings:
        $api1 = "AdjustTokenPrivileges" ascii
        $api2 = "OpenProcessToken" ascii
        $api3 = "LookupPrivilegeValue" ascii
        $se_debug = "SeDebugPrivilege" ascii
        $se_tcb = "SeTcbPrivilege" ascii
        $se_backup = "SeBackupPrivilege" ascii
        $admin = "Administrator" ascii
    condition:
        uint16(0) == 0x5A4D and (all of ($api*)) and (any of ($se_debug, $se_tcb, $se_backup, $admin))
}

rule Generic_File_Encryption {
    meta:
        description = "Generic file encryption"
        severity = "critical"
    strings:
        $crypt1 = "CryptEncrypt" ascii
        $crypt2 = "CryptGenKey" ascii
        $crypt3 = "CryptAcquireContext" ascii
        $aes = "AES" ascii
        $rsa = "RSA" ascii
        $encrypt = "encrypt" ascii nocase
        $extension = ".encrypted" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($crypt*)) and (any of ($aes, $rsa) or any of ($encrypt, $extension))
}

rule Generic_Worm_Indicators {
    meta:
        description = "Generic worm indicators"
        severity = "critical"
    strings:
        $spread = "spread" ascii nocase
        $propagate = "propagate" ascii nocase
        $replicate = "replicate" ascii nocase
        $copy = "CopyFile" ascii
        $usb = "\\\\.\\" ascii
        $network = "\\\\*\\" ascii
        $autorun = "autorun.inf" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($spread, $propagate, $replicate)) and (any of ($copy, $usb, $network, $autorun))
}

rule Generic_Reverse_Shell {
    meta:
        description = "Generic reverse shell"
        severity = "critical"
    strings:
        $socket = "socket" ascii
        $connect = "connect" ascii
        $cmd = "cmd.exe" ascii nocase
        $shell = "/bin/sh" ascii
        $dup2 = "dup2" ascii
        $create = "CreateProcess" ascii
        $pipe = "CreatePipe" ascii
    condition:
        uint16(0) == 0x5A4D and ($socket and $connect) and (any of ($cmd, $shell)) and (any of ($dup2, $create, $pipe))
}

