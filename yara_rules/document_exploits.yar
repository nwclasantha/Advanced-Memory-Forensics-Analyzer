/*
    Document Exploit Detection Rules
    Malicious documents, macros, and embedded exploits
*/

rule Doc_Macro_Suspicious {
    meta:
        description = "Suspicious Office macro"
        severity = "high"
    strings:
        $vba1 = "AutoOpen" ascii
        $vba2 = "Auto_Open" ascii
        $vba3 = "Document_Open" ascii
        $vba4 = "Workbook_Open" ascii
        $shell1 = "Shell" ascii
        $shell2 = "WScript.Shell" ascii
        $shell3 = "PowerShell" ascii nocase
        $exec1 = "CreateObject" ascii
        $exec2 = "Exec" ascii
    condition:
        (any of ($vba*) and any of ($shell*, $exec*))
}

rule Doc_Macro_Downloader {
    meta:
        description = "Macro-based downloader"
        severity = "critical"
    strings:
        $http1 = "MSXML2.XMLHTTP" ascii
        $http2 = "Microsoft.XMLHTTP" ascii
        $http3 = "WinHttp.WinHttpRequest" ascii
        $dl1 = "URLDownloadToFile" ascii
        $dl2 = "DownloadFile" ascii
        $dl3 = "Invoke-WebRequest" ascii nocase
    condition:
        any of ($http*) or any of ($dl*)
}

rule Doc_OLE_Embedded {
    meta:
        description = "Suspicious OLE embedded object"
        severity = "high"
    strings:
        $ole1 = { D0 CF 11 E0 A1 B1 1A E1 }
        $ole2 = "Package" ascii
        $ole3 = "OLE2Link" ascii
        $obj = "objdata" ascii nocase
        $link = "LINK" ascii
    condition:
        $ole1 and (any of ($ole2, $ole3, $obj, $link))
}

rule Doc_DDE_Attack {
    meta:
        description = "DDE command execution"
        severity = "critical"
    strings:
        $dde1 = "DDEAUTO" ascii nocase
        $dde2 = "DDE" ascii
        $cmd1 = "cmd.exe" ascii nocase
        $cmd2 = "powershell" ascii nocase
        $cmd3 = "mshta" ascii nocase
    condition:
        any of ($dde*) and any of ($cmd*)
}

rule Doc_RTF_Exploit {
    meta:
        description = "RTF exploit patterns"
        severity = "critical"
    strings:
        $rtf = "{\\rtf" ascii
        $obj1 = "\\objdata" ascii
        $obj2 = "\\objclass" ascii
        $obj3 = "\\objemb" ascii
        $cve = "equation" ascii nocase
    condition:
        $rtf and (2 of ($obj*) or $cve)
}

rule Doc_PDF_JavaScript {
    meta:
        description = "PDF with suspicious JavaScript"
        severity = "high"
    strings:
        $pdf = "%PDF" ascii
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $aa1 = "/OpenAction" ascii
        $aa2 = "/AA" ascii
        $shell = "app.launchURL" ascii
    condition:
        $pdf and (any of ($js*) and any of ($aa*)) or ($pdf and $shell)
}
