/*
    Linux Malware Detection
    Linux-specific threats and techniques
*/

rule Linux_Mirai_Botnet {
    meta:
        description = "Mirai Linux botnet"
        severity = "critical"
    strings:
        $s1 = "MIRAI" ascii nocase
        $s2 = "/bin/busybox" ascii
        $s3 = "killer_init" ascii
        $s4 = "scanner_init" ascii
        $s5 = "attack_init" ascii
        $telnet = "23" ascii
        $shell = "/bin/sh" ascii
    condition:
        uint32(0) == 0x464C457F and (3 of them)
}

rule Linux_XORDDoS {
    meta:
        description = "XOR DDoS botnet"
        severity = "critical"
    strings:
        $xor = "xor" ascii nocase
        $ddos = "ddos" ascii nocase
        $flood1 = "syn_flood" ascii
        $flood2 = "udp_flood" ascii
        $flood3 = "dns_flood" ascii
        $rootkit = "/etc/cron" ascii
        $persist = "rc.local" ascii
    condition:
        uint32(0) == 0x464C457F and ($xor and $ddos) and (any of ($flood*) or any of ($rootkit, $persist))
}

rule Linux_BillGates_Botnet {
    meta:
        description = "BillGates DDoS botnet"
        severity = "critical"
    strings:
        $gates = "gates" ascii nocase
        $bill = "bill" ascii nocase
        $ddos1 = "atk_" ascii
        $ddos2 = "Syn" ascii
        $ddos3 = "Udp" ascii
        $persist = "/etc/init.d" ascii
        $cron = "crontab" ascii
    condition:
        uint32(0) == 0x464C457F and (($gates and $bill) or (2 of ($ddos*))) and any of ($persist, $cron)
}

rule Linux_Tsunami_Botnet {
    meta:
        description = "Tsunami/Kaiten IRC botnet"
        severity = "critical"
    strings:
        $irc1 = "PRIVMSG" ascii
        $irc2 = "NICK" ascii
        $irc3 = "JOIN" ascii
        $irc4 = "PING" ascii
        $flood = "flood" ascii nocase
        $udp = "UDP" ascii
        $shell = "/bin/sh" ascii
    condition:
        uint32(0) == 0x464C457F and (3 of ($irc*)) and (any of ($flood, $udp, $shell))
}

rule Linux_Gafgyt {
    meta:
        description = "Gafgyt/Bashlite botnet"
        severity = "critical"
    strings:
        $s1 = "GAFGYT" ascii nocase
        $s2 = "BASHLITE" ascii nocase
        $s3 = "QBOT" ascii nocase
        $telnet = "telnet" ascii nocase
        $scanner = "scanner" ascii nocase
        $payload = "/bin/busybox" ascii
    condition:
        uint32(0) == 0x464C457F and (any of ($s*) or ($telnet and $scanner)) and $payload
}

rule Linux_Rootkit_Generic {
    meta:
        description = "Generic Linux rootkit indicators"
        severity = "critical"
    strings:
        $hide1 = "hide_pid" ascii
        $hide2 = "hide_file" ascii
        $hide3 = "hide_module" ascii
        $hook1 = "sys_call_table" ascii
        $hook2 = "kallsyms" ascii
        $hook3 = "getdents" ascii
        $lkm = "init_module" ascii
        // UNUSED: $proc = "/proc" ascii
    condition:
        uint32(0) == 0x464C457F and (any of ($hide*)) and (any of ($hook*) or $lkm)
}

rule Linux_Rootkit_Reptile {
    meta:
        description = "Reptile LKM rootkit"
        severity = "critical"
    strings:
        $reptile = "reptile" ascii nocase
        $hide = "hide" ascii
        $backdoor = "backdoor" ascii
        $magic = "magic" ascii
        $knock = "knock" ascii
        $lkm = ".ko" ascii
    condition:
        uint32(0) == 0x464C457F and ($reptile or (($hide or $backdoor) and ($magic or $knock))) and $lkm
}

rule Linux_Rootkit_Diamorphine {
    meta:
        description = "Diamorphine LKM rootkit"
        severity = "critical"
    strings:
        $diamorphine = "diamorphine" ascii nocase
        // UNUSED: $magic = "63" ascii  // magic signal
        $hide = "module_hide" ascii
        $root = "give_root" ascii
        $invisible = "is_invisible" ascii
    condition:
        uint32(0) == 0x464C457F and ($diamorphine or ($hide and $root) or $invisible)
}

rule Linux_Rootkit_Adore_ng {
    meta:
        description = "Adore-ng rootkit"
        severity = "critical"
    strings:
        $adore = "adore" ascii nocase
        $ng = "adore-ng" ascii nocase
        $hide = "hide_" ascii
        $ava = "ava" ascii
        $elite = "elite" ascii
    condition:
        uint32(0) == 0x464C457F and ($adore or $ng) and (any of ($hide, $ava, $elite))
}

rule Linux_Ransomware_Generic {
    meta:
        description = "Linux ransomware indicators"
        severity = "critical"
    strings:
        $encrypt1 = "encrypt" ascii nocase
        $encrypt2 = "AES" ascii
        $encrypt3 = "RSA" ascii
        $ransom = "ransom" ascii nocase
        $bitcoin = "bitcoin" ascii nocase
        $tor = ".onion" ascii
        $ext1 = ".encrypted" ascii
        $ext2 = ".locked" ascii
        $readme = "README" ascii
    condition:
        uint32(0) == 0x464C457F and (any of ($encrypt*)) and (any of ($ransom, $bitcoin, $tor, $ext1, $ext2, $readme))
}

rule Linux_Ransomware_REvil {
    meta:
        description = "REvil/Sodinokibi for Linux"
        severity = "critical"
    strings:
        $revil = "REvil" ascii nocase
        $sodin = "Sodinokibi" ascii nocase
        $esxi = "esxi" ascii nocase
        $vmdk = ".vmdk" ascii
        $vmx = ".vmx" ascii
        $encrypt = "encrypt" ascii nocase
    condition:
        uint32(0) == 0x464C457F and (any of ($revil, $sodin)) or ($esxi and any of ($vmdk, $vmx) and $encrypt)
}

rule Linux_Cryptominer_Generic {
    meta:
        description = "Generic Linux cryptominer"
        severity = "high"
    strings:
        $xmrig = "xmrig" ascii nocase
        $monero = "monero" ascii nocase
        $stratum = "stratum" ascii
        $pool = "pool" ascii nocase
        // UNUSED: $cpu = "cpu" ascii nocase
        $miner = "miner" ascii nocase
        $wallet = /4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}/ ascii  // Monero address
    condition:
        uint32(0) == 0x464C457F and (any of ($xmrig, $monero, $miner) and any of ($stratum, $pool)) or $wallet
}

rule Linux_Backdoor_BPFDoor {
    meta:
        description = "BPFDoor backdoor"
        severity = "critical"
    strings:
        $bpf = "BPF" ascii
        $filter = "filter" ascii
        $packet = "packet" ascii
        $socket = "SOCK_RAW" ascii
        $magic = "magic" ascii
        $shell = "/bin/sh" ascii
    condition:
        uint32(0) == 0x464C457F and $bpf and ($filter or $packet) and ($socket and ($magic or $shell))
}

rule Linux_Backdoor_RotaJakiro {
    meta:
        description = "RotaJakiro backdoor"
        severity = "critical"
    strings:
        $rotate = "rotate" ascii nocase
        $jakiro = "jakiro" ascii nocase
        $c2 = "news.thaprior.net" ascii
        $dns = "dns" ascii nocase
        $persist = "systemd" ascii
        $decrypt = "decrypt" ascii nocase
    condition:
        uint32(0) == 0x464C457F and (($rotate and $jakiro) or $c2) or ($dns and $persist and $decrypt)
}

rule Linux_Backdoor_Facefish {
    meta:
        description = "Facefish backdoor"
        severity = "critical"
    strings:
        $face = "face" ascii nocase
        $fish = "fish" ascii nocase
        $dropper = "dropper" ascii nocase
        $rootkit = "rootkit" ascii nocase
        $ld_preload = "LD_PRELOAD" ascii
        // UNUSED: $hook = "hook" ascii nocase
    condition:
        uint32(0) == 0x464C457F and (($face and $fish) or ($dropper and $rootkit)) or $ld_preload
}

rule Linux_Webshell_Generic {
    meta:
        description = "Linux web shell"
        severity = "critical"
    strings:
        $php = "<?php" ascii
        $exec1 = "system(" ascii
        $exec2 = "shell_exec(" ascii
        $exec3 = "passthru(" ascii
        $exec4 = "exec(" ascii
        $param = "$_GET" ascii
        $param2 = "$_POST" ascii
        $param3 = "$_REQUEST" ascii
    condition:
        $php and (any of ($exec*)) and (any of ($param*))
}

rule Linux_Persistence_Cron {
    meta:
        description = "Cron-based persistence"
        severity = "high"
    strings:
        $cron1 = "/etc/crontab" ascii
        $cron2 = "/var/spool/cron" ascii
        $cron3 = "/etc/cron.d" ascii
        $cron4 = "/etc/cron.daily" ascii
        $cron5 = "/etc/cron.hourly" ascii
        $wget = "wget" ascii
        $curl = "curl" ascii
        $bash = "/bin/bash" ascii
    condition:
        (any of ($cron*)) and (any of ($wget, $curl, $bash))
}

rule Linux_Persistence_Systemd {
    meta:
        description = "Systemd persistence"
        severity = "high"
    strings:
        $systemd1 = "/etc/systemd/system" ascii
        $systemd2 = "/usr/lib/systemd/system" ascii
        $systemd3 = ".service" ascii
        $exec = "ExecStart" ascii
        $enable = "WantedBy" ascii
        $restart = "Restart=always" ascii
    condition:
        (any of ($systemd1, $systemd2)) and $systemd3 and ($exec or $enable or $restart)
}

rule Linux_Persistence_InitD {
    meta:
        description = "Init.d persistence"
        severity = "high"
    strings:
        $initd = "/etc/init.d" ascii
        $rclocal = "/etc/rc.local" ascii
        $start = "start)" ascii
        $stop = "stop)" ascii
        $daemon = "daemon" ascii nocase
        $bash = "#!/bin/bash" ascii
    condition:
        (any of ($initd, $rclocal)) and ($start or $stop or $daemon) and $bash
}

rule Linux_Persistence_LD_Preload {
    meta:
        description = "LD_PRELOAD persistence"
        severity = "critical"
    strings:
        $preload1 = "/etc/ld.so.preload" ascii
        $preload2 = "LD_PRELOAD" ascii
        $so = ".so" ascii
        // UNUSED: $hook = "hook" ascii nocase
        // UNUSED: $override = "override" ascii nocase
    condition:
        uint32(0) == 0x464C457F and (any of ($preload*)) and $so
}

rule Linux_Persistence_SSH_Keys {
    meta:
        description = "SSH key persistence"
        severity = "high"
    strings:
        $ssh = ".ssh" ascii
        $auth = "authorized_keys" ascii
        $rsa = "ssh-rsa" ascii
        $ed = "ssh-ed25519" ascii
        $known = "known_hosts" ascii
        $private = "id_rsa" ascii
    condition:
        $ssh and ($auth or any of ($rsa, $ed)) or ($known and $private)
}

rule Linux_Persistence_Bashrc {
    meta:
        description = "Bashrc/profile persistence"
        severity = "medium"
    strings:
        $bashrc = ".bashrc" ascii
        $profile = ".bash_profile" ascii
        $profile2 = "/etc/profile" ascii
        $zshrc = ".zshrc" ascii
        $wget = "wget" ascii
        $curl = "curl" ascii
        $exec = "exec" ascii
    condition:
        (any of ($bashrc, $profile, $profile2, $zshrc)) and (any of ($wget, $curl, $exec))
}

rule Linux_Credential_Dump {
    meta:
        description = "Linux credential dumping"
        severity = "critical"
    strings:
        $shadow = "/etc/shadow" ascii
        $passwd = "/etc/passwd" ascii
        $ssh_key = "id_rsa" ascii
        $sudo = "/etc/sudoers" ascii
        $history = ".bash_history" ascii
        // UNUSED: $gnome = "gnome-keyring" ascii
    condition:
        (2 of ($shadow, $passwd, $ssh_key, $sudo)) or ($history and any of ($shadow, $passwd))
}

rule Linux_Container_Escape {
    meta:
        description = "Container escape techniques"
        severity = "critical"
    strings:
        $docker = "docker" ascii nocase
        $cgroup = "cgroup" ascii
        $release = "release_agent" ascii
        $notify = "notify_on_release" ascii
        $socket = "docker.sock" ascii
        $proc = "/proc/1" ascii
        $ns = "setns" ascii
    condition:
        uint32(0) == 0x464C457F and ($docker or ($cgroup and any of ($release, $notify)) or $socket or ($proc and $ns))
}

rule Linux_Privilege_Escalation {
    meta:
        description = "Linux privilege escalation"
        severity = "critical"
    strings:
        $suid = "setuid" ascii
        $setuid = "+s" ascii
        $cap = "CAP_" ascii
        // UNUSED: $sudo = "sudo" ascii
        $dirtycow = "dirtycow" ascii nocase
        $dirty = "dirty" ascii nocase
        $pipe = "pipe" ascii nocase
    condition:
        uint32(0) == 0x464C457F and (any of ($suid, $setuid, $cap)) or ($dirtycow or ($dirty and $pipe))
}

