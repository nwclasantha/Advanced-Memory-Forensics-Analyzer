/*
    ICS/SCADA Malware Detection
    Industrial control system and operational technology threats
*/

rule ICS_Industroyer {
    meta:
        description = "Industroyer/CRASHOVERRIDE"
        severity = "critical"
    strings:
        $s1 = "INDUSTROYER" ascii nocase
        $s2 = "CRASHOVERRIDE" ascii nocase
        $iec104 = "IEC 104" ascii
        $iec61850 = "IEC 61850" ascii
        $opc = "OPC" ascii
        $protocol1 = "61850" ascii
        $protocol2 = "104" ascii
        $grid = "grid" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($s*) or (any of ($iec104, $iec61850, $opc) and any of ($protocol1, $protocol2, $grid)))
}

rule ICS_TRITON_TRISIS {
    meta:
        description = "TRITON/TRISIS safety system attack"
        severity = "critical"
    strings:
        $s1 = "TRITON" ascii nocase
        $s2 = "TRISIS" ascii nocase
        $s3 = "HatMan" ascii nocase
        $triconex = "Triconex" ascii
        $sis = "SIS" ascii
        $safety = "Safety" ascii nocase
        // UNUSED: $plc = "PLC" ascii
        // UNUSED: $tricon = "TRICON" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($s*) or ($triconex and any of ($sis, $safety)))
}

rule ICS_BlackEnergy {
    meta:
        description = "BlackEnergy ICS malware"
        severity = "critical"
    strings:
        $be1 = "BlackEnergy" ascii nocase
        $be2 = "BE2" ascii
        $be3 = "BE3" ascii
        $killdisk = "KillDisk" ascii nocase
        // UNUSED: $hmi = "HMI" ascii
        // UNUSED: $scada = "SCADA" ascii
        // UNUSED: $plugin = "plugin" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($be*) or $killdisk)
}

rule ICS_Stuxnet {
    meta:
        description = "Stuxnet ICS worm"
        severity = "critical"
    strings:
        $stuxnet = "Stuxnet" ascii nocase
        $plc = "PLC" ascii
        $siemens = "Siemens" ascii
        $step7 = "STEP7" ascii
        $wincc = "WinCC" ascii
        $s7 = "S7-" ascii
        $profibus = "PROFIBUS" ascii
    condition:
        uint16(0) == 0x5A4D and ($stuxnet or (any of ($siemens, $step7, $wincc) and any of ($plc, $s7, $profibus)))
}

rule ICS_Havex {
    meta:
        description = "Havex ICS trojan"
        severity = "critical"
    strings:
        $havex = "Havex" ascii nocase
        $dragonfly = "Dragonfly" ascii nocase
        $opc = "OPC" ascii
        // UNUSED: $opc_da = "OPC DA" ascii
        $scada = "SCADA" ascii nocase
        $energy = "energy" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($havex, $dragonfly) or ($opc and any of ($scada, $energy)))
}

rule ICS_Pipedream_Incontroller {
    meta:
        description = "PIPEDREAM/INCONTROLLER toolkit"
        severity = "critical"
    strings:
        $s1 = "PIPEDREAM" ascii nocase
        $s2 = "INCONTROLLER" ascii nocase
        $s3 = "CHERNOVITE" ascii nocase
        $codesys = "CODESYS" ascii
        $modbus = "Modbus" ascii nocase
        $opc_ua = "OPC UA" ascii
        $schneider = "Schneider" ascii
        $omron = "Omron" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($s*) or (2 of ($codesys, $modbus, $opc_ua, $schneider, $omron)))
}

rule ICS_Irongate {
    meta:
        description = "IronGate ICS malware"
        severity = "critical"
    strings:
        $irongate = "IronGate" ascii nocase
        $siemens = "Siemens" ascii
        $s7 = "S7" ascii
        // UNUSED: $plcsim = "PLCSIM" ascii
        // UNUSED: $dll = "DLL" ascii
        // UNUSED: $replace = "replace" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($irongate or ($siemens and $s7))
}

rule ICS_GreyEnergy {
    meta:
        description = "GreyEnergy ICS malware"
        severity = "critical"
    strings:
        $grey = "GreyEnergy" ascii nocase
        $exaramel = "Exaramel" ascii nocase
        $telebots = "TeleBots" ascii nocase
        // UNUSED: $energy = "energy" ascii nocase
        // UNUSED: $grid = "grid" ascii nocase
        // UNUSED: $industrial = "industrial" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($grey, $exaramel, $telebots))
}

rule ICS_Protocol_Modbus {
    meta:
        description = "Modbus protocol manipulation"
        severity = "high"
    strings:
        $modbus = "Modbus" ascii nocase
        $tcp = "TCP" ascii
        $rtu = "RTU" ascii
        // UNUSED: $function = "function" ascii nocase
        $coil = "coil" ascii nocase
        $register = "register" ascii nocase
        $read = "read" ascii nocase
        $write = "write" ascii nocase
    condition:
        uint16(0) == 0x5A4D and $modbus and (any of ($tcp, $rtu)) and (2 of ($coil, $register, $read, $write))
}

rule ICS_Protocol_DNP3 {
    meta:
        description = "DNP3 protocol manipulation"
        severity = "high"
    strings:
        $dnp3 = "DNP3" ascii nocase
        $dnp = "DNP" ascii
        // UNUSED: $protocol = "protocol" ascii nocase
        $outstation = "outstation" ascii nocase
        $master = "master" ascii nocase
        $binary = "binary" ascii nocase
        $analog = "analog" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($dnp3 or $dnp) and (any of ($outstation, $master)) and (any of ($binary, $analog))
}

rule ICS_Protocol_IEC104 {
    meta:
        description = "IEC 60870-5-104 manipulation"
        severity = "high"
    strings:
        $iec = "IEC" ascii
        $iec104 = "104" ascii
        $protocol = "60870" ascii
        $apdu = "APDU" ascii
        $asdu = "ASDU" ascii
        $ioa = "IOA" ascii
    condition:
        uint16(0) == 0x5A4D and ($iec and $iec104) or ($protocol and any of ($apdu, $asdu, $ioa))
}

rule ICS_Protocol_OPC {
    meta:
        description = "OPC protocol manipulation"
        severity = "high"
    strings:
        $opc = "OPC" ascii
        $opc_da = "OPC DA" ascii
        $opc_ua = "OPC UA" ascii
        $opc_hda = "OPC HDA" ascii
        $dcom = "DCOM" ascii
        $browse = "browse" ascii nocase
        $tag = "tag" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($opc, $opc_da, $opc_ua, $opc_hda)) and (any of ($dcom, $browse, $tag))
}

rule ICS_Protocol_BACnet {
    meta:
        description = "BACnet protocol manipulation"
        severity = "high"
    strings:
        $bacnet = "BACnet" ascii nocase
        $bvlc = "BVLC" ascii
        $apdu = "APDU" ascii
        $device = "device" ascii nocase
        $property = "property" ascii nocase
        $object = "object" ascii nocase
    condition:
        uint16(0) == 0x5A4D and $bacnet and (any of ($bvlc, $apdu)) and (any of ($device, $property, $object))
}

rule ICS_PLC_Scanner {
    meta:
        description = "PLC scanning tool"
        severity = "high"
    strings:
        $plc = "PLC" ascii
        $scan = "scan" ascii nocase
        $discover = "discover" ascii nocase
        $siemens = "Siemens" ascii
        $allen = "Allen" ascii
        $bradley = "Bradley" ascii
        $rockwell = "Rockwell" ascii
        $schneider = "Schneider" ascii
    condition:
        uint16(0) == 0x5A4D and $plc and (any of ($scan, $discover)) and (any of ($siemens, $allen, $bradley, $rockwell, $schneider))
}

rule ICS_HMI_Attack {
    meta:
        description = "HMI attack indicators"
        severity = "critical"
    strings:
        $hmi = "HMI" ascii
        $wonderware = "Wonderware" ascii
        $factorytalk = "FactoryTalk" ascii
        $ignition = "Ignition" ascii
        $wincc = "WinCC" ascii
        $screenshot = "screenshot" ascii nocase
        $input = "input" ascii nocase
        $simulate = "simulate" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($hmi or any of ($wonderware, $factorytalk, $ignition, $wincc)) and (any of ($screenshot, $input, $simulate))
}

rule ICS_Firmware_Attack {
    meta:
        description = "ICS firmware attack"
        severity = "critical"
    strings:
        $firmware = "firmware" ascii nocase
        $flash = "flash" ascii nocase
        $upload = "upload" ascii nocase
        $download = "download" ascii nocase
        $plc = "PLC" ascii
        $rtu = "RTU" ascii
        $controller = "controller" ascii nocase
    condition:
        uint16(0) == 0x5A4D and $firmware and (any of ($flash, $upload, $download)) and (any of ($plc, $rtu, $controller))
}

rule ICS_Safety_System_Attack {
    meta:
        description = "Safety system attack"
        severity = "critical"
    strings:
        $safety = "Safety" ascii nocase
        $sis = "SIS" ascii
        $esd = "ESD" ascii
        $trip = "trip" ascii nocase
        $alarm = "alarm" ascii nocase
        $interlock = "interlock" ascii nocase
        $bypass = "bypass" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($safety, $sis, $esd)) and (any of ($trip, $alarm, $interlock, $bypass))
}

rule ICS_Historian_Attack {
    meta:
        description = "Historian database attack"
        severity = "high"
    strings:
        $historian = "Historian" ascii nocase
        $osisoft = "OSIsoft" ascii
        $pi = "PI" ascii
        // UNUSED: $af = "AF" ascii
        $tag = "tag" ascii nocase
        $archive = "archive" ascii nocase
        $sql = "SQL" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($historian, $osisoft, $pi)) and (any of ($tag, $archive, $sql))
}

rule ICS_Engineering_Workstation {
    meta:
        description = "Engineering workstation attack"
        severity = "critical"
    strings:
        $step7 = "STEP7" ascii
        $rslogix = "RSLogix" ascii
        $tia = "TIA Portal" ascii
        $codesys = "CODESYS" ascii
        $project = "project" ascii nocase
        $program = "program" ascii nocase
        $logic = "logic" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($step7, $rslogix, $tia, $codesys)) and (any of ($project, $program, $logic))
}

rule ICS_Serial_Protocol {
    meta:
        description = "Serial protocol attack"
        severity = "high"
    strings:
        $serial = "serial" ascii nocase
        $rs232 = "RS232" ascii
        $rs485 = "RS485" ascii
        $com = "COM" ascii
        $baud = "baud" ascii nocase
        $port = "port" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($serial, $rs232, $rs485)) and (any of ($com, $baud, $port))
}

