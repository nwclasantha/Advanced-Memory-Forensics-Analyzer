/*
    Kernel Exploit Detection
    Kernel-level vulnerabilities and privilege escalation exploits
*/

rule Kernel_Exploit_Generic {
    meta:
        description = "Generic kernel exploit indicators"
        severity = "critical"
    strings:
        $kernel = "kernel" ascii nocase
        $exploit = "exploit" ascii nocase
        $ring0 = "ring0" ascii nocase
        $ring_0 = "ring 0" ascii nocase
        $privilege = "privilege" ascii nocase
        $escalate = "escalat" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($kernel or any of ($ring0, $ring_0)) and any of ($exploit, $privilege, $escalate)
}

rule Kernel_EternalBlue {
    meta:
        description = "EternalBlue SMB exploit"
        severity = "critical"
    strings:
        $s1 = "EternalBlue" ascii nocase
        $s2 = "MS17-010" ascii
        $s3 = "CVE-2017-0144" ascii
        $smb = "SMB" ascii
        $srv = "srv.sys" ascii
        $ntpool = "NonPagedPool" ascii
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($smb and any of ($srv, $ntpool)))
}

rule Kernel_EternalRomance {
    meta:
        description = "EternalRomance SMB exploit"
        severity = "critical"
    strings:
        $s1 = "EternalRomance" ascii nocase
        $s2 = "CVE-2017-0145" ascii
        $smb = "SMB" ascii
        $transaction = "Transaction" ascii
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($smb and $transaction))
}

rule Kernel_DKOM {
    meta:
        description = "Direct Kernel Object Manipulation"
        severity = "critical"
    strings:
        $dkom = "DKOM" ascii
        $eprocess = "EPROCESS" ascii
        $ethread = "ETHREAD" ascii
        $activeprocess = "ActiveProcessLinks" ascii
        $blink = "Blink" ascii
        $flink = "Flink" ascii
    condition:
        uint16(0) == 0x5A4D and ($dkom or (any of ($eprocess, $ethread) and any of ($activeprocess, $blink, $flink)))
}

rule Kernel_Token_Stealing {
    meta:
        description = "Kernel token stealing"
        severity = "critical"
    strings:
        $token = "Token" ascii
        $system = "System" ascii
        $steal = "steal" ascii nocase
        $copy = "copy" ascii nocase
        $eprocess = "EPROCESS" ascii
        $offset = "TokenOffset" ascii
    condition:
        uint16(0) == 0x5A4D and $token and (any of ($steal, $copy) or $eprocess or $offset) and $system
}

rule Kernel_NtQuery_Abuse {
    meta:
        description = "NtQuery functions abuse"
        severity = "high"
    strings:
        $api1 = "NtQuerySystemInformation" ascii
        $api2 = "NtQueryInformationProcess" ascii
        $api3 = "NtQueryInformationThread" ascii
        $api4 = "ZwQuerySystemInformation" ascii
        $handle = "SystemHandleInformation" ascii
        $module = "SystemModuleInformation" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($api*)) and any of ($handle, $module)
}

rule Kernel_CVE_2021_1732 {
    meta:
        description = "CVE-2021-1732 Win32k privilege escalation"
        severity = "critical"
    strings:
        $cve = "CVE-2021-1732" ascii
        $win32k = "win32k" ascii nocase
        $priv = "privilege" ascii nocase
        $create = "NtUserCreateWindowEx" ascii
        $callback = "xxxCreateWindowEx" ascii
    condition:
        uint16(0) == 0x5A4D and ($cve or ($win32k and any of ($priv, $create, $callback)))
}

rule Kernel_CVE_2020_0796 {
    meta:
        description = "CVE-2020-0796 SMBGhost"
        severity = "critical"
    strings:
        $cve = "CVE-2020-0796" ascii
        $smbghost = "SMBGhost" ascii nocase
        $smb = "SMBv3" ascii nocase
        $compress = "compress" ascii nocase
        $srv2 = "srv2.sys" ascii
    condition:
        uint16(0) == 0x5A4D and ($cve or $smbghost or ($smb and any of ($compress, $srv2)))
}

rule Kernel_Potato_Exploit {
    meta:
        description = "Potato privilege escalation"
        severity = "critical"
    strings:
        $potato = "Potato" ascii nocase
        $hot = "HotPotato" ascii nocase
        $juicy = "JuicyPotato" ascii nocase
        $rotten = "RottenPotato" ascii nocase
        $sweet = "SweetPotato" ascii nocase
        $impersonate = "SeImpersonatePrivilege" ascii
    condition:
        uint16(0) == 0x5A4D and ((any of ($hot, $juicy, $rotten, $sweet)) or ($potato and $impersonate))
}

rule Kernel_PrintNightmare {
    meta:
        description = "PrintNightmare exploit"
        severity = "critical"
    strings:
        $cve1 = "CVE-2021-1675" ascii
        $cve2 = "CVE-2021-34527" ascii
        $nightmare = "PrintNightmare" ascii nocase
        $spoolsv = "spoolsv" ascii nocase
        $addprinter = "AddPrinterDriverEx" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($cve1, $cve2, $nightmare) or ($spoolsv and $addprinter))
}

rule Kernel_ZeroLogon {
    meta:
        description = "ZeroLogon exploit"
        severity = "critical"
    strings:
        $cve = "CVE-2020-1472" ascii
        $zerologon = "ZeroLogon" ascii nocase
        $netlogon = "Netlogon" ascii nocase
        $aes = "AES-CFB8" ascii
        $zero = "zero" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($cve or $zerologon or ($netlogon and any of ($aes, $zero)))
}

rule Kernel_Callback_Abuse {
    meta:
        description = "Kernel callback abuse"
        severity = "critical"
    strings:
        $callback = "callback" ascii nocase
        $register = "PsSetCreate" ascii
        $load = "PsSetLoadImage" ascii
        $thread = "PsSetCreateThread" ascii
        $process = "PsSetCreateProcess" ascii
        $remove = "remove" ascii nocase
    condition:
        uint16(0) == 0x5A4D and $callback and (any of ($register, $load, $thread, $process)) and $remove
}

rule Kernel_HVCI_Bypass {
    meta:
        description = "HVCI bypass attempt"
        severity = "critical"
    strings:
        $hvci = "HVCI" ascii
        $hypervisor = "hypervisor" ascii nocase
        $bypass = "bypass" ascii nocase
        $vbs = "VBS" ascii
        $integrity = "Code Integrity" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($hvci or $vbs) and any of ($bypass, $hypervisor, $integrity)
}

rule Kernel_PatchGuard_Bypass {
    meta:
        description = "PatchGuard/KPP bypass"
        severity = "critical"
    strings:
        $patchguard = "PatchGuard" ascii nocase
        $kpp = "KPP" ascii
        $bypass = "bypass" ascii nocase
        $disable = "disable" ascii nocase
        $kernel = "kernel" ascii nocase
        $patch = "patch" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($patchguard or $kpp) and any of ($bypass, $disable, $kernel, $patch)
}

rule Kernel_DSE_Bypass {
    meta:
        description = "Driver Signature Enforcement bypass"
        severity = "critical"
    strings:
        $dse = "DSE" ascii
        $driver = "driver" ascii nocase
        $signature = "signature" ascii nocase
        $enforce = "enforcement" ascii nocase
        $bypass = "bypass" ascii nocase
        $unsigned = "unsigned" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($dse or ($driver and $signature and $enforce)) and any of ($bypass, $unsigned)
}

rule Kernel_SMEP_SMAP_Bypass {
    meta:
        description = "SMEP/SMAP bypass"
        severity = "critical"
    strings:
        $smep = "SMEP" ascii
        $smap = "SMAP" ascii
        $cr4 = "CR4" ascii
        $bypass = "bypass" ascii nocase
        $disable = "disable" ascii nocase
        $bit = "bit 20" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($smep, $smap, $cr4)) and any of ($bypass, $disable, $bit)
}

rule Kernel_Vulnerable_Driver {
    meta:
        description = "Vulnerable driver exploitation"
        severity = "critical"
    strings:
        $driver = ".sys" ascii nocase
        $vuln = "vulnerable" ascii nocase
        $exploit = "exploit" ascii nocase
        $load = "NtLoadDriver" ascii
        $ioctl = "DeviceIoControl" ascii
        $arbitrary = "arbitrary" ascii nocase
    condition:
        uint16(0) == 0x5A4D and $driver and ($vuln or $exploit) and any of ($load, $ioctl, $arbitrary)
}

rule Kernel_Pool_Overflow {
    meta:
        description = "Kernel pool overflow"
        severity = "critical"
    strings:
        $pool = "pool" ascii nocase
        $overflow = "overflow" ascii nocase
        $spray = "spray" ascii nocase
        $nonpaged = "NonPagedPool" ascii
        $paged = "PagedPool" ascii
        $allocate = "ExAllocatePool" ascii
    condition:
        uint16(0) == 0x5A4D and $pool and ($overflow or $spray) and any of ($nonpaged, $paged, $allocate)
}

rule Kernel_Arbitrary_Write {
    meta:
        description = "Arbitrary kernel write"
        severity = "critical"
    strings:
        $arbitrary = "arbitrary" ascii nocase
        $write = "write" ascii nocase
        $kernel = "kernel" ascii nocase
        $wwhere = "write-what-where" ascii nocase
        $memory = "memory" ascii nocase
        $primitive = "primitive" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($arbitrary and $write and any of ($kernel, $memory)) or ($wwhere and $primitive)
}

rule Kernel_Use_After_Free {
    meta:
        description = "Kernel use-after-free"
        severity = "critical"
    strings:
        $uaf = "use-after-free" ascii nocase
        $free = "free" ascii nocase
        $use = "use" ascii nocase
        $after = "after" ascii nocase
        $dangling = "dangling" ascii nocase
        $pool = "pool" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($uaf or (($free and $use and $after) or $dangling)) and $pool
}

