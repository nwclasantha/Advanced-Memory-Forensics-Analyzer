/*
    Document Malware Detection Rules
    Covers: Office macros, PDF exploits, RTF exploits, etc.
*/

rule Office_Macro_AutoOpen {
    meta:
        description = "Office macro with auto-execution"
        severity = "high"
    strings:
        $auto1 = "AutoOpen" nocase
        $auto2 = "AutoExec" nocase
        $auto3 = "Auto_Open" nocase
        $auto4 = "Workbook_Open" nocase
        $auto5 = "Document_Open" nocase
        $auto6 = "AutoExit" nocase
    condition:
        any of them
}

rule Office_Macro_Shell {
    meta:
        description = "Office macro with shell execution"
        severity = "critical"
    strings:
        $shell1 = "Shell" ascii
        $shell2 = "WScript.Shell" ascii
        $shell3 = "Shell.Application" ascii
        $exec1 = "cmd.exe" nocase
        $exec2 = "powershell" nocase
    condition:
        any of ($shell*) and any of ($exec*)
}

rule Office_Macro_Download {
    meta:
        description = "Office macro with download capability"
        severity = "critical"
    strings:
        $dl1 = "URLDownloadToFile" ascii
        $dl2 = "XMLHTTP" ascii
        $dl3 = "WinHttp" ascii
        $dl4 = "InternetOpen" ascii
        $dl5 = "WebClient" ascii
        $http = "http" nocase
    condition:
        any of ($dl*) and $http
}

rule Office_Macro_Process {
    meta:
        description = "Office macro creating process"
        severity = "critical"
    strings:
        $proc1 = "CreateObject" ascii
        $proc2 = "WScript.Shell" ascii
        $proc3 = "Run" ascii
        $proc4 = "Exec" ascii
    condition:
        $proc1 and any of ($proc2, $proc3, $proc4)
}

rule Office_Macro_Obfuscated {
    meta:
        description = "Obfuscated Office macro"
        severity = "high"
    strings:
        $chr1 = "Chr(" ascii
        $chr2 = "ChrW(" ascii
        $chr3 = "Asc(" ascii
        $obf1 = "StrReverse" ascii
        $obf2 = "Replace(" ascii
        $obf3 = "Mid(" ascii
    condition:
        3 of them
}

rule Office_Macro_VBA_Stomping {
    meta:
        description = "VBA stomping detection"
        severity = "high"
    strings:
        $vba = "VBA" ascii
        $stomp = {00 00 00 00 00 00 00 00}
    condition:
        $vba and $stomp
}

rule Office_DDE_Attack {
    meta:
        description = "Office DDE attack"
        severity = "critical"
    strings:
        $dde1 = "DDE" ascii
        $dde2 = "DDEAUTO" ascii
        $dde3 = "ddelink" ascii
        $cmd = "cmd" nocase
        $ps = "powershell" nocase
    condition:
        any of ($dde*) and any of ($cmd, $ps)
}

rule Office_Embedded_Object {
    meta:
        description = "Office document with embedded object"
        severity = "medium"
    strings:
        $ole1 = "OLE2Link" ascii
        $ole2 = "Package" ascii
        $ole3 = "objdata" ascii
        $embed = "EMBEDDED" ascii
    condition:
        2 of them
}

rule PDF_JavaScript {
    meta:
        description = "PDF with JavaScript"
        severity = "high"
    strings:
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $js3 = "eval(" ascii
        $js4 = "unescape(" ascii
    condition:
        any of ($js1, $js2) and any of ($js3, $js4)
}

rule PDF_Embedded_File {
    meta:
        description = "PDF with embedded file"
        severity = "medium"
    strings:
        $embed1 = "/EmbeddedFile" ascii
        $embed2 = "/Filespec" ascii
        $embed3 = "/F (" ascii
    condition:
        any of them
}

rule PDF_Launch_Action {
    meta:
        description = "PDF with launch action"
        severity = "critical"
    strings:
        $action1 = "/Launch" ascii
        $action2 = "/Action" ascii
        $action3 = "/Win" ascii
        $cmd = "cmd.exe" nocase
    condition:
        2 of ($action*) or ($action1 and $cmd)
}

rule PDF_OpenAction {
    meta:
        description = "PDF with auto-open action"
        severity = "high"
    strings:
        $open1 = "/OpenAction" ascii
        $open2 = "/AA" ascii
        $js = "/JavaScript" ascii
    condition:
        any of ($open*) and $js
}

rule PDF_URI_Action {
    meta:
        description = "PDF with URI action"
        severity = "medium"
    strings:
        $uri1 = "/URI" ascii
        $uri2 = "/S /URI" ascii
        $http = "http" nocase
    condition:
        any of ($uri*) and $http
}

rule PDF_Stream_Obfuscated {
    meta:
        description = "PDF with obfuscated stream"
        severity = "high"
    strings:
        $filter1 = "/FlateDecode" ascii
        $filter2 = "/ASCIIHexDecode" ascii
        $filter3 = "/ASCII85Decode" ascii
        $filter4 = "/LZWDecode" ascii
        $filter5 = "/RunLengthDecode" ascii
        $chain = "/Filter [" ascii
    condition:
        $chain or 2 of ($filter*)
}

rule RTF_Embedded_Object {
    meta:
        description = "RTF with embedded object"
        severity = "high"
    strings:
        $rtf = "{\\rtf" ascii
        $obj1 = "\\object" ascii
        $obj2 = "\\objocx" ascii
        $obj3 = "\\objemb" ascii
        $obj4 = "\\objlink" ascii
    condition:
        $rtf and any of ($obj*)
}

rule RTF_Equation_Editor {
    meta:
        description = "RTF Equation Editor exploit (CVE-2017-11882)"
        severity = "critical"
    strings:
        $rtf = "{\\rtf" ascii
        $eq1 = "Equation.3" ascii
        $eq2 = "equation" nocase
        $clsid = "0002CE02" ascii
    condition:
        $rtf and (any of ($eq*) or $clsid)
}

rule RTF_CVE_2017_0199 {
    meta:
        description = "RTF CVE-2017-0199 exploit"
        severity = "critical"
    strings:
        $rtf = "{\\rtf" ascii
        $ole = "\\objdata" ascii
        $clsid = "00000300-0000-0000-C000-000000000046" ascii
    condition:
        $rtf and $ole and $clsid
}

rule RTF_Obfuscated {
    meta:
        description = "Obfuscated RTF document"
        severity = "high"
    strings:
        $rtf = "{\\rtf" ascii
        $hex = /\\[0-9a-fA-F]{2}/
        // UNUSED: $obf = "{\\" ascii
    condition:
        $rtf and #hex > 100
}

rule OLE_Compound_Macro {
    meta:
        description = "OLE compound document with macros"
        severity = "high"
    strings:
        $ole = {D0 CF 11 E0 A1 B1 1A E1}
        $vba1 = "VBA" ascii
        $vba2 = "_VBA_PROJECT" ascii
        $vba3 = "dir" ascii
    condition:
        $ole at 0 and any of ($vba*)
}

rule OOXML_Macro_Enabled {
    meta:
        description = "OOXML macro-enabled document"
        severity = "medium"
    strings:
        $pk = {50 4B 03 04}
        $macro1 = "vbaProject.bin" ascii
        $macro2 = "xl/vbaProject.bin" ascii
        $macro3 = "word/vbaProject.bin" ascii
    condition:
        $pk at 0 and any of ($macro*)
}

rule OOXML_External_Link {
    meta:
        description = "OOXML with external link"
        severity = "medium"
    strings:
        $pk = {50 4B 03 04}
        $ext1 = "Target=\"http" ascii
        $ext2 = "TargetMode=\"External\"" ascii
    condition:
        $pk at 0 and any of ($ext*)
}

rule XLM_4_Macro {
    meta:
        description = "Excel 4.0 XLM macro"
        severity = "critical"
    strings:
        $xlm1 = "EXEC(" ascii
        $xlm2 = "CALL(" ascii
        $xlm3 = "REGISTER(" ascii
        $xlm4 = "RUN(" ascii
        $xlm5 = "ALERT(" ascii
        $formula = "=EXEC" ascii
    condition:
        2 of ($xlm*) or $formula
}

rule HTA_Malicious {
    meta:
        description = "Malicious HTA file"
        severity = "critical"
    strings:
        $hta = "<HTA:APPLICATION" nocase
        $script = "<script" nocase
        $shell1 = "WScript.Shell" ascii
        $shell2 = "powershell" nocase
        $shell3 = "cmd.exe" nocase
    condition:
        $hta and $script and any of ($shell*)
}

rule CHM_Malicious {
    meta:
        description = "Malicious CHM file"
        severity = "high"
    strings:
        $chm = "ITSF" ascii
        $script = "<script" nocase
        $exec = "cmd.exe" nocase
    condition:
        $chm at 0 and ($script or $exec)
}

rule LNK_Malicious {
    meta:
        description = "Malicious LNK shortcut"
        severity = "high"
    strings:
        $lnk = {4C 00 00 00 01 14 02 00}
        $cmd = "cmd.exe" nocase
        $ps = "powershell" nocase
        $mshta = "mshta" nocase
    condition:
        $lnk at 0 and any of ($cmd, $ps, $mshta)
}

rule ISO_IMG_Malicious {
    meta:
        description = "Malicious ISO/IMG container"
        severity = "high"
    strings:
        $iso1 = "CD001" ascii
        $exe = ".exe" nocase
        $dll = ".dll" nocase
        $lnk = ".lnk" nocase
    condition:
        $iso1 and any of ($exe, $dll, $lnk)
}
