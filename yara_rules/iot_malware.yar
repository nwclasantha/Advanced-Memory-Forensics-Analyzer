/*
    IoT Malware Detection
    Mirai variants, BotenaGo, and IoT-specific threats
*/

rule IoT_Mirai_Generic {
    meta:
        description = "Generic Mirai botnet detection"
        severity = "critical"
    strings:
        $s1 = "/bin/busybox" ascii
        $s2 = "MIRAI" ascii
        $s3 = "POST /cdn-cgi/" ascii
        $s4 = "/dev/watchdog" ascii
        $s5 = "TSource Engine Query" ascii
        $killer = "killer_init" ascii
        $scanner = "scanner_init" ascii
        $attack = "attack_init" ascii
    condition:
        (3 of ($s*)) or (all of ($killer, $scanner, $attack))
}

rule IoT_Mirai_Variant_Mozi {
    meta:
        description = "Mozi botnet (Mirai variant)"
        severity = "critical"
    strings:
        $mozi = "Mozi" ascii nocase
        $dht = "DHT" ascii
        $config = "[ss]" ascii
        $bot = "[bot]" ascii
        $count = "[count]" ascii
        $telnet = "telnet" ascii
    condition:
        uint32(0) == 0x464C457F and
        ($mozi or (3 of ($dht, $config, $bot, $count, $telnet)))
}

rule IoT_BotenaGo {
    meta:
        description = "BotenaGo malware"
        severity = "critical"
    strings:
        $go = "Go build" ascii
        $exp1 = "/cgi-bin/luci" ascii
        $exp2 = "/HNAP1" ascii
        $exp3 = "/picsdesc.xml" ascii
        $exp4 = "/goform/" ascii
        $shell = "/bin/sh" ascii
        $wget = "wget" ascii
    condition:
        uint32(0) == 0x464C457F and
        $go and (2 of ($exp*)) and ($shell or $wget)
}

rule IoT_Gafgyt_Bashlite {
    meta:
        description = "Gafgyt/Bashlite botnet"
        severity = "critical"
    strings:
        $s1 = "GAFGYT" ascii nocase
        $s2 = "BASHLITE" ascii nocase
        $s3 = "QBOT" ascii nocase
        $cmd1 = "UDP" ascii
        $cmd2 = "TCP" ascii
        $cmd3 = "JUNK" ascii
        $scanner = "192.168" ascii
        $telnet = ":23" ascii
    condition:
        uint32(0) == 0x464C457F and
        (any of ($s*) or ((2 of ($cmd*)) and ($scanner or $telnet)))
}

rule IoT_Hajime {
    meta:
        description = "Hajime IoT worm"
        severity = "high"
    strings:
        $hajime = "hajime" ascii nocase
        $bittorrent = "BitTorrent" ascii
        $dht = "announce_peer" ascii
        $atk = "atk_" ascii
        $config = ".i.hajime" ascii
    condition:
        uint32(0) == 0x464C457F and (2 of them)
}

rule IoT_Kaiji {
    meta:
        description = "Kaiji DDoS botnet"
        severity = "critical"
    strings:
        $go = "runtime.gopanic" ascii
        $ssh = "golang.org/x/crypto/ssh" ascii
        $ddos1 = "ipspoof" ascii
        $ddos2 = "synflood" ascii
        $ddos3 = "ackflood" ascii
        $rootkit = "/etc/ld.so.preload" ascii
    condition:
        uint32(0) == 0x464C457F and
        $go and ($ssh or (2 of ($ddos*)) or $rootkit)
}

rule IoT_Hide_N_Seek {
    meta:
        description = "Hide 'N Seek botnet"
        severity = "critical"
    strings:
        $hns = "HNS" ascii
        $p2p = "p2p" ascii nocase
        $dht = "dht" ascii nocase
        $crypto = "AES" ascii
        $scan1 = "scan_" ascii
        $scan2 = "brute" ascii
    condition:
        uint32(0) == 0x464C457F and
        (($hns and $p2p) or (2 of ($dht, $crypto, $scan1, $scan2)))
}

rule IoT_Dark_Nexus {
    meta:
        description = "Dark Nexus botnet"
        severity = "critical"
    strings:
        $dark = "dark_nexus" ascii nocase
        $hoho = "hoho" ascii
        $reverse = "reverse" ascii
        $proxy = "socks5" ascii
        $killer = "killer" ascii
    condition:
        uint32(0) == 0x464C457F and (2 of them)
}

rule IoT_VPNFilter {
    meta:
        description = "VPNFilter modular malware"
        severity = "critical"
    strings:
        $stage1 = "/var/run/vpnfilter" ascii
        $stage2 = "/var/run/tor" ascii
        $persist = "NETGEAR" ascii
        $persist2 = "LINKSYS" ascii
        $persist3 = "MikroTik" ascii
        $cmd = "shell" ascii
        $exfil = "exfiltrate" ascii
    condition:
        uint32(0) == 0x464C457F and
        (any of ($stage*)) or ((any of ($persist*)) and any of ($cmd, $exfil))
}

rule IoT_Reaper_IoTroop {
    meta:
        description = "Reaper/IoTroop botnet"
        severity = "critical"
    strings:
        $lua = "lua" ascii nocase
        $exploit1 = "CVE-2017" ascii
        $exploit2 = "D-Link" ascii nocase
        $exploit3 = "Netgear" ascii nocase
        $exploit4 = "GoAhead" ascii nocase
        $c2 = "report" ascii
        $scanner = "scan" ascii
    condition:
        uint32(0) == 0x464C457F and
        $lua and (2 of ($exploit*)) and any of ($c2, $scanner)
}

rule IoT_Tsunami_Kaiten {
    meta:
        description = "Tsunami/Kaiten IRC bot"
        severity = "high"
    strings:
        $irc1 = "PRIVMSG" ascii
        $irc2 = "NICK" ascii
        $irc3 = "JOIN" ascii
        $cmd1 = "TSUNAMI" ascii
        $cmd2 = "KAITEN" ascii
        $cmd3 = "XMAS" ascii
        $ddos = "flood" ascii nocase
    condition:
        uint32(0) == 0x464C457F and
        (2 of ($irc*)) and (any of ($cmd*) or $ddos)
}

rule IoT_LiquorBot {
    meta:
        description = "LiquorBot cryptomining botnet"
        severity = "high"
    strings:
        $go = "Go build" ascii
        $miner = "xmrig" ascii nocase
        $monero = "monero" ascii nocase
        $pool = "pool" ascii nocase
        $stratum = "stratum" ascii
    condition:
        uint32(0) == 0x464C457F and
        $go and (any of ($miner, $monero) or ($pool and $stratum))
}

rule IoT_Telnet_Bruteforce {
    meta:
        description = "Telnet bruteforce scanner"
        severity = "high"
    strings:
        $telnet = "telnet" ascii nocase
        $port = ":23" ascii
        $user1 = "root" ascii
        $user2 = "admin" ascii
        $user3 = "user" ascii
        $pass1 = "admin" ascii
        $pass2 = "password" ascii
        $pass3 = "123456" ascii
        $pass4 = "default" ascii
        // UNUSED: $busybox = "busybox" ascii
    condition:
        uint32(0) == 0x464C457F and
        ($telnet or $port) and (2 of ($user*)) and (2 of ($pass*))
}

rule IoT_SSH_Bruteforce {
    meta:
        description = "SSH bruteforce for IoT"
        severity = "high"
    strings:
        $ssh = "ssh" ascii nocase
        $port = ":22" ascii
        $libssh = "libssh" ascii
        $paramiko = "paramiko" ascii
        $auth = "auth" ascii nocase
        $brute = "brute" ascii nocase
        $wordlist = "wordlist" ascii nocase
    condition:
        uint32(0) == 0x464C457F and
        ($ssh or $port) and (any of ($libssh, $paramiko)) and any of ($auth, $brute, $wordlist)
}

rule IoT_Router_Exploit {
    meta:
        description = "Generic router exploit payload"
        severity = "critical"
    strings:
        $cgi1 = "/cgi-bin/" ascii
        $cgi2 = "/HNAP1/" ascii
        $cgi3 = "/goform/" ascii
        $cgi4 = "/apply.cgi" ascii
        $cmd1 = "wget" ascii
        $cmd2 = "curl" ascii
        $cmd3 = "tftp" ascii
        $shell = "/bin/sh" ascii
        $pipe = "|" ascii
        $rce = "$()" ascii
    condition:
        uint32(0) == 0x464C457F and
        (any of ($cgi*)) and (any of ($cmd*)) and ($shell or $pipe or $rce)
}

rule IoT_Camera_Exploit {
    meta:
        description = "IP camera exploitation"
        severity = "high"
    strings:
        $cam1 = "Hikvision" ascii nocase
        $cam2 = "Dahua" ascii nocase
        $cam3 = "AXIS" ascii nocase
        $cam4 = "Foscam" ascii nocase
        $rtsp = "rtsp://" ascii
        $onvif = "onvif" ascii nocase
        // UNUSED: $ptz = "PTZ" ascii
        // UNUSED: $stream = "stream" ascii nocase
        $exploit = "exploit" ascii nocase
    condition:
        uint32(0) == 0x464C457F and
        (any of ($cam*) or $onvif) and ($exploit or $rtsp)
}

rule IoT_UPnP_Exploit {
    meta:
        description = "UPnP exploitation"
        severity = "high"
    strings:
        $upnp = "UPnP" ascii nocase
        $ssdp = "SSDP" ascii
        $soap = "SOAP" ascii
        $desc = "rootDesc.xml" ascii
        $add = "AddPortMapping" ascii
        $delete = "DeletePortMapping" ascii
        $forward = "PortForwarding" ascii
    condition:
        uint32(0) == 0x464C457F and
        ($upnp or $ssdp) and (any of ($soap, $desc, $add, $delete, $forward))
}

rule IoT_MQTT_Abuse {
    meta:
        description = "MQTT protocol abuse"
        severity = "medium"
    strings:
        $mqtt = "MQTT" ascii
        $port = "1883" ascii
        $connect = "CONNECT" ascii
        $publish = "PUBLISH" ascii
        $subscribe = "SUBSCRIBE" ascii
        $topic = "topic" ascii nocase
        // UNUSED: $malicious = /\$SYS\/broker/ ascii
    condition:
        uint32(0) == 0x464C457F and
        ($mqtt or $port) and (2 of ($connect, $publish, $subscribe, $topic))
}

rule IoT_CoAP_Attack {
    meta:
        description = "CoAP protocol attack"
        severity = "medium"
    strings:
        $coap = "CoAP" ascii
        $port = "5683" ascii
        $uri = "coap://" ascii
        $method1 = "GET" ascii
        $method2 = "PUT" ascii
        $method3 = "POST" ascii
        $amplify = "amplif" ascii nocase
    condition:
        uint32(0) == 0x464C457F and
        ($coap or $uri or $port) and (any of ($method*) or $amplify)
}

