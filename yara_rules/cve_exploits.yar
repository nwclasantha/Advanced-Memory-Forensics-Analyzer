/*
    CVE Exploit Detection
    Known vulnerability exploits and proof-of-concepts
*/

rule CVE_2021_44228_Log4Shell {
    meta:
        description = "Log4Shell exploit (CVE-2021-44228)"
        severity = "critical"
        cve = "CVE-2021-44228"
    strings:
        $jndi1 = "${jndi:" ascii nocase
        $jndi2 = "${jndi:ldap" ascii nocase
        $jndi3 = "${jndi:rmi" ascii nocase
        $jndi4 = "${jndi:dns" ascii nocase
        $bypass1 = "${${" ascii
        $bypass2 = "${lower:" ascii
        $bypass3 = "${upper:" ascii
        $log4j = "log4j" ascii nocase
    condition:
        (any of ($jndi*)) or (any of ($bypass*) and $log4j)
}

rule CVE_2021_34527_PrintNightmare {
    meta:
        description = "PrintNightmare exploit"
        severity = "critical"
        cve = "CVE-2021-34527"
    strings:
        $api1 = "AddPrinterDriverEx" ascii
        $api2 = "RpcAddPrinterDriverEx" ascii
        // UNUSED: $spooler = "spoolsv.exe" ascii nocase
        // UNUSED: $driver = "pDriverPath" ascii
        $dll = ".dll" ascii nocase
        $remote = "\\\\" ascii
    condition:
        uint16(0) == 0x5A4D and ((any of ($api*)) and $dll and $remote)
}

rule CVE_2021_26855_ProxyLogon {
    meta:
        description = "ProxyLogon Exchange exploit"
        severity = "critical"
        cve = "CVE-2021-26855"
    strings:
        $exchange = "Exchange" ascii
        $autodiscover = "autodiscover" ascii nocase
        $ssrf = "X-BEResource" ascii
        $cookie = "X-AnonResource-Backend" ascii
        $owa = "OWA" ascii
        $server = "server=" ascii nocase
    condition:
        ($exchange or $owa) and (any of ($autodiscover, $ssrf, $cookie, $server))
}

rule CVE_2021_27065_ProxyLogon {
    meta:
        description = "ProxyLogon webshell write"
        severity = "critical"
        cve = "CVE-2021-27065"
    strings:
        $oab = "OABVirtualDirectory" ascii
        $external = "ExternalUrl" ascii
        $webshell = "webshell" ascii nocase
        $aspx = ".aspx" ascii nocase
        // UNUSED: $script = "<script" ascii nocase
    condition:
        ($oab and $external) or ($webshell and $aspx)
}

rule CVE_2021_21972_VMware_vCenter {
    meta:
        description = "VMware vCenter RCE"
        severity = "critical"
        cve = "CVE-2021-21972"
    strings:
        $vcenter = "vCenter" ascii nocase
        $vsphere = "vSphere" ascii nocase
        $upload = "uploadova" ascii nocase
        $shell = "shell" ascii nocase
        $tar = ".tar" ascii nocase
    condition:
        (any of ($vcenter, $vsphere)) and ($upload or ($shell and $tar))
}

rule CVE_2020_1472_Zerologon {
    meta:
        description = "Zerologon Netlogon exploit"
        severity = "critical"
        cve = "CVE-2020-1472"
    strings:
        $zerologon = "Zerologon" ascii nocase
        $netlogon = "Netlogon" ascii nocase
        $netr = "NetrServerAuthenticate" ascii
        $session = "NetrServerPasswordSet2" ascii
        $rpc = "ncacn_np" ascii
        // UNUSED: $zero = { 00 00 00 00 00 00 00 00 }
    condition:
        uint16(0) == 0x5A4D and ($zerologon or ($netlogon and (any of ($netr, $session, $rpc))))
}

rule CVE_2020_0688_Exchange_RCE {
    meta:
        description = "Exchange ViewState RCE"
        severity = "critical"
        cve = "CVE-2020-0688"
    strings:
        $exchange = "Exchange" ascii
        $viewstate = "__VIEWSTATE" ascii
        $viewgen = "ViewStateUserKey" ascii
        $ecp = "ECP" ascii
        $deserialize = "deserialize" ascii nocase
    condition:
        $exchange and ($viewstate or $viewgen) and (any of ($ecp, $deserialize))
}

rule CVE_2019_19781_Citrix_ADC {
    meta:
        description = "Citrix ADC path traversal"
        severity = "critical"
        cve = "CVE-2019-19781"
    strings:
        $citrix = "Citrix" ascii nocase
        $netscaler = "NetScaler" ascii nocase
        $path = "/vpn/../vpns/" ascii
        $nsconfig = "nsconfig" ascii
        $newbm = "newbm.pl" ascii
    condition:
        (any of ($citrix, $netscaler)) and (any of ($path, $nsconfig, $newbm))
}

rule CVE_2019_0708_BlueKeep {
    meta:
        description = "BlueKeep RDP exploit"
        severity = "critical"
        cve = "CVE-2019-0708"
    strings:
        $bluekeep = "BlueKeep" ascii nocase
        $rdp = "RDP" ascii
        $rdp2 = "3389" ascii
        $ms_t120 = "MS_T120" ascii
        // UNUSED: $channel = "channel" ascii nocase
        $exploit = "exploit" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($bluekeep or (($rdp or $rdp2) and $ms_t120 and $exploit))
}

rule CVE_2018_13379_FortiGate {
    meta:
        description = "FortiGate SSL VPN path traversal"
        severity = "critical"
        cve = "CVE-2018-13379"
    strings:
        $forti = "Forti" ascii nocase
        $fortigate = "FortiGate" ascii nocase
        $sslvpn = "sslvpn" ascii nocase
        $path = "/remote/fgt_lang" ascii
        $traversal = "../" ascii
        $sslvpn_websession = "sslvpn_websession" ascii
    condition:
        (any of ($forti, $fortigate, $sslvpn)) and (any of ($path, $traversal, $sslvpn_websession))
}

rule CVE_2017_11882_Equation_Editor {
    meta:
        description = "Equation Editor exploit"
        severity = "critical"
        cve = "CVE-2017-11882"
    strings:
        $ole = { D0 CF 11 E0 }
        $rtf = "{\\rtf" ascii
        $equation = "Equation" ascii nocase
        $eqnedt = "EQNEDT32" ascii nocase
        $exploit = { 02 CE 02 00 }
        $objdata = "\\objdata" ascii
    condition:
        ($ole or $rtf) and (any of ($equation, $eqnedt)) and (any of ($exploit, $objdata))
}

rule CVE_2017_0199_HTA_Handler {
    meta:
        description = "Office HTA handler exploit"
        severity = "critical"
        cve = "CVE-2017-0199"
    strings:
        $rtf = "{\\rtf" ascii
        $ole = { D0 CF 11 E0 }
        $objautlink = "\\objautlink" ascii
        $objupdate = "\\objupdate" ascii
        $hta = "application/hta" ascii nocase
        $mshta = "mshta" ascii nocase
    condition:
        ($rtf or $ole) and (any of ($objautlink, $objupdate)) and (any of ($hta, $mshta))
}

rule CVE_2017_0144_EternalBlue {
    meta:
        description = "EternalBlue SMB exploit"
        severity = "critical"
        cve = "CVE-2017-0144"
    strings:
        $eternal = "EternalBlue" ascii nocase
        $ms17 = "MS17-010" ascii
        $smb = "SMB" ascii
        $smb_port = "445" ascii
        $trans2 = "Trans2" ascii
        $exploit = "exploit" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($eternal, $ms17) or (($smb or $smb_port) and $trans2 and $exploit))
}

rule CVE_2022_30190_Follina {
    meta:
        description = "Follina MSDT exploit"
        severity = "critical"
        cve = "CVE-2022-30190"
    strings:
        $follina = "Follina" ascii nocase
        $msdt = "ms-msdt:" ascii nocase
        $msdt2 = "ms-msdt" ascii nocase
        $pcwdiagnostic = "PCWDiagnostic" ascii
        $it_browse = "IT_BrowseForFile" ascii
        $powershell = "powershell" ascii nocase
    condition:
        ($follina or $msdt or $msdt2) and (any of ($pcwdiagnostic, $it_browse, $powershell))
}

rule CVE_2022_26134_Confluence {
    meta:
        description = "Confluence OGNL injection"
        severity = "critical"
        cve = "CVE-2022-26134"
    strings:
        $confluence = "Confluence" ascii nocase
        $ognl = "OGNL" ascii
        $ognl2 = "${" ascii
        $runtime = "Runtime" ascii
        $exec = "exec" ascii
        $cmd = "cmd" ascii nocase
    condition:
        $confluence and ($ognl or $ognl2) and (any of ($runtime, $exec, $cmd))
}

rule CVE_2022_22965_Spring4Shell {
    meta:
        description = "Spring4Shell exploit"
        severity = "critical"
        cve = "CVE-2022-22965"
    strings:
        $spring = "Spring" ascii nocase
        $spring4shell = "Spring4Shell" ascii nocase
        $springshell = "SpringShell" ascii nocase
        $class = "class.module" ascii
        $classloader = "classLoader" ascii
        $tomcat = "Tomcat" ascii nocase
    condition:
        (any of ($spring4shell, $springshell)) or ($spring and (any of ($class, $classloader, $tomcat)))
}

rule CVE_2023_23397_Outlook {
    meta:
        description = "Outlook NTLM relay"
        severity = "critical"
        cve = "CVE-2023-23397"
    strings:
        $outlook = "Outlook" ascii nocase
        $reminder = "PidLidReminderFileParameter" ascii
        $unc = "\\\\" ascii
        $ntlm = "NTLM" ascii
        // UNUSED: $msg = ".msg" ascii nocase
    condition:
        $outlook and ($reminder or ($unc and $ntlm))
}

rule CVE_2023_34362_MOVEit {
    meta:
        description = "MOVEit SQL injection"
        severity = "critical"
        cve = "CVE-2023-34362"
    strings:
        $moveit = "MOVEit" ascii nocase
        $sqli = "SQL" ascii
        $injection = "injection" ascii nocase
        // UNUSED: $transfer = "transfer" ascii nocase
        $deserialization = "deserialization" ascii nocase
    condition:
        $moveit and (any of ($sqli, $injection, $deserialization))
}

rule CVE_2023_4966_Citrix_Bleed {
    meta:
        description = "Citrix Bleed exploit"
        severity = "critical"
        cve = "CVE-2023-4966"
    strings:
        $citrix = "Citrix" ascii nocase
        $bleed = "Bleed" ascii nocase
        $netscaler = "NetScaler" ascii nocase
        $adc = "ADC" ascii
        $gateway = "Gateway" ascii
        $session = "session" ascii nocase
        $token = "token" ascii nocase
    condition:
        (any of ($citrix, $netscaler)) and ($bleed or any of ($session, $token, $adc, $gateway))
}

rule CVE_2024_3400_PAN_OS {
    meta:
        description = "PAN-OS command injection"
        severity = "critical"
        cve = "CVE-2024-3400"
    strings:
        $panos = "PAN-OS" ascii nocase
        $paloalto = "Palo Alto" ascii nocase
        $globalprotect = "GlobalProtect" ascii
        $cmd = "cmd" ascii nocase
        $injection = "injection" ascii nocase
        $ssl_vpn = "SSL VPN" ascii nocase
    condition:
        (any of ($panos, $paloalto, $globalprotect)) and (any of ($cmd, $injection, $ssl_vpn))
}

