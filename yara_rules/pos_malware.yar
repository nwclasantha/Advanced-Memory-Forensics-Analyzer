/*
    Point of Sale (POS) Malware Detection
    RAM scrapers and payment card theft malware
*/

rule POS_RAM_Scraper_Generic {
    meta:
        description = "Generic POS RAM scraper"
        severity = "critical"
    strings:
        $api1 = "ReadProcessMemory" ascii
        $api2 = "OpenProcess" ascii
        $api3 = "EnumProcesses" ascii
        $track1 = "^%B" ascii
        $track2 = ";\\d{13,19}=" ascii
        $pan = /\\d{15,16}/ ascii
        $magstripe = "magstripe" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (all of ($api*)) and any of ($track1, $track2, $pan, $magstripe)
}

rule POS_BlackPOS {
    meta:
        description = "BlackPOS malware"
        severity = "critical"
    strings:
        $s1 = "BlackPOS" ascii nocase
        $s2 = "Kaptoxa" ascii nocase
        $s3 = "KAPTOXAS" ascii
        $dump = "dump" ascii nocase
        $track = "track" ascii nocase
        $pos = "pos" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($dump and $track and $pos))
}

rule POS_Dexter {
    meta:
        description = "Dexter POS malware"
        severity = "critical"
    strings:
        $s1 = "Dexter" ascii nocase
        $s2 = "d3xt3r" ascii nocase
        $inject = "inject" ascii nocase
        $memory = "memory" ascii nocase
        $card = "card" ascii nocase
        $track = "track" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($inject and $memory and any of ($card, $track)))
}

rule POS_Alina {
    meta:
        description = "Alina POS malware"
        severity = "critical"
    strings:
        $s1 = "Alina" ascii nocase
        $s2 = "JackPOS" ascii nocase
        $spark = "Spark" ascii nocase
        $scrape = "scrape" ascii nocase
        $track = "track" ascii nocase
        $dump = "dump" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($scrape and any of ($track, $dump)))
}

rule POS_ChewBacca {
    meta:
        description = "ChewBacca POS Trojan"
        severity = "critical"
    strings:
        $s1 = "ChewBacca" ascii nocase
        $s2 = "chewbacca" ascii nocase
        $tor = "Tor" ascii nocase
        $keylog = "keylog" ascii nocase
        $memory = "memory" ascii nocase
        $card = "card" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($tor and any of ($keylog, $memory, $card)))
}

rule POS_Backoff {
    meta:
        description = "Backoff POS malware"
        severity = "critical"
    strings:
        $s1 = "Backoff" ascii nocase
        $s2 = "backoff" ascii nocase
        $scraper = "scraper" ascii nocase
        $inject = "inject" ascii nocase
        $keylog = "keylog" ascii nocase
        $c2 = "command" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($scraper and any of ($inject, $keylog, $c2)))
}

rule POS_FrameworkPOS {
    meta:
        description = "FrameworkPOS malware"
        severity = "critical"
    strings:
        $s1 = "FrameworkPOS" ascii nocase
        $s2 = "framework" ascii nocase
        $dns = "DNS" ascii
        $exfil = "exfil" ascii nocase
        $track = "track" ascii nocase
        $memory = "memory" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and $dns and any of ($exfil, $track, $memory)))
}

rule POS_TreasureHunter {
    meta:
        description = "TreasureHunter POS malware"
        severity = "critical"
    strings:
        $s1 = "TreasureHunter" ascii nocase
        $s2 = "treasure" ascii nocase
        $hunt = "hunt" ascii nocase
        $scrape = "scrape" ascii nocase
        $card = "card" ascii nocase
        $dump = "dump" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and $hunt) or ($scrape and any of ($card, $dump)))
}

rule POS_GlitchPOS {
    meta:
        description = "GlitchPOS malware"
        severity = "critical"
    strings:
        $s1 = "GlitchPOS" ascii nocase
        $s2 = "glitch" ascii nocase
        $builder = "builder" ascii nocase
        $panel = "panel" ascii nocase
        $track = "track" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and any of ($builder, $panel, $track)))
}

rule POS_AbaddonPOS {
    meta:
        description = "AbaddonPOS malware"
        severity = "critical"
    strings:
        $s1 = "AbaddonPOS" ascii nocase
        $s2 = "Abaddon" ascii nocase
        $tiny = "TinyPOS" ascii nocase
        $scrape = "scrape" ascii nocase
        $memory = "memory" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($tiny and any of ($scrape, $memory)))
}

rule POS_MalumPOS {
    meta:
        description = "MalumPOS malware"
        severity = "critical"
    strings:
        $s1 = "MalumPOS" ascii nocase
        $s2 = "malum" ascii nocase
        $oracle = "Oracle" ascii nocase
        $micros = "MICROS" ascii nocase
        $scrape = "scrape" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and any of ($oracle, $micros, $scrape)))
}

rule POS_RawPOS {
    meta:
        description = "RawPOS malware"
        severity = "critical"
    strings:
        $s1 = "RawPOS" ascii nocase
        $s2 = "FIENDCRY" ascii
        $s3 = "DUEBREW" ascii
        $scrape = "scrape" ascii nocase
        $dump = "dump" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($s*)) or ($scrape and $dump))
}

rule POS_FighterPOS {
    meta:
        description = "FighterPOS malware"
        severity = "critical"
    strings:
        $s1 = "FighterPOS" ascii nocase
        $s2 = "fighter" ascii nocase
        $brazil = "brazil" ascii nocase
        $scrape = "scrape" ascii nocase
        $card = "card" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and any of ($brazil, $scrape, $card)))
}

rule POS_MagikPOS {
    meta:
        description = "MagikPOS malware"
        severity = "critical"
    strings:
        $s1 = "MagikPOS" ascii nocase
        $s2 = "magik" ascii nocase
        $lateral = "lateral" ascii nocase
        $scrape = "scrape" ascii nocase
        $track = "track" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and any of ($lateral, $scrape, $track)))
}

rule POS_DMSniff {
    meta:
        description = "DMSniff POS malware"
        severity = "critical"
    strings:
        $s1 = "DMSniff" ascii nocase
        $s2 = "dmsniff" ascii nocase
        $dga = "DGA" ascii
        $dns = "DNS" ascii
        $scrape = "scrape" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($s2 and any of ($dga, $dns, $scrape)))
}

rule POS_Track_Data_Pattern {
    meta:
        description = "Credit card track data pattern"
        severity = "critical"
    strings:
        $track1 = /\%B[0-9]{13,19}\^[A-Z\/\s]{2,26}\^[0-9]{4}/ ascii
        $track2 = /;[0-9]{13,19}=[0-9]{4}/ ascii
        $pan = /[^0-9][3-6][0-9]{14,15}[^0-9]/ ascii
        $cvv = "CVV" ascii
        $expiry = "expiry" ascii nocase
    condition:
        (any of ($track1, $track2, $pan)) and any of ($cvv, $expiry)
}

rule POS_Memory_Scraping_API {
    meta:
        description = "Memory scraping API combination"
        severity = "high"
    strings:
        $api1 = "CreateToolhelp32Snapshot" ascii
        $api2 = "Process32First" ascii
        $api3 = "Process32Next" ascii
        $api4 = "VirtualQueryEx" ascii
        $api5 = "ReadProcessMemory" ascii
        $card = "card" ascii nocase
        $track = "track" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (4 of ($api*)) and any of ($card, $track)
}

rule POS_Magstripe_Keywords {
    meta:
        description = "Magnetic stripe data keywords"
        severity = "high"
    strings:
        $mag1 = "magstripe" ascii nocase
        $mag2 = "mag stripe" ascii nocase
        $mag3 = "magnetic stripe" ascii nocase
        $track1 = "track1" ascii nocase
        $track2 = "track2" ascii nocase
        $dump = "dump" ascii nocase
        $scrape = "scrape" ascii nocase
    condition:
        (any of ($mag*)) and (any of ($track1, $track2)) and any of ($dump, $scrape)
}

rule POS_Process_Names {
    meta:
        description = "POS process name targeting"
        severity = "high"
    strings:
        $pos1 = "pos.exe" ascii nocase
        $pos2 = "retail" ascii nocase
        $pos3 = "NCR" ascii
        $pos4 = "Verifone" ascii nocase
        $pos5 = "Ingenico" ascii nocase
        $pos6 = "MICROS" ascii
        $target = "target" ascii nocase
        $process = "process" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (2 of ($pos*)) and any of ($target, $process)
}

rule POS_Luhn_Validation {
    meta:
        description = "Luhn algorithm implementation"
        severity = "high"
    strings:
        $luhn = "luhn" ascii nocase
        $checksum = "checksum" ascii nocase
        $validate = "validate" ascii nocase
        $card = "card" ascii nocase
        $digit = "digit" ascii nocase
        $mod = "mod 10" ascii nocase
    condition:
        $luhn or (($checksum or $validate) and $card and any of ($digit, $mod))
}

