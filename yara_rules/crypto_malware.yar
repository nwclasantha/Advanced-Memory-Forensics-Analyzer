/*
    Cryptocurrency Malware Detection
    Miners, wallet stealers, clipper malware, and crypto-related threats
*/

rule Crypto_Miner_XMRig {
    meta:
        description = "XMRig Monero miner"
        severity = "high"
    strings:
        $s1 = "xmrig" ascii nocase
        $s2 = "RandomX" ascii
        $s3 = "cryptonight" ascii nocase
        $s4 = "stratum+tcp://" ascii
        $s5 = "pool.minexmr" ascii
        $s6 = "supportxmr.com" ascii
        $cfg = "\"algo\":" ascii
        $cpu = "cpu-affinity" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($s*) or ($cfg and $cpu))
}

rule Crypto_Miner_CGMiner {
    meta:
        description = "CGMiner cryptocurrency miner"
        severity = "medium"
    strings:
        $s1 = "cgminer" ascii nocase
        $s2 = "BFGminer" ascii nocase
        $pool = "pool" ascii
        $stratum = "stratum" ascii
        $worker = "worker" ascii
        $diff = "difficulty" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($s*) or (3 of ($pool, $stratum, $worker, $diff)))
}

rule Crypto_Miner_Coinhive {
    meta:
        description = "Coinhive web miner (deprecated but clones exist)"
        severity = "high"
    strings:
        $s1 = "coinhive" ascii nocase
        $s2 = "CoinHive" ascii
        $s3 = "authedmine" ascii nocase
        $js1 = "miner.start()" ascii
        $js2 = "CoinHive.Anonymous" ascii
        $key = /[a-zA-Z0-9]{32}/ ascii
    condition:
        2 of ($s*) or (any of ($js*) and $key)
}

rule Crypto_Miner_WannaMine {
    meta:
        description = "WannaMine cryptominer"
        severity = "high"
    strings:
        $s1 = "wannamine" ascii nocase
        $s2 = "EternalBlue" ascii nocase
        $s3 = "DoublePulsar" ascii nocase
        $ps = "powershell" ascii nocase
        $smb = "445" ascii
        $miner = "miner" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($s*) or ($ps and $smb and $miner))
}

rule Crypto_Miner_Lemon_Duck {
    meta:
        description = "Lemon Duck cryptominer"
        severity = "high"
    strings:
        $s1 = "lemon" ascii nocase
        $s2 = "duck" ascii nocase
        $email = "smtp" ascii nocase
        $brute = "brute" ascii nocase
        $xmr = "monero" ascii nocase
        $ps = "powershell" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (($s1 and $s2) or (3 of ($email, $brute, $xmr, $ps)))
}

rule Crypto_Miner_PowerGhost {
    meta:
        description = "PowerGhost cryptominer"
        severity = "high"
    strings:
        $s1 = "powerghost" ascii nocase
        $ps = "powershell" ascii nocase
        $mimikatz = "mimikatz" ascii nocase
        $wmi = "WMI" ascii
        $eternalblue = "MS17-010" ascii
    condition:
        $s1 or ($ps and $mimikatz and ($wmi or $eternalblue))
}

rule Crypto_Clipper_Generic {
    meta:
        description = "Cryptocurrency address clipper"
        severity = "critical"
    strings:
        $clip1 = "GetClipboardData" ascii
        $clip2 = "SetClipboardData" ascii
        $clip3 = "OpenClipboard" ascii
        // Bitcoin address regex
        $btc = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ ascii
        // Ethereum address regex
        $eth = /0x[a-fA-F0-9]{40}/ ascii
        // Monero address regex
        $xmr = /4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}/ ascii
        $replace = "Replace" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($clip*)) and (any of ($btc, $eth, $xmr)) and $replace
}

rule Crypto_Clipper_CryptoShuffler {
    meta:
        description = "CryptoShuffler clipper malware"
        severity = "critical"
    strings:
        $s1 = "CryptoShuffler" ascii
        $clip = "Clipboard" ascii
        $btc = "bitcoin" ascii nocase
        $wallet = "wallet" ascii nocase
        $timer = "Timer" ascii
        // UNUSED: $check = "check" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ($s1 or ($clip and $btc and $wallet and $timer))
}

rule Crypto_Wallet_Stealer {
    meta:
        description = "Cryptocurrency wallet stealer"
        severity = "critical"
    strings:
        $w1 = "wallet.dat" ascii
        $w2 = "Electrum" ascii
        $w3 = "Exodus" ascii
        $w4 = "Atomic" ascii
        $w5 = "Jaxx" ascii
        $w6 = "Coinomi" ascii
        $w7 = "Ledger" ascii
        $w8 = "Trezor" ascii
        $path1 = "\\Ethereum\\" ascii
        $path2 = "\\Bitcoin\\" ascii
        $path3 = "\\Litecoin\\" ascii
        $copy = "CopyFile" ascii
        $upload = "upload" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (3 of ($w*) or 2 of ($path*)) and ($copy or $upload)
}

rule Crypto_Browser_Extension_Stealer {
    meta:
        description = "Browser extension wallet stealer"
        severity = "critical"
    strings:
        $ext1 = "nkbihfbeogaeaoehlefnkodbefgpgknn" ascii // MetaMask
        $ext2 = "ibnejdfjmmkpcnlpebklmnkoeoihofec" ascii // TronLink
        $ext3 = "jbdaocneiiinmjbjlgalhcelgbejmnid" ascii // Nifty
        $ext4 = "fhbohimaelbohpjbbldcngcnapndodjp" ascii // Binance
        $ext5 = "aiifbnbfobpmeekipheeijimdpnlpgpp" ascii // Terra Station
        $local = "Local Extension Settings" ascii
        $level = "leveldb" ascii
    condition:
        uint16(0) == 0x5A4D and (2 of ($ext*) or ($local and $level))
}

rule Crypto_Seed_Phrase_Stealer {
    meta:
        description = "Seed phrase/mnemonic stealer"
        severity = "critical"
    strings:
        $seed1 = "seed phrase" ascii nocase
        $seed2 = "mnemonic" ascii nocase
        $seed3 = "recovery phrase" ascii nocase
        $seed4 = "secret phrase" ascii nocase
        $bip = "BIP39" ascii
        $words = "wordlist" ascii nocase
        // Common seed words
        // UNUSED: $w1 = "abandon" ascii
        // UNUSED: $w2 = "ability" ascii
        // UNUSED: $w3 = "abstract" ascii
        $grab = "grab" ascii nocase
    condition:
        uint16(0) == 0x5A4D and ((any of ($seed*) or $bip) and ($grab or $words))
}

rule Crypto_Exchange_Phish {
    meta:
        description = "Crypto exchange phishing/fake app"
        severity = "high"
    strings:
        $ex1 = "binance" ascii nocase
        $ex2 = "coinbase" ascii nocase
        $ex3 = "kraken" ascii nocase
        $ex4 = "kucoin" ascii nocase
        $ex5 = "huobi" ascii nocase
        $login = "login" ascii nocase
        $pass = "password" ascii nocase
        $api = "api_key" ascii nocase
        $secret = "api_secret" ascii nocase
        $send = "send" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (2 of ($ex*)) and (2 of ($login, $pass, $api, $secret)) and $send
}

rule Crypto_Ransomware_BTC {
    meta:
        description = "Ransomware with Bitcoin payment"
        severity = "critical"
    strings:
        $btc1 = "bitcoin" ascii nocase
        $btc2 = "BTC" ascii
        $addr = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ ascii
        $pay = "pay" ascii nocase
        $ransom = "ransom" ascii nocase
        $decrypt = "decrypt" ascii nocase
        $encrypt = "encrypt" ascii nocase
        $tor = ".onion" ascii
    condition:
        uint16(0) == 0x5A4D and (any of ($btc*) and $addr and (2 of ($pay, $ransom, $decrypt, $encrypt, $tor)))
}

rule Crypto_Fake_Mining_Pool {
    meta:
        description = "Fake mining pool/investment scam"
        severity = "high"
    strings:
        $mine = "mining" ascii nocase
        $pool = "pool" ascii nocase
        $invest = "invest" ascii nocase
        $profit = "profit" ascii nocase
        $double = "double" ascii nocase
        $guarantee = "guarantee" ascii nocase
        $btc = "bitcoin" ascii nocase
        $eth = "ethereum" ascii nocase
    condition:
        3 of ($mine, $pool, $invest, $profit) and any of ($double, $guarantee) and any of ($btc, $eth)
}

rule Crypto_Dusting_Attack {
    meta:
        description = "Crypto dusting attack preparation"
        severity = "medium"
    strings:
        $dust = "dust" ascii nocase
        $utxo = "UTXO" ascii
        $small = "satoshi" ascii nocase
        $track = "track" ascii nocase
        $address = "address" ascii nocase
        $wallet = "wallet" ascii nocase
    condition:
        ($dust and any of ($utxo, $small)) and ($track or ($address and $wallet))
}

rule Crypto_Smart_Contract_Exploit {
    meta:
        description = "Smart contract exploit code"
        severity = "high"
    strings:
        $sol = "pragma solidity" ascii
        $reentrancy = "call.value" ascii
        $flash = "flashloan" ascii nocase
        $drain = "drain" ascii nocase
        $exploit = "exploit" ascii nocase
        $selfdestruct = "selfdestruct" ascii
        $delegatecall = "delegatecall" ascii
    condition:
        $sol and (2 of ($reentrancy, $flash, $drain, $exploit, $selfdestruct, $delegatecall))
}

rule Crypto_Private_Key_Stealer {
    meta:
        description = "Private key extraction attempt"
        severity = "critical"
    strings:
        $key1 = "private key" ascii nocase
        $key2 = "privateKey" ascii
        $key3 = "privkey" ascii nocase
        $hex = /[a-fA-F0-9]{64}/ ascii
        $file = "keystore" ascii nocase
        $json = ".json" ascii
        $export = "export" ascii nocase
    condition:
        uint16(0) == 0x5A4D and (any of ($key*)) and ($hex or $file or $json) and $export
}
