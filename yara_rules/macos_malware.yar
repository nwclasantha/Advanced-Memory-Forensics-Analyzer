/*
    macOS Malware Detection
    macOS-specific threats and techniques
*/

rule MacOS_Shlayer {
    meta:
        description = "Shlayer adware/malware"
        severity = "high"
    strings:
        $s1 = "Shlayer" ascii nocase
        $s2 = "Safari" ascii
        $s3 = "Adload" ascii nocase
        $dmg = ".dmg" ascii
        $pkg = ".pkg" ascii
        $bash = "#!/bin/bash" ascii
        $curl = "curl" ascii
        $chmod = "chmod +x" ascii
    condition:
        uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
        (any of ($s*) and (any of ($dmg, $pkg)) and ($bash and ($curl or $chmod)))
}

rule MacOS_XCSSET {
    meta:
        description = "XCSSET malware"
        severity = "critical"
    strings:
        $xcode = "Xcode" ascii
        $project = "xcodeproj" ascii
        $inject = "Contents/Developer" ascii
        $script = "xcrun" ascii
        $module = "module" ascii nocase
        $replicator = "replicator" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        $xcode and ($project or $inject) and (any of ($script, $module, $replicator))
}

rule MacOS_Silver_Sparrow {
    meta:
        description = "Silver Sparrow malware"
        severity = "critical"
    strings:
        $s1 = "Silver Sparrow" ascii nocase
        $api1 = "api.github.com" ascii
        $s3p = "s3.amazonaws.com" ascii
        $plist = "com.apple." ascii
        $launch = "LaunchAgents" ascii
        // UNUSED: $js = "JavaScript" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (($s1) or ((any of ($api1, $s3p)) and $plist and $launch))
}

rule MacOS_Bundlore {
    meta:
        description = "Bundlore adware"
        severity = "medium"
    strings:
        $bundle = "Bundlore" ascii nocase
        $install = "installCore" ascii
        $adware = "adware" ascii nocase
        $pup = "MacOffers" ascii
        $ext = "Safari" ascii
        $plist = ".plist" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (any of ($bundle, $install, $adware, $pup)) and ($ext or $plist)
}

rule MacOS_Lazarus_AppleJeus {
    meta:
        description = "Lazarus AppleJeus"
        severity = "critical"
    strings:
        $crypto = "crypto" ascii nocase
        $trade = "trade" ascii nocase
        $wallet = "wallet" ascii nocase
        // UNUSED: $api = "api" ascii nocase
        $launch = "LaunchDaemons" ascii
        $plist = ".plist" ascii
        // UNUSED: $persist = "KeepAlive" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (2 of ($crypto, $trade, $wallet)) and ($launch or $plist)
}

rule MacOS_EvilQuest_ThiefQuest {
    meta:
        description = "EvilQuest/ThiefQuest ransomware"
        severity = "critical"
    strings:
        $ransom = "ransom" ascii nocase
        $encrypt = "encrypt" ascii nocase
        $bitcoin = "bitcoin" ascii nocase
        $keylog = "keylog" ascii nocase
        $exfil = "upload" ascii nocase
        // UNUSED: $persist = "LaunchAgents" ascii
        $tor = ".onion" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (($ransom or $encrypt) and ($bitcoin or $tor)) or ($keylog and $exfil)
}

rule MacOS_Pirrit {
    meta:
        description = "OSX.Pirrit adware"
        severity = "medium"
    strings:
        $pirrit = "Pirrit" ascii nocase
        $install = "InstallMac" ascii
        $browser = "com.apple.Safari" ascii
        $proxy = "proxy" ascii nocase
        $mitm = "mitm" ascii nocase
        $cert = "certificate" ascii nocase
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (any of ($pirrit, $install)) or ($browser and any of ($proxy, $mitm, $cert))
}

rule MacOS_CookieMiner {
    meta:
        description = "CookieMiner credential stealer"
        severity = "critical"
    strings:
        $cookie = "cookie" ascii nocase
        $chrome = "Chrome" ascii
        $safari = "Safari" ascii
        $keychain = "Keychain" ascii
        $login = "Login Data" ascii
        $wallet = "wallet" ascii nocase
        $coinbase = "coinbase" ascii nocase
        $binance = "binance" ascii nocase
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        ($cookie and (any of ($chrome, $safari)) and ($keychain or $login)) or
        (any of ($wallet, $coinbase, $binance))
}

rule MacOS_Adload {
    meta:
        description = "Adload persistent adware"
        severity = "medium"
    strings:
        $adload = "Adload" ascii nocase
        $helper = "Helper" ascii
        $agent = "Agent" ascii
        $launch = "LaunchAgents" ascii
        $plist = ".plist" ascii
        // UNUSED: $safari = "Safari" ascii
        // UNUSED: $proxy = "proxy" ascii nocase
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        ($helper and $agent and $launch) or ($adload and $plist)
}

rule MacOS_Proton_RAT {
    meta:
        description = "Proton RAT"
        severity = "critical"
    strings:
        $proton = "Proton" ascii nocase
        $handbrake = "Handbrake" ascii
        $keylog = "keylog" ascii nocase
        $screen = "screenshot" ascii nocase
        $webcam = "webcam" ascii nocase
        // UNUSED: $shell = "/bin/bash" ascii
        $keychain = "security find" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        ($proton or $handbrake) and (any of ($keylog, $screen, $webcam, $keychain))
}

rule MacOS_Eleanor {
    meta:
        description = "OSX.Eleanor backdoor"
        severity = "critical"
    strings:
        $eleanor = "Eleanor" ascii nocase
        $tor = "tor" ascii nocase
        $hidden = "hidden service" ascii nocase
        $php = "php" ascii nocase
        $web = "web" ascii nocase
        $shell = "shell" ascii nocase
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        ($eleanor or ($tor and $hidden)) and any of ($php, $web, $shell)
}

rule MacOS_Mokes {
    meta:
        description = "Mokes backdoor"
        severity = "critical"
    strings:
        $qt = "Qt" ascii
        $screen = "QScreen" ascii
        $audio = "QAudioInput" ascii
        $keylog = "keyboard" ascii nocase
        $upload = "upload" ascii nocase
        $c2 = "api" ascii nocase
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        $qt and (any of ($screen, $audio)) and (any of ($keylog, $upload, $c2))
}

rule MacOS_Dummy {
    meta:
        description = "OSX.Dummy malware"
        severity = "high"
    strings:
        $discord = "discord" ascii nocase
        $slack = "slack" ascii nocase
        $crypto = "crypto" ascii nocase
        $sudo = "sudo" ascii
        $persist = "LaunchDaemons" ascii
        // UNUSED: $shell = "/bin/bash" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        (any of ($discord, $slack)) and $crypto and ($sudo or $persist)
}

rule MacOS_Persistence_LaunchAgent {
    meta:
        description = "LaunchAgent persistence"
        severity = "high"
    strings:
        $launch1 = "Library/LaunchAgents" ascii
        $launch2 = "Library/LaunchDaemons" ascii
        $plist = "<?xml" ascii
        $program = "ProgramArguments" ascii
        $label = "Label" ascii
        $run = "RunAtLoad" ascii
        $keep = "KeepAlive" ascii
    condition:
        (any of ($launch*)) and $plist and $label and ($program or $run or $keep)
}

rule MacOS_Persistence_LoginItems {
    meta:
        description = "Login Items persistence"
        severity = "medium"
    strings:
        $login = "loginwindow" ascii
        $items = "LoginItems" ascii
        $shared = "LSSharedFileList" ascii
        $auto = "AutoLaunchedApplication" ascii
        $helper = "com.apple.loginitem" ascii
    condition:
        (any of ($login, $items)) and (any of ($shared, $auto, $helper))
}

rule MacOS_Persistence_Cron {
    meta:
        description = "Cron job persistence"
        severity = "medium"
    strings:
        $cron1 = "/var/at/tabs" ascii
        $cron2 = "crontab" ascii
        $cron3 = "/etc/crontab" ascii
        $periodic = "/etc/periodic" ascii
        $curl = "curl" ascii
        $wget = "wget" ascii
        $bash = "/bin/bash" ascii
    condition:
        (any of ($cron*) or $periodic) and (any of ($curl, $wget) or $bash)
}

rule MacOS_Gatekeeper_Bypass {
    meta:
        description = "Gatekeeper bypass techniques"
        severity = "critical"
    strings:
        $xattr = "xattr" ascii
        $quarantine = "com.apple.quarantine" ascii
        $remove = "-d" ascii
        $spctl = "spctl" ascii
        $disable = "--master-disable" ascii
        $add = "--add" ascii
    condition:
        ($xattr and $quarantine and $remove) or ($spctl and any of ($disable, $add))
}

rule MacOS_SIP_Bypass {
    meta:
        description = "SIP bypass indicators"
        severity = "critical"
    strings:
        $csrutil = "csrutil" ascii
        $disable = "disable" ascii
        // UNUSED: $recovery = "Recovery" ascii
        $nvram = "nvram" ascii
        $csr = "csr-active-config" ascii
    condition:
        ($csrutil and $disable) or ($nvram and $csr)
}

rule MacOS_Keychain_Steal {
    meta:
        description = "Keychain credential theft"
        severity = "critical"
    strings:
        $security = "security" ascii
        $find = "find-generic-password" ascii
        $find2 = "find-internet-password" ascii
        $dump = "dump-keychain" ascii
        $keychain = "login.keychain" ascii
        $export = "export" ascii
    condition:
        $security and (any of ($find, $find2, $dump)) or ($keychain and $export)
}

rule MacOS_TCC_Bypass {
    meta:
        description = "TCC database bypass"
        severity = "critical"
    strings:
        $tcc = "TCC.db" ascii
        $sqlite = "sqlite" ascii
        $insert = "INSERT" ascii
        $kTCCService = "kTCCService" ascii
        $accessibility = "Accessibility" ascii
        $fda = "FullDiskAccess" ascii
    condition:
        $tcc and ($sqlite or $insert) and (any of ($kTCCService, $accessibility, $fda))
}

rule MacOS_Dylib_Hijack {
    meta:
        description = "Dylib hijacking"
        severity = "critical"
    strings:
        $dylib = ".dylib" ascii
        $rpath = "@rpath" ascii
        $loader = "@loader_path" ascii
        $exec = "@executable_path" ascii
        $weak = "LC_LOAD_WEAK_DYLIB" ascii
        $insert = "DYLD_INSERT_LIBRARIES" ascii
    condition:
        $dylib and (any of ($rpath, $loader, $exec, $weak) or $insert)
}

rule MacOS_Mach_Inject {
    meta:
        description = "Mach injection technique"
        severity = "critical"
    strings:
        $task = "task_for_pid" ascii
        $thread = "thread_create" ascii
        $thread2 = "thread_create_running" ascii
        $alloc = "mach_vm_allocate" ascii
        $write = "mach_vm_write" ascii
        $protect = "mach_vm_protect" ascii
    condition:
        (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF) and
        $task and (any of ($thread, $thread2)) and ($alloc or $write or $protect)
}

rule MacOS_AppleScript_Dropper {
    meta:
        description = "AppleScript dropper"
        severity = "high"
    strings:
        $osascript = "osascript" ascii
        $applescript = "AppleScript" ascii
        $do_shell = "do shell script" ascii
        $curl = "curl" ascii
        $wget = "wget" ascii
        $admin = "administrator privileges" ascii
    condition:
        (any of ($osascript, $applescript)) and $do_shell and (any of ($curl, $wget) or $admin)
}

