/*
    Shellcode and Exploit Detection Rules
    Detection of common shellcode patterns, exploits, and payloads
*/

rule Shellcode_x86_GetPC {
    meta:
        description = "x86 shellcode GetPC technique"
        severity = "critical"
    strings:
        $getpc1 = { E8 00 00 00 00 }
        $getpc2 = { EB ?? E8 }
        $getpc3 = { D9 EE D9 74 24 F4 }
    condition:
        any of them
}

rule Shellcode_x86_API_Resolution {
    meta:
        description = "Shellcode API resolution pattern"
        severity = "critical"
    strings:
        $hash1 = { 81 ?? ?? ?? ?? ?? 74 }
        $peb1 = { 64 8B ?? 30 }
        $peb2 = { 64 A1 30 00 00 00 }
        $ldr = { 8B ?? 0C 8B ?? 14 }
    condition:
        2 of them
}

rule Shellcode_x64_Common {
    meta:
        description = "x64 shellcode patterns"
        severity = "critical"
    strings:
        $gs1 = { 65 48 8B 04 25 60 00 00 00 }
        $gs2 = { 65 4C 8B 04 25 60 00 00 00 }
        $syscall = { 0F 05 }
        $hash_loop = { 48 8B ?? 48 ?? ?? 48 }
    condition:
        (any of ($gs*) and $syscall) or $hash_loop
}

rule Shellcode_Metasploit {
    meta:
        description = "Metasploit shellcode patterns"
        severity = "critical"
    strings:
        $msfv1 = { FC E8 }
        $msfv2 = { FC 48 83 E4 F0 }
        $msf_rc4 = { EB ?? 5? 4? 8? }
        $msf_tcp = { 6A 00 6A 01 6A 02 }
    condition:
        any of them
}

rule Shellcode_Cobalt_Strike {
    meta:
        description = "Cobalt Strike beacon shellcode"
        severity = "critical"
    strings:
        $cs1 = { FC E8 89 00 00 00 }
        $cs2 = { 4D 5A 41 52 55 48 89 E5 }
        $cs3 = "%s.%d.%s" ascii
        $cs4 = "beacon" ascii
    condition:
        any of ($cs1, $cs2) or ($cs3 and $cs4)
}

rule Exploit_Stack_Pivot {
    meta:
        description = "Stack pivoting (ROP chain)"
        severity = "high"
    strings:
        $pivot1 = { 94 C3 }
        $pivot2 = { 87 ?? C3 }
        $pivot3 = { FF ?? C3 }
        $rop_nop = { 58 C3 }
    condition:
        3 of them
}

rule Exploit_Heap_Spray {
    meta:
        description = "Heap spray pattern"
        severity = "high"
    strings:
        $nop_sled = { 90 90 90 90 90 90 90 90 }
        $spray1 = { 0C 0C 0C 0C 0C 0C 0C 0C }
        $spray2 = { 0D 0D 0D 0D 0D 0D 0D 0D }
        $spray3 = { 0A 0A 0A 0A 0A 0A 0A 0A }
    condition:
        (#nop_sled > 100) or (any of ($spray*) and #spray1 + #spray2 + #spray3 > 50)
}

rule Shellcode_Reverse_Shell {
    meta:
        description = "Reverse shell shellcode"
        severity = "critical"
    strings:
        $sock1 = { 6A 02 }
        $sock2 = "WSAStartup" ascii
        $sock3 = "connect" ascii
        $shell1 = "cmd.exe" ascii nocase
        $shell2 = "/bin/sh" ascii
        $dup2 = { B0 3F }
    condition:
        (any of ($sock*) and any of ($shell*)) or $dup2
}
