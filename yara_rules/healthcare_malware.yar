/*
   YARA Rules for Healthcare Sector Malware Detection

   This file contains rules for detecting:
   - Healthcare sector targeted malware
   - Medical device threats
   - Electronic Health Record (EHR) attacks
   - HIPAA data theft
   - Medical IoT malware

   These rules target threats specific to the healthcare industry
*/

rule Healthcare_Ransomware_Generic
{
    meta:
        description = "Detects ransomware targeting healthcare organizations"
        severity = "critical"
        category = "healthcare_ransomware"
        author = "MalwareAnalyzer"
        date = "2024-01-01"

    strings:
        $health1 = "hospital" ascii wide nocase
        $health2 = "medical" ascii wide nocase
        $health3 = "patient" ascii wide nocase
        $health4 = "healthcare" ascii wide nocase
        $ransom1 = "encrypted" ascii wide nocase
        $ransom2 = "bitcoin" ascii wide nocase
        $ransom3 = "decrypt" ascii wide nocase
        $ransom4 = "ransom" ascii wide nocase
        $ext1 = ".locky" ascii
        $ext2 = ".wannacry" ascii
        $ext3 = ".ryuk" ascii

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($health*) and 2 of ($ransom*)) or
        (1 of ($ext*) and 1 of ($health*))
}

rule Healthcare_EHR_Data_Stealer
{
    meta:
        description = "Detects malware targeting Electronic Health Records"
        severity = "critical"
        category = "healthcare_stealer"
        author = "MalwareAnalyzer"

    strings:
        $ehr1 = "Epic" ascii wide nocase
        $ehr2 = "Cerner" ascii wide nocase
        $ehr3 = "Meditech" ascii wide nocase
        $ehr4 = "Allscripts" ascii wide nocase
        $data1 = "PatientID" ascii wide nocase
        $data2 = "MRN" ascii wide
        $data3 = "diagnosis" ascii wide nocase
        $data4 = "prescription" ascii wide nocase
        $exfil1 = "POST" ascii
        $exfil2 = "upload" ascii nocase
        $exfil3 = "ftp" ascii nocase

    condition:
        (1 of ($ehr*) and 2 of ($data*) and 1 of ($exfil*)) or
        (3 of ($data*) and 1 of ($exfil*))
}

rule Healthcare_DICOM_Exploit
{
    meta:
        description = "Detects malware exploiting DICOM medical imaging protocol"
        severity = "high"
        category = "healthcare_exploit"
        author = "MalwareAnalyzer"

    strings:
        $dicom1 = "DICM" ascii
        $dicom2 = "DICOM" ascii wide
        $dicom3 = ".dcm" ascii wide
        $pacs1 = "PACS" ascii wide
        $pacs2 = "AETitle" ascii
        $exploit1 = { 00 00 00 04 00 01 00 00 }
        $overflow = { 41 41 41 41 41 41 41 41 }
        // UNUSED: $shell = { 6A 02 58 CD 80 }

    condition:
        (2 of ($dicom*) and 1 of ($pacs*)) or
        ($dicom1 at 128 and ($exploit1 or $overflow))
}

rule Healthcare_HL7_Manipulation
{
    meta:
        description = "Detects HL7 healthcare protocol manipulation"
        severity = "high"
        category = "healthcare_attack"
        author = "MalwareAnalyzer"

    strings:
        $hl7_1 = "MSH|" ascii
        $hl7_2 = "PID|" ascii
        $hl7_3 = "OBR|" ascii
        $hl7_4 = "OBX|" ascii
        $manipulate1 = "INSERT" ascii nocase
        $manipulate2 = "UPDATE" ascii nocase
        $manipulate3 = "DELETE" ascii nocase
        $inject = { 27 20 4F 52 20 }
        // UNUSED: $ssn = /\d{3}-\d{2}-\d{4}/ ascii

    condition:
        (2 of ($hl7_*) and 1 of ($manipulate*)) or
        (1 of ($hl7_*) and $inject)
}

rule Healthcare_Infusion_Pump_Attack
{
    meta:
        description = "Detects malware targeting infusion pump systems"
        severity = "critical"
        category = "medical_device"
        author = "MalwareAnalyzer"

    strings:
        $pump1 = "infusion" ascii wide nocase
        $pump2 = "Hospira" ascii wide
        $pump3 = "Baxter" ascii wide
        $pump4 = "B. Braun" ascii wide
        $dosage1 = "dosage" ascii wide nocase
        $dosage2 = "rate" ascii wide nocase
        $dosage3 = "volume" ascii wide nocase
        $exploit1 = "firmware" ascii nocase
        $exploit2 = "telnet" ascii nocase
        $change = "setDosage" ascii

    condition:
        (1 of ($pump*) and 2 of ($dosage*) and 1 of ($exploit*)) or
        ($change and 1 of ($pump*))
}

rule Healthcare_Pacemaker_Exploit
{
    meta:
        description = "Detects exploits targeting pacemaker systems"
        severity = "critical"
        category = "medical_device"
        author = "MalwareAnalyzer"

    strings:
        $pace1 = "pacemaker" ascii wide nocase
        $pace2 = "Medtronic" ascii wide
        $pace3 = "St. Jude" ascii wide
        $pace4 = "Abbott" ascii wide
        $cardiac1 = "cardiac" ascii wide nocase
        $cardiac2 = "ICD" ascii wide
        $attack1 = "rfcomm" ascii
        $attack2 = "bluetooth" ascii nocase
        $attack3 = "wireless" ascii nocase
        $cmd = { 02 00 00 00 }

    condition:
        (1 of ($pace*) and 1 of ($cardiac*) and 1 of ($attack*)) or
        (2 of ($pace*) and $cmd)
}

rule Healthcare_PHI_Exfiltration
{
    meta:
        description = "Detects Protected Health Information exfiltration"
        severity = "critical"
        category = "healthcare_stealer"
        author = "MalwareAnalyzer"

    strings:
        $phi1 = "SSN" ascii wide
        $phi2 = "DOB" ascii wide
        $phi3 = "insurance" ascii wide nocase
        $phi4 = "medical record" ascii wide nocase
        $phi5 = "health plan" ascii wide nocase
        $regex_ssn = /\d{3}[\s-]?\d{2}[\s-]?\d{4}/ ascii
        $regex_dob = /\d{2}\/\d{2}\/\d{4}/ ascii
        $exfil1 = "HttpClient" ascii
        $exfil2 = "WebClient" ascii
        $exfil3 = "smtp" ascii nocase

    condition:
        uint16(0) == 0x5A4D and
        (3 of ($phi*) and 1 of ($exfil*)) or
        (($regex_ssn or $regex_dob) and 2 of ($phi*))
}

rule Healthcare_Hospital_Network_Worm
{
    meta:
        description = "Detects worms targeting hospital networks"
        severity = "critical"
        category = "healthcare_worm"
        author = "MalwareAnalyzer"

    strings:
        $spread1 = "NetShareEnum" ascii
        $spread2 = "WNetOpenEnum" ascii
        $spread3 = "\\\\%s\\C$" ascii
        $target1 = "hospital" ascii nocase
        $target2 = "clinic" ascii nocase
        $target3 = "radiology" ascii nocase
        // UNUSED: $smb1 = "SMB" ascii
        // UNUSED: $smb2 = "IPC$" ascii
        $eternal = { FF 53 4D 42 72 00 00 00 00 }

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($spread*) and 1 of ($target*)) or
        ($eternal and 1 of ($target*))
}

rule Healthcare_Medical_IoT_Botnet
{
    meta:
        description = "Detects botnet malware targeting medical IoT devices"
        severity = "high"
        category = "medical_iot"
        author = "MalwareAnalyzer"

    strings:
        $iot1 = "telnet" ascii
        $iot2 = "admin:admin" ascii
        $iot3 = "root:root" ascii
        $med1 = "medical" ascii nocase
        $med2 = "philips" ascii nocase
        $med3 = "GE Healthcare" ascii nocase
        $bot1 = "/bin/busybox" ascii
        $bot2 = ".x86_64" ascii
        $bot3 = ".arm" ascii
        $cnc = "report" ascii

    condition:
        (2 of ($iot*) and 1 of ($med*)) or
        (1 of ($bot*) and 1 of ($med*) and $cnc)
}

rule Healthcare_Drug_Database_Attack
{
    meta:
        description = "Detects attacks on pharmaceutical databases"
        severity = "high"
        category = "healthcare_attack"
        author = "MalwareAnalyzer"

    strings:
        $drug1 = "pharmacy" ascii wide nocase
        $drug2 = "prescription" ascii wide nocase
        $drug3 = "controlled substance" ascii wide nocase
        $drug4 = "DEA" ascii wide
        $db1 = "SELECT" ascii nocase
        $db2 = "INSERT INTO" ascii nocase
        $db3 = "DROP TABLE" ascii nocase
        $pdmp = "PDMP" ascii wide
        // UNUSED: $narcotic = "narcotic" ascii wide nocase

    condition:
        (2 of ($drug*) and 1 of ($db*)) or
        ($pdmp and 1 of ($db*))
}

rule Healthcare_Medical_Imaging_Malware
{
    meta:
        description = "Detects malware embedded in medical images"
        severity = "high"
        category = "healthcare_malware"
        author = "MalwareAnalyzer"

    strings:
        $img1 = "DICM" ascii
        $img2 = { FF D8 FF E0 }
        $img3 = { 89 50 4E 47 0D 0A 1A 0A }
        $exe = { 4D 5A 90 00 }
        $script1 = "<script" ascii nocase
        $script2 = "powershell" ascii nocase
        $hidden = { 00 00 00 00 4D 5A }

    condition:
        ($img1 at 128 or $img2 at 0 or $img3 at 0) and
        ($exe or 1 of ($script*) or $hidden)
}

rule Healthcare_Insurance_Fraud_Tool
{
    meta:
        description = "Detects healthcare insurance fraud tools"
        severity = "medium"
        category = "healthcare_fraud"
        author = "MalwareAnalyzer"

    strings:
        $ins1 = "insurance" ascii wide nocase
        $ins2 = "claim" ascii wide nocase
        $ins3 = "billing" ascii wide nocase
        $ins4 = "medicare" ascii wide nocase
        $code1 = "ICD-10" ascii wide
        $code2 = "CPT" ascii wide
        $code3 = "HCPCS" ascii wide
        $fraud1 = "upcoding" ascii wide nocase
        $fraud2 = "phantom" ascii wide nocase
        $fraud3 = "unbundling" ascii wide nocase

    condition:
        (2 of ($ins*) and 1 of ($code*) and 1 of ($fraud*)) or
        (3 of ($ins*) and 2 of ($code*))
}

rule Healthcare_Telemedicine_Hijack
{
    meta:
        description = "Detects telemedicine session hijacking malware"
        severity = "high"
        category = "healthcare_hijack"
        author = "MalwareAnalyzer"

    strings:
        $tele1 = "telemedicine" ascii wide nocase
        $tele2 = "telehealth" ascii wide nocase
        $tele3 = "video consult" ascii wide nocase
        $hijack1 = "WebRTC" ascii
        $hijack2 = "getUserMedia" ascii
        $hijack3 = "RTCPeerConnection" ascii
        $record1 = "MediaRecorder" ascii
        $record2 = "captureStream" ascii
        $exfil = "upload" ascii nocase

    condition:
        (1 of ($tele*) and 2 of ($hijack*) and 1 of ($record*)) or
        (1 of ($tele*) and all of ($record*) and $exfil)
}

rule Healthcare_Lab_System_Attack
{
    meta:
        description = "Detects attacks on laboratory information systems"
        severity = "high"
        category = "healthcare_attack"
        author = "MalwareAnalyzer"

    strings:
        $lab1 = "laboratory" ascii wide nocase
        $lab2 = "LIS" ascii wide
        $lab3 = "LIMS" ascii wide
        $lab4 = "pathology" ascii wide nocase
        $result1 = "test result" ascii wide nocase
        $result2 = "specimen" ascii wide nocase
        $result3 = "culture" ascii wide nocase
        $tamper1 = "modify" ascii wide nocase
        $tamper2 = "alter" ascii wide nocase
        $tamper3 = "change" ascii wide nocase

    condition:
        (2 of ($lab*) and 1 of ($result*) and 1 of ($tamper*))
}

rule Healthcare_Ventilator_Exploit
{
    meta:
        description = "Detects exploits targeting ventilator systems"
        severity = "critical"
        category = "medical_device"
        author = "MalwareAnalyzer"

    strings:
        $vent1 = "ventilator" ascii wide nocase
        $vent2 = "respirator" ascii wide nocase
        $vent3 = "Puritan Bennett" ascii wide
        $vent4 = "Drager" ascii wide
        $param1 = "tidal volume" ascii wide nocase
        $param2 = "PEEP" ascii wide
        $param3 = "FiO2" ascii wide
        $attack1 = "overflow" ascii nocase
        $attack2 = "firmware" ascii nocase

    condition:
        (1 of ($vent*) and 1 of ($param*) and 1 of ($attack*))
}

rule Healthcare_Ambulance_System_Attack
{
    meta:
        description = "Detects attacks on ambulance dispatch systems"
        severity = "critical"
        category = "healthcare_attack"
        author = "MalwareAnalyzer"

    strings:
        $ems1 = "ambulance" ascii wide nocase
        $ems2 = "EMS" ascii wide
        $ems3 = "dispatch" ascii wide nocase
        $ems4 = "911" ascii wide
        $cad1 = "CAD" ascii wide
        $cad2 = "computer aided dispatch" ascii wide nocase
        $gps1 = "GPS" ascii wide
        $gps2 = "location" ascii wide nocase
        $disrupt = "denial" ascii nocase

    condition:
        (2 of ($ems*) and 1 of ($cad*)) or
        (1 of ($ems*) and 1 of ($gps*) and $disrupt)
}

rule Healthcare_Clinical_Trial_Theft
{
    meta:
        description = "Detects clinical trial data theft malware"
        severity = "high"
        category = "healthcare_espionage"
        author = "MalwareAnalyzer"

    strings:
        $trial1 = "clinical trial" ascii wide nocase
        $trial2 = "FDA" ascii wide
        $trial3 = "Phase III" ascii wide nocase
        $trial4 = "protocol" ascii wide nocase
        $data1 = "efficacy" ascii wide nocase
        $data2 = "adverse event" ascii wide nocase
        $data3 = "placebo" ascii wide nocase
        $steal1 = "exfiltrate" ascii nocase
        $steal2 = "compress" ascii nocase
        $steal3 = "encrypt" ascii nocase

    condition:
        (2 of ($trial*) and 2 of ($data*) and 1 of ($steal*))
}

rule Healthcare_Blood_Bank_Attack
{
    meta:
        description = "Detects attacks on blood bank systems"
        severity = "critical"
        category = "healthcare_attack"
        author = "MalwareAnalyzer"

    strings:
        $blood1 = "blood bank" ascii wide nocase
        $blood2 = "transfusion" ascii wide nocase
        $blood3 = "blood type" ascii wide nocase
        $blood4 = "cross-match" ascii wide nocase
        $type1 = "A+" ascii wide
        $type2 = "B+" ascii wide
        $type3 = "O-" ascii wide
        $tamper1 = "mismatch" ascii nocase
        $tamper2 = "modify" ascii nocase

    condition:
        (2 of ($blood*) and 1 of ($type*) and 1 of ($tamper*))
}

rule Healthcare_Radiation_System_Attack
{
    meta:
        description = "Detects attacks on radiation therapy systems"
        severity = "critical"
        category = "medical_device"
        author = "MalwareAnalyzer"

    strings:
        $rad1 = "radiation" ascii wide nocase
        $rad2 = "linear accelerator" ascii wide nocase
        $rad3 = "LINAC" ascii wide
        $rad4 = "radiotherapy" ascii wide nocase
        $vendor1 = "Varian" ascii wide
        $vendor2 = "Elekta" ascii wide
        $dose1 = "dose" ascii wide nocase
        $dose2 = "Gray" ascii wide
        $dose3 = "Gy" ascii wide
        $exploit = "overflow" ascii

    condition:
        (2 of ($rad*) and 1 of ($dose*) and $exploit) or
        (1 of ($vendor*) and 1 of ($dose*) and $exploit)
}

rule Healthcare_Surgery_Robot_Attack
{
    meta:
        description = "Detects attacks on surgical robot systems"
        severity = "critical"
        category = "medical_device"
        author = "MalwareAnalyzer"

    strings:
        $robot1 = "da Vinci" ascii wide
        $robot2 = "surgical robot" ascii wide nocase
        $robot3 = "robotic surgery" ascii wide nocase
        $robot4 = "Intuitive Surgical" ascii wide
        $control1 = "motion control" ascii wide nocase
        $control2 = "teleoperation" ascii wide nocase
        $control3 = "haptic" ascii wide nocase
        $attack1 = "inject" ascii nocase
        $attack2 = "intercept" ascii nocase

    condition:
        (1 of ($robot*) and 1 of ($control*) and 1 of ($attack*))
}
