/*
    Linux and macOS Malware Detection Rules
*/

rule Linux_Backdoor_Generic {
    meta:
        description = "Generic Linux backdoor"
        severity = "critical"
    strings:
        $shell1 = "/bin/sh" ascii
        $shell2 = "/bin/bash" ascii
        $net1 = "socket" ascii
        $net2 = "connect" ascii
        $net3 = "bind" ascii
        $exec = "execve" ascii
    condition:
        any of ($shell*) and any of ($net*) and $exec
}

rule Linux_ELF_Miner {
    meta:
        description = "Linux ELF cryptominer"
        severity = "high"
    strings:
        $elf = {7F 45 4C 46}
        $s1 = "stratum" ascii
        $s2 = "xmrig" nocase
        $s3 = "cryptonight" ascii
        $pool = "pool." ascii
    condition:
        $elf at 0 and (any of ($s*) or $pool)
}

rule Linux_Mirai_Bot {
    meta:
        description = "Linux Mirai botnet"
        severity = "critical"
    strings:
        $elf = {7F 45 4C 46}
        $s1 = "/bin/busybox" ascii
        $s2 = "SCANNER" ascii
        $s3 = "killer" ascii
        // UNUSED: $telnet = "telnet" ascii
    condition:
        $elf at 0 and 2 of ($s*)
}

rule Linux_XOR_DDoS {
    meta:
        description = "Linux XOR.DDoS botnet"
        severity = "critical"
    strings:
        $elf = {7F 45 4C 46}
        $s1 = "XOR.DDoS" ascii
        $s2 = "main_dns_p" ascii
        $xor = {31 ?? 83 ?? ?? 75}
    condition:
        $elf at 0 and (any of ($s*) or $xor)
}

rule Linux_Tsunami_Bot {
    meta:
        description = "Linux Tsunami/Kaiten IRC bot"
        severity = "critical"
    strings:
        $elf = {7F 45 4C 46}
        $s1 = "tsunami" nocase
        $s2 = "kaiten" nocase
        $irc = "PRIVMSG" ascii
    condition:
        $elf at 0 and (any of ($s*) or $irc)
}

rule Linux_Shellcode {
    meta:
        description = "Linux shellcode"
        severity = "critical"
    strings:
        $syscall = {CD 80}
        $syscall2 = {0F 05}
        $shell = "/bin/sh" ascii
        $exec = {31 C0 50 68 2F 2F 73 68}
    condition:
        (any of ($syscall*) and $shell) or $exec
}

rule Linux_Rootkit {
    meta:
        description = "Linux kernel rootkit"
        severity = "critical"
    strings:
        $s1 = "sys_call_table" ascii
        $s2 = "hide_pid" ascii
        $s3 = "module_init" ascii
        $s4 = "proc_root_readdir" ascii
    condition:
        2 of them
}

rule Linux_LD_Preload_Hook {
    meta:
        description = "LD_PRELOAD hooking"
        severity = "critical"
    strings:
        $s1 = "ld.so.preload" ascii
        $s2 = "LD_PRELOAD" ascii
        $s3 = "dlsym" ascii
        $hook = "RTLD_NEXT" ascii
    condition:
        2 of ($s*) or $hook
}

rule Linux_Reverse_Shell {
    meta:
        description = "Linux reverse shell"
        severity = "critical"
    strings:
        $shell1 = "/bin/sh" ascii
        $shell2 = "/bin/bash" ascii
        $dup = "dup2" ascii
        $sock = "socket" ascii
        $connect = "connect" ascii
    condition:
        any of ($shell*) and $dup and ($sock or $connect)
}

rule Linux_SSH_Backdoor {
    meta:
        description = "Linux SSH backdoor"
        severity = "critical"
    strings:
        $s1 = "sshd" ascii
        $s2 = "authorized_keys" ascii
        $s3 = "id_rsa" ascii
        $backdoor = "backdoor" nocase
    condition:
        2 of ($s*) or $backdoor
}

rule macOS_Backdoor_Generic {
    meta:
        description = "Generic macOS backdoor"
        severity = "critical"
    strings:
        $macho = {CF FA ED FE}
        $shell = "/bin/bash" ascii
        $exec = "NSTask" ascii
        $net = "NSURLConnection" ascii
    condition:
        $macho at 0 and any of ($shell, $exec, $net)
}

rule macOS_Shlayer {
    meta:
        description = "macOS Shlayer adware"
        severity = "high"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "shlayer" nocase
        $s2 = "flashplayer" nocase
        $s3 = "install" ascii
        $dmg = ".dmg" ascii
    condition:
        $macho at 0 and (any of ($s*) or $dmg)
}

rule macOS_XCSSET {
    meta:
        description = "macOS XCSSET malware"
        severity = "critical"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "XCSSET" ascii
        $s2 = "xcsset" ascii
        $xcode = "Xcode" ascii
    condition:
        $macho at 0 and (any of ($s*) or $xcode)
}

rule macOS_Bundlore {
    meta:
        description = "macOS Bundlore adware"
        severity = "high"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "bundlore" nocase
        $s2 = "Bundlore" ascii
        // UNUSED: $installer = "installer" ascii
    condition:
        $macho at 0 and any of ($s*)
}

rule macOS_OSX_Dok {
    meta:
        description = "macOS OSX/Dok malware"
        severity = "critical"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "DOK" ascii
        $proxy = "proxy" ascii
        $mitm = "tor" nocase
    condition:
        $macho at 0 and (any of ($s*) or ($proxy and $mitm))
}

rule macOS_Lazarus_Loader {
    meta:
        description = "Lazarus Group macOS loader"
        severity = "critical"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "AppleJeus" ascii
        $s2 = "Union Crypto" ascii
        $s3 = "celas" ascii
    condition:
        $macho at 0 and any of ($s*)
}

rule macOS_Silver_Sparrow {
    meta:
        description = "macOS Silver Sparrow"
        severity = "critical"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "silver" nocase
        $s2 = "sparrow" nocase
        $aws = "amazonaws" ascii
    condition:
        $macho at 0 and (any of ($s*) or $aws)
}

rule macOS_Launch_Agent_Persistence {
    meta:
        description = "macOS LaunchAgent persistence"
        severity = "high"
    strings:
        $plist = "<?xml" ascii
        $s1 = "LaunchAgents" ascii
        $s2 = "LaunchDaemons" ascii
        $s3 = "ProgramArguments" ascii
        $run = "RunAtLoad" ascii
    condition:
        $plist and any of ($s*) and $run
}

rule macOS_Keychain_Access {
    meta:
        description = "macOS Keychain access"
        severity = "high"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "SecKeychainFindGenericPassword" ascii
        $s2 = "SecKeychainFindInternetPassword" ascii
        $s3 = "SecItemCopyMatching" ascii
    condition:
        $macho at 0 and any of ($s*)
}

rule macOS_Screen_Capture {
    meta:
        description = "macOS screen capture"
        severity = "medium"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "CGWindowListCreateImage" ascii
        $s2 = "CGDisplayCreateImage" ascii
        $s3 = "screencapture" ascii
    condition:
        $macho at 0 and any of ($s*)
}

rule macOS_Webcam_Access {
    meta:
        description = "macOS webcam access"
        severity = "medium"
    strings:
        $macho = {CF FA ED FE}
        $s1 = "AVCaptureDevice" ascii
        $s2 = "QTCaptureDevice" ascii
        $s3 = "AVFoundation" ascii
    condition:
        $macho at 0 and any of ($s*)
}

rule Android_Malware_Generic {
    meta:
        description = "Generic Android malware indicators"
        severity = "high"
    strings:
        $dex = "classes.dex" ascii
        $s1 = "android.permission.READ_SMS" ascii
        $s2 = "android.permission.SEND_SMS" ascii
        $s3 = "android.permission.RECORD_AUDIO" ascii
        $s4 = "android.permission.READ_CONTACTS" ascii
        $s5 = "getDeviceId" ascii
    condition:
        $dex and 2 of ($s*)
}

rule Android_Banking_Trojan {
    meta:
        description = "Android banking trojan indicators"
        severity = "critical"
    strings:
        $dex = "classes.dex" ascii
        $s1 = "accessibility" ascii
        $s2 = "overlay" ascii
        $s3 = "inject" ascii
        $s4 = "bank" nocase
        $api = "getRunningTasks" ascii
    condition:
        $dex and 2 of ($s*) or ($dex and $api)
}

rule Android_Spyware {
    meta:
        description = "Android spyware indicators"
        severity = "critical"
    strings:
        $dex = "classes.dex" ascii
        $s1 = "getLastKnownLocation" ascii
        $s2 = "TelephonyManager" ascii
        $s3 = "SmsMessage" ascii
        $s4 = "CallLog" ascii
        $s5 = "ContactsContract" ascii
    condition:
        $dex and 3 of ($s*)
}
