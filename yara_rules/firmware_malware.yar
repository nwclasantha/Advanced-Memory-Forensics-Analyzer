/*
   YARA Rules for Firmware Malware Detection

   This file contains rules for detecting:
   - BIOS/UEFI firmware threats
   - Embedded device malware
   - Bootkit components
   - Firmware implants
   - Low-level persistent threats

   These rules target firmware-level attacks that persist below the OS
*/

rule Firmware_UEFI_Bootkit_Generic
{
    meta:
        description = "Detects generic UEFI bootkit characteristics"
        severity = "critical"
        category = "firmware"
        author = "MalwareAnalyzer"
        date = "2024-01-01"

    strings:
        $uefi1 = "EFI_BOOT_SERVICES" ascii wide
        $uefi2 = "EFI_RUNTIME_SERVICES" ascii wide
        $uefi3 = "EFI_SYSTEM_TABLE" ascii wide
        $hook1 = "SetVariable" ascii wide
        $hook2 = "GetVariable" ascii wide
        $hook3 = "ExitBootServices" ascii wide
        $suspicious1 = "gBS->" ascii
        $suspicious2 = "gRT->" ascii
        $patch1 = { 48 89 ?? ?? ?? 48 8B ?? ?? ?? FF 15 }
        $patch2 = { 4C 8D 05 ?? ?? ?? ?? 48 8D 15 }

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($uefi*) and 2 of ($hook*)) or
        (all of ($suspicious*) and 1 of ($patch*))
}

rule Firmware_MosaicRegressor_Variant
{
    meta:
        description = "Detects MosaicRegressor UEFI bootkit variants"
        severity = "critical"
        category = "firmware_apt"
        author = "MalwareAnalyzer"

    strings:
        $s1 = "IntelUpdate" ascii wide
        $s2 = "SecureBoot" ascii wide
        $s3 = "\\EFI\\Microsoft\\Boot\\bootmgfw.efi" ascii wide
        $code1 = { 48 83 EC 28 48 8B 05 ?? ?? ?? ?? 48 85 C0 }
        $code2 = { 41 B8 00 10 00 00 48 8D 15 }
        $persist = "HKLM\\SYSTEM\\CurrentControlSet\\Control" ascii wide

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($s*) and 1 of ($code*)) or
        (all of ($s*) and $persist)
}

rule Firmware_LoJax_Implant
{
    meta:
        description = "Detects LoJax UEFI rootkit components"
        severity = "critical"
        category = "firmware_apt"
        author = "MalwareAnalyzer"
        reference = "APT28/Sednit related"

    strings:
        $lojax1 = "rpcnetp.exe" ascii wide nocase
        $lojax2 = "autoche.exe" ascii wide nocase
        $lojax3 = "ReWriter_read" ascii
        $lojax4 = "ReWriter_write" ascii
        $spi1 = "SpiFlash" ascii
        $spi2 = { 0F 32 48 C1 E2 20 48 0B C2 }
        $driver = "SmmAccessDxe" ascii wide

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($lojax*) or (1 of ($spi*) and $driver))
}

rule Firmware_ThinkPwn_Exploit
{
    meta:
        description = "Detects ThinkPwn UEFI vulnerability exploit"
        severity = "high"
        category = "firmware_exploit"
        author = "MalwareAnalyzer"

    strings:
        $think1 = "SystemSmmRuntimeRt" ascii wide
        $think2 = "SmmRuntime" ascii wide
        $smm1 = "SW_SMI_" ascii
        $smm2 = { B0 ?? E6 B2 E6 B3 }
        $vuln = "LenovoFlashDeviceInterface" ascii wide

    condition:
        (2 of ($think*) and 1 of ($smm*)) or $vuln
}

rule Firmware_HackingTeam_UEFI
{
    meta:
        description = "Detects HackingTeam UEFI persistence module"
        severity = "critical"
        category = "firmware_apt"
        author = "MalwareAnalyzer"

    strings:
        $ht1 = "scout.exe" ascii wide
        $ht2 = "soldier.exe" ascii wide
        $ht3 = "ntfs.mod" ascii
        $uefi1 = "InsydeFlash" ascii wide
        $uefi2 = "SystemFirmwareUpdate" ascii wide
        $persist = { 48 8D 0D ?? ?? ?? ?? 48 89 0D ?? ?? ?? ?? }

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($ht*) or (1 of ($uefi*) and $persist))
}

rule Firmware_SPI_Flash_Manipulator
{
    meta:
        description = "Detects SPI flash manipulation tools"
        severity = "high"
        category = "firmware_tool"
        author = "MalwareAnalyzer"

    strings:
        $spi1 = "SpiRead" ascii wide
        $spi2 = "SpiWrite" ascii wide
        $spi3 = "SpiErase" ascii wide
        $flash1 = "FlashRegion" ascii
        $flash2 = "BIOS_CNTL" ascii
        $flash3 = "FLOCKDN" ascii
        $cmd1 = "flashrom" ascii
        $cmd2 = "biosflash" ascii

    condition:
        (2 of ($spi*) and 1 of ($flash*)) or
        (all of ($spi*)) or
        (2 of ($cmd*))
}

rule Firmware_Embedded_IoT_Backdoor
{
    meta:
        description = "Detects backdoors in embedded/IoT device firmware"
        severity = "critical"
        category = "embedded_malware"
        author = "MalwareAnalyzer"

    strings:
        $shell1 = "/bin/sh" ascii
        $shell2 = "/bin/bash" ascii
        // UNUSED: $telnet = "telnetd" ascii
        $backdoor1 = "BACKDOOR" ascii nocase
        $backdoor2 = "rootshell" ascii nocase
        $cred1 = "admin:admin" ascii
        $cred2 = "root:root" ascii
        $cred3 = "default_password" ascii
        $busybox = "BusyBox" ascii
        $embedded = { 7F 45 4C 46 01 01 01 }

    condition:
        $embedded at 0 and
        ((1 of ($shell*) and 1 of ($backdoor*)) or
        (2 of ($cred*) and $busybox))
}

rule Firmware_VPNFilter_Stage1
{
    meta:
        description = "Detects VPNFilter malware Stage 1 components"
        severity = "critical"
        category = "embedded_malware"
        author = "MalwareAnalyzer"
        reference = "Router/NAS firmware malware"

    strings:
        $vpn1 = "/var/run/vpnfilter" ascii
        $vpn2 = "photobucket.com" ascii
        $vpn3 = "toknowall.com" ascii
        $stage = "stage2" ascii
        $persist = "/dev/mtdblock" ascii
        $tor = ".onion" ascii

    condition:
        (2 of ($vpn*) and $stage) or
        ($persist and $tor and 1 of ($vpn*))
}

rule Firmware_Router_Implant_Generic
{
    meta:
        description = "Detects generic router firmware implants"
        severity = "high"
        category = "embedded_malware"
        author = "MalwareAnalyzer"

    strings:
        $nvram1 = "nvram_get" ascii
        $nvram2 = "nvram_set" ascii
        $cfg1 = "/tmp/etc/config" ascii
        $cfg2 = "/etc/passwd" ascii
        $mal1 = "wget http" ascii
        $mal2 = "curl http" ascii
        $mal3 = "tftp" ascii
        $reverse = { 6A 66 58 6A 01 5F 6A 02 5E 0F 05 }

    condition:
        (2 of ($nvram*) and 2 of ($mal*)) or
        ($reverse and 1 of ($cfg*))
}

rule Firmware_BIOS_Rootkit_Mebromi
{
    meta:
        description = "Detects Mebromi BIOS rootkit indicators"
        severity = "critical"
        category = "firmware_rootkit"
        author = "MalwareAnalyzer"

    strings:
        $meb1 = "hook.rom" ascii
        $meb2 = "flash.dll" ascii
        $meb3 = "cbrom" ascii
        $bios1 = "Award Modular BIOS" ascii wide
        $bios2 = "AMIBIOS" ascii wide
        $patch1 = { B8 ?? ?? CD 13 72 }

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($meb*) or (1 of ($bios*) and $patch1))
}

rule Firmware_ESP_Partition_Tampering
{
    meta:
        description = "Detects EFI System Partition tampering tools"
        severity = "high"
        category = "firmware_tool"
        author = "MalwareAnalyzer"

    strings:
        $esp1 = "mountvol" ascii wide nocase
        $esp2 = "\\EFI\\Boot\\bootx64.efi" ascii wide
        $esp3 = "\\EFI\\Microsoft\\Boot" ascii wide
        $tamper1 = "bcdedit" ascii wide
        $tamper2 = "bootrec" ascii wide
        $write1 = "WriteFile" ascii
        $write2 = "CreateFile" ascii
        $suspicious = "UEFI_VARS" ascii wide

    condition:
        (2 of ($esp*) and 1 of ($tamper*) and 1 of ($write*)) or
        ($suspicious and 2 of ($esp*))
}

rule Firmware_Computrace_Abuse
{
    meta:
        description = "Detects Computrace/LoJack abuse and tampering"
        severity = "medium"
        category = "firmware_abuse"
        author = "MalwareAnalyzer"

    strings:
        $comp1 = "rpcnetp" ascii wide
        $comp2 = "rpcnet" ascii wide
        $comp3 = "ComputraceLojack" ascii wide
        $abs1 = "Absolute Software" ascii wide
        $abs2 = "search.namequery.com" ascii
        $mod1 = "autochk.exe" ascii wide
        $mod2 = { E8 ?? ?? ?? ?? 85 C0 74 ?? 8B }

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($comp*) and 1 of ($mod*)) or
        ($abs1 and $abs2)
}

rule Firmware_DXE_Driver_Implant
{
    meta:
        description = "Detects malicious DXE driver implants"
        severity = "critical"
        category = "firmware_implant"
        author = "MalwareAnalyzer"

    strings:
        $dxe1 = "DXE_DRIVER" ascii wide
        $dxe2 = "EFI_IMAGE_ENTRY_POINT" ascii
        $dxe3 = "gEfiDxeServicesTableGuid" ascii
        $hook1 = "InstallProtocolInterface" ascii
        $hook2 = "LocateProtocol" ascii
        $sus1 = "SmmCommunicate" ascii
        $sus2 = { 48 8B 05 ?? ?? ?? ?? 48 89 44 24 ?? 48 8D 44 24 }

    condition:
        (2 of ($dxe*) and 1 of ($hook*) and 1 of ($sus*))
}

rule Firmware_BMC_Implant
{
    meta:
        description = "Detects Baseboard Management Controller implants"
        severity = "critical"
        category = "firmware_implant"
        author = "MalwareAnalyzer"

    strings:
        $bmc1 = "IPMI" ascii wide
        $bmc2 = "ipmitool" ascii
        $bmc3 = "BMC_FIRMWARE" ascii
        $cmd1 = "raw 0x" ascii
        $cmd2 = "mc reset" ascii
        $shell = { 2F 62 69 6E 2F 73 68 00 }
        $persistence = "/conf/persist" ascii

    condition:
        (2 of ($bmc*) and 1 of ($cmd*)) or
        ($shell and $persistence and 1 of ($bmc*))
}

rule Firmware_ME_Exploit
{
    meta:
        description = "Detects Intel Management Engine exploitation"
        severity = "critical"
        category = "firmware_exploit"
        author = "MalwareAnalyzer"

    strings:
        $me1 = "Intel ME" ascii wide
        $me2 = "HECI" ascii
        $me3 = "MEI_DRIVER" ascii wide
        $exploit1 = "CVE-2017-5689" ascii
        $exploit2 = "INTEL-SA-00075" ascii
        $vuln1 = "amt_check" ascii
        $vuln2 = "mei_connect" ascii
        // UNUSED: $code1 = { 48 8D 0D ?? ?? ?? ?? E8 ?? ?? ?? ?? 48 85 C0 74 }

    condition:
        (2 of ($me*) and 1 of ($exploit*)) or
        (2 of ($me*) and 2 of ($vuln*))
}

rule Firmware_UEFI_Ransomware
{
    meta:
        description = "Detects UEFI-level ransomware components"
        severity = "critical"
        category = "firmware_ransomware"
        author = "MalwareAnalyzer"

    strings:
        $ransom1 = "Your files have been encrypted" ascii wide nocase
        $ransom2 = "bitcoin" ascii wide nocase
        $ransom3 = "decrypt" ascii wide nocase
        $uefi1 = "\\EFI\\" ascii wide
        $uefi2 = "bootmgfw" ascii wide
        $mbr1 = { 33 C0 8E D0 BC 00 7C }
        $mbr2 = { FA 33 C0 8E D0 BC 00 7C 8B F4 }
        $overwrite = "WriteBootSector" ascii

    condition:
        (2 of ($ransom*) and 1 of ($uefi*)) or
        (1 of ($mbr*) and $overwrite)
}

rule Firmware_Camera_DVR_Malware
{
    meta:
        description = "Detects IP camera and DVR firmware malware"
        severity = "high"
        category = "embedded_malware"
        author = "MalwareAnalyzer"

    strings:
        $cam1 = "Dahua" ascii wide
        $cam2 = "Hikvision" ascii wide
        $cam3 = "RTSP" ascii
        $mal1 = "/dev/watchdog" ascii
        $mal2 = "mirai" ascii nocase
        $mal3 = "hajime" ascii nocase
        $cred1 = "888888" ascii
        $cred2 = "666666" ascii
        $shell = "/bin/busybox" ascii

    condition:
        (1 of ($cam*) and 1 of ($mal*)) or
        (2 of ($cred*) and $shell)
}

rule Firmware_PLC_Implant
{
    meta:
        description = "Detects PLC firmware implants and modifications"
        severity = "critical"
        category = "ics_firmware"
        author = "MalwareAnalyzer"

    strings:
        $plc1 = "S7-300" ascii wide
        $plc2 = "S7-400" ascii wide
        $plc3 = "Modbus" ascii wide
        $proto1 = "PROFINET" ascii
        $proto2 = "PROFIBUS" ascii
        $mal1 = "OB1_CALL" ascii
        $mal2 = "STL_CODE" ascii
        $patch = { 6E 01 12 0A 10 02 00 }

    condition:
        (2 of ($plc*) or 1 of ($proto*)) and
        (1 of ($mal*) or $patch)
}

rule Firmware_Network_Switch_Backdoor
{
    meta:
        description = "Detects network switch firmware backdoors"
        severity = "critical"
        category = "embedded_malware"
        author = "MalwareAnalyzer"

    strings:
        $switch1 = "Cisco IOS" ascii wide
        $switch2 = "Juniper" ascii wide
        $switch3 = "FortiOS" ascii wide
        $back1 = "synful" ascii nocase
        $back2 = "SYNful" ascii
        $shell1 = "enable secret" ascii
        $shell2 = "privilege 15" ascii
        $implant = { 48 8D 15 ?? ?? ?? ?? 48 89 D7 E8 }

    condition:
        (1 of ($switch*) and 1 of ($back*)) or
        (2 of ($shell*) and $implant)
}

rule Firmware_Smart_Device_Compromise
{
    meta:
        description = "Detects compromised smart device firmware"
        severity = "medium"
        category = "iot_malware"
        author = "MalwareAnalyzer"

    strings:
        $smart1 = "SmartThings" ascii wide
        $smart2 = "Zigbee" ascii
        $smart3 = "Z-Wave" ascii
        $mqtt = "MQTT" ascii
        $coap = "CoAP" ascii
        $mal1 = "reverse_shell" ascii
        $mal2 = "exfiltrate" ascii
        $creds = { 75 73 65 72 3A 70 61 73 73 }

    condition:
        (2 of ($smart*) or ($mqtt and $coap)) and
        (1 of ($mal*) or $creds)
}
