/*
   YARA Rules for Financial Sector Malware Detection

   This file contains rules for detecting:
   - Financial sector specific threats
   - SWIFT network attacks
   - Banking trojans targeting financial institutions
   - ATM malware
   - Trading platform attacks

   These rules target threats specific to the financial industry
*/

rule Financial_SWIFT_Attack
{
    meta:
        description = "Detects SWIFT network attack malware"
        severity = "critical"
        category = "financial_swift"
        author = "MalwareAnalyzer"
        date = "2024-01-01"

    strings:
        $swift1 = "SWIFT" ascii wide
        $swift2 = "Alliance Lite" ascii wide
        $swift3 = "FIN message" ascii wide nocase
        $swift4 = "MT103" ascii wide
        $swift5 = "MT202" ascii wide
        $attack1 = "liboradb.dll" ascii wide
        $attack2 = "msoutc.exe" ascii wide
        $attack3 = "evtsys.exe" ascii wide
        $sql1 = "gpca.dat" ascii
        $sql2 = "SELECT" ascii

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($swift*) and 1 of ($attack*)) or
        (3 of ($swift*) and 1 of ($sql*))
}

rule Financial_Bangladesh_Bank_Variant
{
    meta:
        description = "Detects Bangladesh Bank heist related malware"
        severity = "critical"
        category = "financial_apt"
        author = "MalwareAnalyzer"

    strings:
        $lazarus1 = "bitsran.exe" ascii
        $lazarus2 = "MSOUTC.exe" ascii
        $lazarus3 = "evtdiag.exe" ascii
        $swift1 = "SWIFT Alliance" ascii wide
        $swift2 = "MESG_SENDER" ascii
        $swift3 = "ftp_data" ascii
        $db1 = "oracle" ascii nocase
        $db2 = "oradb" ascii

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($lazarus*) and 1 of ($swift*)) or
        (2 of ($swift*) and 1 of ($db*))
}

rule Financial_ATM_Jackpotting
{
    meta:
        description = "Detects ATM jackpotting/cash-out malware"
        severity = "critical"
        category = "financial_atm"
        author = "MalwareAnalyzer"

    strings:
        $atm1 = "WOSA/XFS" ascii wide
        $atm2 = "CEN/XFS" ascii wide
        $atm3 = "WFS_CMD_CDM_DISPENSE" ascii
        $atm4 = "WFS_CMD_CDM_PRESENT" ascii
        $atm5 = "msxfs.dll" ascii wide
        $vendor1 = "Diebold" ascii wide
        $vendor2 = "NCR" ascii wide
        $vendor3 = "Wincor" ascii wide
        $dispense = "Dispense" ascii wide nocase

    condition:
        (2 of ($atm*) and $dispense) or
        (1 of ($vendor*) and 2 of ($atm*))
}

rule Financial_ATM_Ploutus
{
    meta:
        description = "Detects Ploutus ATM malware family"
        severity = "critical"
        category = "financial_atm"
        author = "MalwareAnalyzer"

    strings:
        $ploutus1 = "Ploutus" ascii wide nocase
        $ploutus2 = "ploutos" ascii wide nocase
        $xfs1 = "MSXFS" ascii wide
        $xfs2 = "WFSExecute" ascii
        $xfs3 = "WFSOpen" ascii
        $disp1 = "ulCashBox" ascii
        $disp2 = "cCurrencyID" ascii
        // UNUSED: $keyboard = "SendInput" ascii

    condition:
        uint16(0) == 0x5A4D and
        (1 of ($ploutus*) and 1 of ($xfs*)) or
        (2 of ($xfs*) and 2 of ($disp*))
}

rule Financial_ATM_Tyupkin
{
    meta:
        description = "Detects Tyupkin ATM malware"
        severity = "critical"
        category = "financial_atm"
        author = "MalwareAnalyzer"

    strings:
        $tyup1 = "Tyupkin" ascii wide nocase
        $tyup2 = "ulUnitCount" ascii
        $tyup3 = "lpulValues" ascii
        $api1 = "WFSGetInfo" ascii
        $api2 = "WFSFreeResult" ascii
        $code1 = { 8B 45 ?? 83 C0 ?? 50 8D 45 ?? 50 }
        // UNUSED: $mutex = "Global\\" ascii

    condition:
        uint16(0) == 0x5A4D and
        (1 of ($tyup*) and 1 of ($api*)) or
        (2 of ($api*) and $code1)
}

rule Financial_Trading_Platform_Attack
{
    meta:
        description = "Detects attacks on trading platforms"
        severity = "critical"
        category = "financial_trading"
        author = "MalwareAnalyzer"

    strings:
        $trade1 = "trading" ascii wide nocase
        $trade2 = "bloomberg" ascii wide nocase
        $trade3 = "reuters" ascii wide nocase
        $trade4 = "FIX protocol" ascii wide nocase
        $order1 = "NewOrderSingle" ascii
        $order2 = "ExecutionReport" ascii
        $order3 = "OrderCancelRequest" ascii
        $manipulate1 = "inject" ascii nocase
        $manipulate2 = "spoof" ascii nocase
        $fix = "8=FIX" ascii

    condition:
        (2 of ($trade*) and 1 of ($order*)) or
        ($fix and 1 of ($manipulate*))
}

rule Financial_POS_Malware_Generic
{
    meta:
        description = "Detects generic POS malware targeting financial data"
        severity = "high"
        category = "financial_pos"
        author = "MalwareAnalyzer"

    strings:
        $track1 = /%B\d{13,19}\^[A-Z\s]+\^/ ascii
        $track2 = /;\d{13,19}=\d{4}/ ascii
        $ram1 = "ReadProcessMemory" ascii
        $ram2 = "VirtualQueryEx" ascii
        $ram3 = "OpenProcess" ascii
        $card1 = "track1" ascii nocase
        $card2 = "track2" ascii nocase
        $exfil = "POST" ascii

    condition:
        uint16(0) == 0x5A4D and
        (($track1 or $track2) and 1 of ($ram*)) or
        (2 of ($ram*) and 1 of ($card*) and $exfil)
}

rule Financial_Wire_Fraud_Trojan
{
    meta:
        description = "Detects trojans facilitating wire fraud"
        severity = "critical"
        category = "financial_fraud"
        author = "MalwareAnalyzer"

    strings:
        $wire1 = "wire transfer" ascii wide nocase
        $wire2 = "IBAN" ascii wide
        $wire3 = "routing number" ascii wide nocase
        $wire4 = "ABA" ascii wide
        $form1 = "beneficiary" ascii wide nocase
        $form2 = "account number" ascii wide nocase
        $form3 = "bank name" ascii wide nocase
        $hook1 = "SetWindowsHookEx" ascii
        $hook2 = "GetClipboardData" ascii
        $inject = "NtWriteVirtualMemory" ascii

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($wire*) and 1 of ($form*) and 1 of ($hook*)) or
        (3 of ($wire*) and $inject)
}

rule Financial_Carbanak_Variant
{
    meta:
        description = "Detects Carbanak/FIN7 financial malware"
        severity = "critical"
        category = "financial_apt"
        author = "MalwareAnalyzer"

    strings:
        $carb1 = "Carbanak" ascii wide nocase
        $carb2 = "Anunak" ascii wide nocase
        $backdoor1 = "taskmgr" ascii
        $backdoor2 = "svchost" ascii
        $vid1 = "avicap32.dll" ascii
        $vid2 = "capCreateCaptureWindow" ascii
        $key1 = "GetAsyncKeyState" ascii
        $key2 = "keylog" ascii nocase
        $c2 = { 68 74 74 70 3A 2F 2F }

    condition:
        uint16(0) == 0x5A4D and
        (1 of ($carb*) and 1 of ($vid*)) or
        (2 of ($backdoor*) and 1 of ($key*) and $c2)
}

rule Financial_Dridex_Banker
{
    meta:
        description = "Detects Dridex banking trojan variants"
        severity = "critical"
        category = "financial_trojan"
        author = "MalwareAnalyzer"

    strings:
        $dridex1 = "botnet" ascii nocase
        $dridex2 = "bot_id" ascii
        $config1 = "<config>" ascii
        $config2 = "<targets>" ascii
        $inject1 = "NtCreateUserProcess" ascii
        $inject2 = "NtQueueApcThread" ascii
        $net1 = "InternetOpenA" ascii
        $net2 = "HttpSendRequestA" ascii
        $crypt = { 8B ?? ?? 33 ?? 89 ?? ?? 8B }

    condition:
        uint16(0) == 0x5A4D and
        (1 of ($dridex*) and 1 of ($config*) and 1 of ($inject*)) or
        (2 of ($inject*) and 2 of ($net*) and $crypt)
}

rule Financial_TrickBot_Module
{
    meta:
        description = "Detects TrickBot banking module"
        severity = "critical"
        category = "financial_trojan"
        author = "MalwareAnalyzer"

    strings:
        $trick1 = "TrickLoader" ascii
        $trick2 = "moduleconfig" ascii
        $trick3 = "importDll" ascii
        $module1 = "injectDll" ascii
        $module2 = "systeminfo" ascii
        $module3 = "networkDll" ascii
        $target1 = "ibank" ascii
        $target2 = "banking" ascii nocase
        $persist = "ScheduledTasks" ascii

    condition:
        uint16(0) == 0x5A4D and
        (2 of ($trick*) and 1 of ($module*)) or
        (2 of ($module*) and 1 of ($target*) and $persist)
}

rule Financial_Emotet_Loader
{
    meta:
        description = "Detects Emotet loader for financial trojans"
        severity = "critical"
        category = "financial_loader"
        author = "MalwareAnalyzer"

    strings:
        $emotet1 = "powershell" ascii nocase
        $emotet2 = "wscript" ascii nocase
        $url1 = "http://" ascii
        $url2 = "https://" ascii
        $obf1 = "-enc" ascii nocase
        $obf2 = "FromBase64String" ascii
        $drop1 = "%APPDATA%" ascii
        $drop2 = "\\random" ascii
        $dll = "regsvr32" ascii

    condition:
        (1 of ($emotet*) and 1 of ($url*) and 1 of ($obf*)) or
        (2 of ($obf*) and 1 of ($drop*) and $dll)
}

rule Financial_Core_Banking_Attack
{
    meta:
        description = "Detects attacks on core banking systems"
        severity = "critical"
        category = "financial_attack"
        author = "MalwareAnalyzer"

    strings:
        $core1 = "core banking" ascii wide nocase
        $core2 = "Temenos" ascii wide
        $core3 = "Finacle" ascii wide
        $core4 = "Flexcube" ascii wide
        $db1 = "oracle" ascii nocase
        $db2 = "SYSDBA" ascii
        $db3 = "SYSTEM" ascii
        $sql1 = "UPDATE accounts" ascii nocase
        $sql2 = "INSERT INTO" ascii
        $sql3 = "transaction" ascii nocase

    condition:
        (1 of ($core*) and 1 of ($db*) and 1 of ($sql*)) or
        (2 of ($core*) and 2 of ($sql*))
}

rule Financial_Payment_Gateway_Attack
{
    meta:
        description = "Detects payment gateway attack malware"
        severity = "critical"
        category = "financial_payment"
        author = "MalwareAnalyzer"

    strings:
        $pay1 = "payment gateway" ascii wide nocase
        $pay2 = "merchant" ascii wide nocase
        $pay3 = "acquirer" ascii wide nocase
        $pay4 = "processor" ascii wide nocase
        $card1 = "PAN" ascii wide
        $card2 = "CVV" ascii wide nocase
        $card3 = "expiry" ascii wide nocase
        $intercept1 = "hook" ascii nocase
        $intercept2 = "intercept" ascii nocase
        // UNUSED: $ssl = "SSLRead" ascii

    condition:
        (2 of ($pay*) and 2 of ($card*)) or
        (1 of ($pay*) and 1 of ($card*) and 1 of ($intercept*))
}

rule Financial_Cryptocurrency_Exchange_Attack
{
    meta:
        description = "Detects cryptocurrency exchange targeting malware"
        severity = "critical"
        category = "financial_crypto"
        author = "MalwareAnalyzer"

    strings:
        $exchange1 = "Binance" ascii wide nocase
        $exchange2 = "Coinbase" ascii wide nocase
        $exchange3 = "Kraken" ascii wide nocase
        $exchange4 = "Bitfinex" ascii wide nocase
        $api1 = "api_key" ascii
        $api2 = "api_secret" ascii
        $api3 = "withdrawal" ascii nocase
        $wallet1 = "private_key" ascii
        $wallet2 = "wallet" ascii nocase
        $steal = "exfiltrate" ascii nocase

    condition:
        (2 of ($exchange*) and 1 of ($api*)) or
        (1 of ($exchange*) and 1 of ($wallet*) and $steal)
}

rule Financial_Investment_Fraud_Tool
{
    meta:
        description = "Detects investment fraud automation tools"
        severity = "medium"
        category = "financial_fraud"
        author = "MalwareAnalyzer"

    strings:
        $invest1 = "investment" ascii wide nocase
        $invest2 = "stock" ascii wide nocase
        $invest3 = "broker" ascii wide nocase
        $fraud1 = "pump" ascii wide nocase
        $fraud2 = "dump" ascii wide nocase
        $fraud3 = "insider" ascii wide nocase
        $auto1 = "automated" ascii nocase
        $auto2 = "bot" ascii nocase
        // UNUSED: $mass = "mass email" ascii nocase

    condition:
        (2 of ($invest*) and 1 of ($fraud*) and 1 of ($auto*)) or
        (1 of ($invest*) and 2 of ($fraud*))
}

rule Financial_ACH_Fraud_Malware
{
    meta:
        description = "Detects ACH/wire fraud malware"
        severity = "critical"
        category = "financial_fraud"
        author = "MalwareAnalyzer"

    strings:
        $ach1 = "ACH" ascii wide
        $ach2 = "Automated Clearing House" ascii wide nocase
        $ach3 = "NACHA" ascii wide
        $field1 = "routing" ascii wide nocase
        $field2 = "account" ascii wide nocase
        $field3 = "amount" ascii wide nocase
        $tamper1 = "modify" ascii nocase
        $tamper2 = "redirect" ascii nocase
        $batch = "batch" ascii nocase

    condition:
        (2 of ($ach*) and 2 of ($field*) and 1 of ($tamper*)) or
        ($ach1 and $batch and 1 of ($tamper*))
}

rule Financial_Card_Skimmer_Web
{
    meta:
        description = "Detects web-based card skimmer (Magecart style)"
        severity = "critical"
        category = "financial_skimmer"
        author = "MalwareAnalyzer"

    strings:
        $form1 = "checkout" ascii nocase
        $form2 = "payment" ascii nocase
        $form3 = "billing" ascii nocase
        $field1 = "cc-number" ascii
        $field2 = "card-number" ascii
        $field3 = "cardNumber" ascii
        $exfil1 = "navigator.sendBeacon" ascii
        $exfil2 = "new Image().src" ascii
        $exfil3 = "XMLHttpRequest" ascii
        $encode = "btoa" ascii

    condition:
        (2 of ($form*) and 1 of ($field*) and 1 of ($exfil*)) or
        (1 of ($field*) and 1 of ($exfil*) and $encode)
}

rule Financial_Insider_Trading_Tool
{
    meta:
        description = "Detects insider trading automation tools"
        severity = "medium"
        category = "financial_fraud"
        author = "MalwareAnalyzer"

    strings:
        $trade1 = "trade" ascii wide nocase
        $trade2 = "order" ascii wide nocase
        $trade3 = "execute" ascii wide nocase
        $insider1 = "material non-public" ascii wide nocase
        $insider2 = "earnings" ascii wide nocase
        $insider3 = "merger" ascii wide nocase
        $api1 = "brokerage" ascii nocase
        $api2 = "API" ascii
        $auto = "scheduled" ascii nocase

    condition:
        (2 of ($trade*) and 1 of ($insider*) and ($api1 or $api2)) or
        (1 of ($trade*) and 2 of ($insider*) and $auto)
}

rule Financial_Mobile_Banking_Trojan
{
    meta:
        description = "Detects mobile banking trojans targeting financial apps"
        severity = "critical"
        category = "financial_mobile"
        author = "MalwareAnalyzer"

    strings:
        $pkg1 = "com.chase" ascii
        $pkg2 = "com.wellsfargo" ascii
        $pkg3 = "com.bankofamerica" ascii
        $pkg4 = "com.citi" ascii
        $overlay1 = "TYPE_APPLICATION_OVERLAY" ascii
        $overlay2 = "WindowManager" ascii
        $sms1 = "android.provider.Telephony.SMS_RECEIVED" ascii
        $sms2 = "getMessageBody" ascii
        $perm = "BIND_ACCESSIBILITY_SERVICE" ascii

    condition:
        (2 of ($pkg*) and 1 of ($overlay*)) or
        (1 of ($pkg*) and 1 of ($sms*) and $perm)
}
